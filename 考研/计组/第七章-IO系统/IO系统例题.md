## 例题【IO 时间占 CPU 时间占比】

### #中断控制 #DMA控制

> 2009 真题

![](./images/Pasted%20image%2020241026200516.png)

> [!  ]  CPU 与外设 I/O 时间占比计算方法
> 时间 = 时钟周期数 $\times$ 时钟周期 = 频率 $\times$ 时钟周期

#### 中断方式

- CPI（每条指令的时钟周期）= 5
- 中断服务程序包含 18 条指令，其他开销相当于 2 条指令的执行时间
- 外设数据传输速率 = 0.5 MB/s
- 传输单位大小 = 4B（32bit）

> 通过频率计算 $\frac{传输单位数据 CPU 用于中断的时钟周期数}{CPU 主频}$

- 传输一个单位（4B）所需的时钟周期数：$5 \times 18 + 5 \times 2 = 100$
- 外设每秒的中断次数：$\frac{0.5 \, \text{MB}}{4 \, \text{B}} = 125000$
- CPU 用于中断的总时钟周期数：$125000 \times 100 = 12.5 \, \text{M 时钟周期}$
- CPU 主频为 500MHz，占比计算为：$\frac{12.5 \, \text{M}}{500 \, \text{M}} = 2.5\%$

> 通过时间计算 $\frac{传输单位数据CPU用于中断服务的时间}{传输单位数据所需要的时间}$

- CPU 主频为 500MHz，时钟周期 =$\frac{1}{500 \, \text{MHz}} = 2 \, \text{ns}$
- CPI = 5，即一条指令执行时间为 $2 \, \text{ns} \times 5 = 10 \, \text{ns}$
- 中断服务包含 18 条指令，其他开销相当于 2 条指令的执行时间

- 传输一个单位（4B）中断服务所需时间：$(18 + 2) \times 10 \, \text{ns} = 200 \, \text{ns}$
- 外设传输一个单位数据的 I/O 时间：$\frac{4 \, \text{B}}{0.5 \, \text{MB/s}} = 8 \, \mu \text{s}$
- CPU 用于该外设 I/O 的时间占整个 CPU 时间的百分比：$\frac{200 \, \text{ns}}{8 \, \mu \text{s}} = 2.5\%$

#### DMA 方式

> 通过频率计算 $\frac{传输单位数据 CPU 用于DMA的时钟周期数}{CPU 主频}$

- 外设数据传输速率提升至 5MB/s
- 每次 DMA 传送块大小为 5000B
- CPU 每次 DMA 预处理和后处理的总开销为 500 个时钟周期

- 计算每秒需要的 DMA 次数：$\text{DMA 次数} = \frac{5 \, \text{MB}}{5000 \, \text{B}} = 1000$
- 计算 CPU 用于 DMA 的总时钟周期数：$1000 \times 500 = 500000 = 0.5 \, \text{M 时钟周期}$
- CPU 主频为 500MHz，占比计算为：$\frac{0.5 \, \text{M}}{500 \, \text{M}} = 0.1\%$

> 通过时间计算 $\frac{传输单位数据CPU用于DMA的时间}{传输单位数据所需要的时间}$

- 每次 DMA 传送块大小为 5000B
- 外设数据传输速率为 5MB/s
- CPU 主频为 500MHz，时钟周期 =$\frac{1}{500 \, \text{MHz}} = 2 \, \text{ns}$
- 每次 DMA 预处理和后处理的开销为 500 个时钟周期

- 计算每次 DMA 传送的 CPU 时间：$500 \times 2 \, \text{ns} = 1 \, \mu \text{s}$
- 计算每次 DMA 传送的 I/O 时间：$\frac{5000 \, \text{B}}{5 \, \text{MB/s}} = 1 \, \text{ms}$

- CPU 用于该外设 I/O 的时间占整个 CPU 时间的百分比：$\frac{1 \, \mu \text{s}}{1 \, \text{ms}} = 0.1\%$

---

假设某计算机通过中断方式进行软盘的数据输入输出。每次中断请求传输一个 32 位数据，已知软盘的数据传输率为 500kB/s。每次传输的 CPU 开销（包括中断响应和处理）为 1000 个时钟周期，CPU 的主频为 500MHz。要求计算在软盘持续工作时，CPU 用于软盘数据传送的时间占 CPU 总时间的百分比是多少。

> 软盘准备 32 位数据的时间

- 每次传输的数据为 32 位（即 4 字节）。
- 软盘的数据传输率为 500kB/s。

计算软盘准备数据的时间：$\text{准备时间} = \frac{4 \, \text{字节}}{500 \times 10^3 \, \text{字节/秒}} = 8 \, \mu s$

因此，软盘每隔 8 微秒会发起一次中断请求。

> CPU 处理中断的时间

- CPU 主频为 500MHz，计算 CPU 时钟周期为：$\text{时钟周期} = \frac{1}{500 \times 10^6} = 2 \, \text{ns}$

- 每次处理中断的时间为 1000 个时钟周期，计算 CPU 处理中断请求的总时间：$\text{处理中断时间} = 1000 \times 2 \, \text{ns} = 2 \, \mu s$

> 计算 CPU 时间占比

每次传输数据的总周期为 8 微秒，其中 2 微秒用于 CPU 处理中断。
CPU 在软盘数据传输过程中所占时间百分比为：$\frac{IO时间}{CPU时间} = \frac{2 \, \mu s}{8 \, \mu s} = 0.25 = 25\%$

### #程序控制

> 2011 年真题
![](./images/Pasted%20image%2020241027185854.png)

- **查询次数**：每秒需对设备 A 查询至少 200 次
- **每次查询时钟周期数**：500 个时钟周期
- **CPU 主频**：50 MHz

> 时间计算法

- **每次查询时间**：
  - 每次查询所需时钟周期数为 500。
  - CPU 主频是 50 MHz，因此每个时钟周期耗时 $\frac{1}{50 \text{ MHz}} = 20 \text{ ns}$。
  - 每次查询耗时 $500 \times 20 \text{ ns} = 10000 \text{ ns} = 10 \text{ μs}$。

- **每秒查询总时间**：
  - 每秒查询次数为 200 次，因此每秒用于查询的总时间为：

    $$
    200 \times 10 \text{ μs} = 2000 \text{ μs} = 2 \text{ ms}
    $$

- **CPU 时间百分比**：
  - 每秒总时间为 $1 \text{ s} = 1000 \text{ ms}$。
  - CPU 用于设备 A 查询的时间占比为：

    $$
    \frac{2 \text{ ms}}{1000 \text{ ms}} = 0.2\%
    $$

> 频率计算法

- **每秒所需时钟周期数**：
  - 每次查询 500 个时钟周期，每秒查询 200 次，因此每秒需要的时钟周期数为：

    $$
    200 \times 500 = 100000 \text{ 个时钟周期}
    $$

  - CPU 主频为 50 MHz，即每秒共 5000 万个时钟周期。

- **CPU 时间百分比**：
  - CPU 用于设备 A 查询的时钟周期占比为：

    $$
    \frac{100000}{50000000} = 0.2\%
    $$

### #中断控制

> 2014 年真题
![](./images/Pasted%20image%2020241027193723.png)

- **每 400 ns 发出一次中断请求**：表示设备的中断请求周期为 400 ns。
- **中断响应和处理时间为 100 ns**：每次 CPU 处理该设备中断所需时间总共为 100 ns。
- **中断响应允许的最长延迟时间 50 ns**：表示 CPU 必须在 50 ns 内响应请求，防止请求得不到及时处理。

- **计算 CPU 用于设备 I/O 时间占比**：$$ \text{I/O 占比} = \frac{\text{处理时间}}{\text{中断周期}} = \frac{100 \, \text{ns}}{400 \, \text{ns}} = 25\% $$

---

- **中断请求**：设备向 CPU 发送中断请求信号（周期为 400 ns）。
- **中断响应**：CPU 响应中断请求，进入中断服务程序，最大延迟时间为 50 ns。
- **中断处理**：CPU 执行中断服务程序的处理逻辑，处理时间和响应时间总共为 100 ns。
- **中断结束**：CPU 结束中断服务，恢复到原程序继续执行。

### #中断控制

> 2016 真题

![](./images/Pasted%20image%2020241026202000.png)

- **每传送一个 ASCII 字符所需的位数**：
  - 起始位：1 位
  - 数据位：7 位（ASCII 字符）
  - 奇校验位：1 位
  - 停止位：1 位
  - **总位数**：1 + 7 + 1 + 1 = 10 位

- **I/O 端口的最大接收速率**：
  - 从设备 D 接收启动命令到字符送入 I/O 端口的时间为 0.5ms。

  - 每秒最多接收的字符数：$\text{字符数} = \frac{1 \, \text{s}}{0.5 \, \text{ms}} = 2000 \, \text{字符}$

- **每个字符传输所需的时间**：
  - CPU 主频：50MHz，CPU 时钟周期为 $\frac{1}{50 \, \text{MHz}} = 20 \, \text{ns}$

  - 设备 D 将字符送至 I/O 端口的时间为 0.5ms：$\frac{0.5 \, \text{ms}}{20 \, \text{ns}} = 25000 \, \text{时钟周期}$

  - 中断响应时间：10 个时钟周期

  - 中断服务程序前 15 条指令的执行时间（CPI=4）：$15 \times 4 = 60 \, \text{时钟周期}$

  - **每个字符的总传输时间**：$25000 + 10 + 60 = 25070 \, \text{时钟周期}$

  - **传输 1000 个字符的总时间**：$1000 \times 25070 = 25070000 \, \text{时钟周期}$

- **CPU 用于一次中断的时间**：
  - 中断响应时间：10 个时钟周期

  - 中断服务程序的执行时间（20 条指令，CPI=4）：$20 \times 4 = 80 \, \text{时钟周期}$

  - **CPU 用于读取 1000 个字符的总时间**：$1000 \times (10 + 80) = 90000 = 9 \times 10^4 \, \text{时钟周期}$

> 参考答案一

在中断响应阶段，CPU 主要执行以下操作：

1. **确定中断源**：向中断源查询电路发出中断响应信号 (INTA)，以读取当前最高优先级的中断源编码。
2. **关中断**：将中断允许触发器 (IE) 清 0，暂时不再响应任何中断请求。
3. **保护程序断点**：将中断时的指令地址（程序计数器 PC 的内容）推入堆栈，以便在中断服务完毕后，返回到中断点继续执行被中断的程序。
4. **转至中断服务程序入口**：根据中断源编码，跳转到相应的中断服务程序入口。

> 参考答案二

在中断响应阶段，CPU 的主要操作如下：

1. **关中断**：CPU 响应某个中断源的请求，为避免新的中断请求干扰，必须自动关中断。
2. **保护程序断点**：保存当前程序计数器 (PC) 的内容，以便中断服务完毕后返回中断点继续执行。
3. **引出中断服务程序**：取出中断服务程序的入口地址（中断向量）并传送给程序计数器 (PC)。

### #程序控制 #中断控制 #DMA控制

> 2018 真题

![](./images/Pasted%20image%2020241026202651.png)
![](./images/Pasted%20image%2020241026202859.png)

设备 A 的数据传输率是 **2MBps**，32 位数据缓冲寄存器的大小相当于 **4 字节**（32 位 = 4 字节）。因此，为避免数据丢失，需要在设备 A 的缓冲寄存器满之前进行查询。

- 设备 A 准备 32 位数据所需时间为：$\text{查询间隔时间} = \frac{4 \text{ 字节}}{2 \text{ MBps}} = 2 \text{ μs}$

因此，设备 A 每隔 **2μs** 至少查询一次，以防止数据丢失。

> 通过时间计算

- CPU 每次查询执行 **10 条指令**，主频 **500MHz**，CPI 为 **4**，则每条指令执行时间为：$2 \text{ ns} \times 4 = 8 \text{ ns}$

- 每次输入/输出需要 CPU 时间为：$8 \text{ ns} \times 10 = 80 \text{ ns}$

- 设备 A 每隔 **2μs** 查询一次，所以 CPU 用于设备 A I/O 的时间占 CPU 总时间的百分比为：$\frac{80 \text{ ns}}{2 \text{ μs}} = 4\%$

> 通过频率计算

- 每次输入/输出需要 **40 个时钟周期**（每次查询执行 10 条指令，每条指令 CPI 为 4），查询频率为：$\frac{1}{2 μs} = 0.5 \text{ MHz}$

- CPU 每秒用于设备 A 的时钟周期数为：$40 \times 0.5 \text{ M} = 20 \text{ M}$

- CPU 总的时钟周期数为 **500M**，所以 CPU 用于设备 A 的时间占比为：$\frac{20 \text{ M}}{500 \text{ M}} = 4\%$

---

> 通过时间计算

- 每次中断响应和处理中断需要 **400 个时钟周期**，CPU 时钟周期为 **2 ns**，所以中断处理总时间为：$400 \times 2 \text{ ns} = 800 \text{ ns}$

- 设备 B 的数据传输率为 **40MBps**，准备 32 位数据所需时间为：$\frac{4 \text{ B}}{40 \text{ MBps}} = 100 \text{ ns}$

由于 **100 ns < 800 ns**，即设备 B 准备数据的时间小于中断处理时间，因此使用中断方式会导致数据丢失，不适合采用中断 I/O 方式。

> 通过频率计算

- 中断处理频率上限为：$\frac{500 \text{ MHz}}{400} = 1.25 \text{ MHz}$

- 设备 B 的数据传输率对应的查询频率为：$\frac{40 \text{ MBps}}{4 \text{ B}} = 10 \text{ MHz}$

由于 **10 MHz > 1.25 MHz**，所以设备 B 的数据到达速度远高于 CPU 能响应中断的频率，因而不适合采用中断 I/O 方式。

> 通过时间计算

- 每次 DMA 传输前后处理需要 **500 个时钟周期**，对应的时间为：$500 \times 2 \text{ ns} = 1 \text{ μs}$

- 设备 B 每次 DMA 传送的数据块为 **1000 B**，传输率为 **40 MBps**，则每次 DMA 传送的时间为：$\frac{1000 \text{ B}}{40 \text{ MBps}} = 25 \text{ μs}$

- 因此，CPU 用于设备 B 输入/输出的时间占 CPU 总时间的百分比为：$\frac{1 \text{ μs}}{25 \text{ μs}} = 4\%$

> 通过频率计算

- 每秒最多 DMA 次数为：$\frac{40 \text{ MB}}{1000 \text{ B}} = 0.04 \text{ M}$

- CPU 每秒用于 DMA 预处理和后处理的时钟周期数为：$0.04 \text{ M} \times 500 = 20 \text{ M}$

- CPU 总的时钟周期数为 **500M**，因此 CPU 用于设备 B 输入/输出的时间占比为：$\frac{20 \text{ M}}{500 \text{ M}} = 4\%$

### #中断控制

> 2019

![](./images/Pasted%20image%2020241027194416.png)

**题目数据：**

- CPU 主频：1 GHz
- 数据缓冲寄存器：32 位（即 4 字节）
- 设备数据传输率：50 KB/s
- 每次中断开销：1000 个时钟周期

> 通过时间计算

- CPU 主频为 1 GHz，所以 CPU 时钟周期 = $\frac{1}{1 \, \text{GHz}} = 1 \, \text{ns}$

- 数据缓冲寄存器为 32 位 = 4 字节（B），即一次中断传输 4B 数据。

- 设备的数据传输率为 50 KB/s，即每秒需要传输 $50 \, \text{KB} \div 4 \, \text{B} = 12.5 \, \text{K}$ 次中断。

- 每次中断开销为 1000 个时钟周期 = $1000 \times 1 \, \text{ns} = 1 \, \mu \text{s}$

- 每秒需要的中断时间 = $12.5 \, \text{K} \times 1 \, \mu \text{s} = 12.5 \, \text{ms}$

- CPU 每秒运行时间 = 1 秒
- 所以，CPU 用于该设备 I/O 的时间占整个 CPU 时间的百分比 = $\frac{12.5 \, \text{ms}}{1 \, \text{s}} = 1.25\%$

> 通过频率计算

- 一次中断可以传输 4B 数据。

- 设备的数据传输率为 50 KB/s，每秒需要的中断次数 = $\frac{50 \, \text{KB}}{4 \, \text{B}} = 12.5 \, \text{K}$ 次。

- 每次中断开销为 1000 个时钟周期
- 每秒中断所需的总时钟周期数 = $12.5 \, \text{K} \times 1000 = 12.5 \, \text{M}$

- CPU 主频为 1 GHz，即每秒的时钟周期数为 1G。

- CPU 用于该设备 I/O 的时间占整个 CPU 时间的百分比 = $\frac{12.5 \, \text{M}}{1 \, \text{G}} = 1.25\%$

### #DMA控制 #磁盘

![](./images/Pasted%20image%2020241026175552.png)

- 第一个总线周期取指令第二个总线周期取数据，两个都要访存。
- 磁盘 16 $\times$ 512B 用时 8.192ms ➡️ 1MB 用时 1s 平均速率 1MBps
- 总线位宽 8 位 = 1B，每次总线传输 1 字节数据需要 **250ns** 的总线周期。

- $1\ \text{MB/s} \times 250\ \text{ns/字节} = 250\ \text{ms}$

- 由于 DMA 的传输速率需求为 **1MB/s**

- 为传输 1MB 数据所需的总线时间 $1\ \text{MB/s} \times 250\ \text{ns/字节} = 250\ \text{ms}$

- 总线一秒内有 **1000ms** 的总时间。在 DMA 传输期间，总线被占用了 **250ms** 的时间，因此带宽占用比率为：$\frac{250\ \text{ms}}{1000\ \text{ms}} = 25\%$

- 磁盘 16 $\times$ 512B 用时 8.192ms ➡️ 1MB 用时 1s 平均速率 1MBps
- 总线位宽为 16 传输 1B 需要 125ns 的总线周期

- 同理 带宽占用比率为：$\frac{125\ \text{ms}}{1000\ \text{ms}} = 12.5\%$

![](./images/Pasted%20image%2020241026175614.png)

### #程序控制

![](./images/Pasted%20image%2020241027180526.png)

### #程序控制  #中断控制 #DMA控制

![](./images/Pasted%20image%2020241026175649.png)
![](./images/Pasted%20image%2020241026175742.png)
![](./images/Pasted%20image%2020241026175804.png)
![](./images/Pasted%20image%2020241026175839.png)

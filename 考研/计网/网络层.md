## 网络层的概述

网络层的传输单元 <font color="#ff0000">数据报</font>

- **服务特点**：
 ![](./images/Pasted%20image%2020240918180902.png)
  - 网络层向上只提供**简单灵活的、无连接的、尽最大努力交付的数据报服务**
  - 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）
  - 网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限

- **路由器设计**：
  - 由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）
  - 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的传输层负责可靠交付（包括差错处理、流量控制等）

> **注意**：网络层不提供服务质量的承诺
> 即向上层提供**无连接、不可靠的 IP 数据报服务**

## 网络层的功能

### 1. 路由选择与分组转发 【最佳路径】

- **路由**是指选择路径的过程，即从源节点到目标节点之间**选择最优路径**的过程

- **转发**是指数据包沿着选定的路径进行传输的过程

- 路由器根据特定的*路由选择协议*构造出*路由表*，并经常和相邻路由表交换路由信息而不断更新和维护路由表
- 生成路由表后，从路由表得出转发表。路由器根据转发表将用户的 IP 数据报从合适的端口转发出去

- 在讨论路由选择的原理时，往往不去区分转发表和路由表，而是笼统地使用路由表一词

#### SDN 基本概念

软件定义网络（SDN）是一种创新的网络架构，通过集中式的控制平面和分布式的数据平面实现网络管理和控制的分离
![](./images/Pasted%20image%2020241020221638.png)
![](./images/Pasted%20image%2020241020221417.png)

> 路由器之间传送的信息有两大类：

- **控制平面**：
  - 采用集中式的控制器，负责管理和控制网络设备
  - 控制器通过南向接口（如 OpenFlow 协议）与数据平面的设备通信，下发流表规则来指导数据包的转发和处理，同时监控和管理网络状态

- **数据平面**：
  - 由分布式的网络设备（如交换机、路由器）组成，负责实际的数据包转发和处理
  - 数据平面设备根据控制平面下发的规则（流表）执行数据包的转发操作，实现网络数据的传输和处理功能

> 传统⽹络中的路由器既有数据平⾯⼜有控制平⾯

#### SDN 控制器

![](./images/Pasted%20image%2020241020221312.png)

- SDN 控制器是整个 SDN 网络的核心，类似于网络的 " 大脑 "，负责集中管理和控制网络设备

- 通过**南向接口**（如 OpenFlow）与网络设备通信
  - **南向接口**：用于控制器与数据平面设备之间的通信
    - Openflow 是最常用的南向接口协议，定义了控制器如何下发流表规则、获取设备状态等操作
    - 通过南向接口，SDN 控制器能兼容不同的硬件设备

- 通过**北向接口**与应用程序通信
  - **北向接口**：用于控制器与应用程序之间的通信，提供了一组 API，使得开发者可以通过编程方式控制网络行为。例如，通过北向接口，开发者可以编写应用来实现负载均衡、流量工程、安全策略等功能
- SDN 控制器集群内部控制器之间的通信接口称为 **东西向接口**

##### SDN 的优点

- **全局集中式控制和分布式高速转发**
- **灵活性和可编程性**：允许网络管理员通过编程方式**动态**调整网络配置和行为，使得网络能够迅速响应业务需求变化，提高网络的灵活性
- **降低成本**
- **网络可视化与监控**：提供了更好的网络可视化和监控能力，管理员可以实时了解网络状态，快速发现和解决问题
可视化与监控：SDN 提供了更好的网络可视化和监控能力，管理员可以实时了解网络状态，快速发现和解决问题

##### SDN 的缺点

- **安全风险**：集中管理易受攻击，如果崩溃，整个网络受到影响
- **瓶颈问题**：随着网络规模扩大，控制器可能成为网络性能的瓶颈

#### OpenFlow

OpenFlow 是 SDN（软件定义网络）中控制层与数据层之间的通信协议，它通过控制器与交换机之间的接口控制网络流量的转发行为。

![](./images/Pasted%20image%2020241020221815.png)

在 SDN 中，完成 " 匹配 + 动作 " 的设备被称为 OpenFlow 交换机。与传统路由器不同，OpenFlow 交换机使用 **流表（Flow Table）** 取代了传统的路由表。每个流表包含多个流表项，流表项由匹配字段和动作组成。

![](./images/Pasted%20image%2020241020221907.png)
在 OpenFlow 交换机中，既可以处理数据链路层的帧，也可以处理网际层的 IP 数据报，还可以处理运输层的 TCP 或 UDP 报文。
首部字段值字段包含有一组字段，用来使入分组（Incoming Packet）的对应首部与之匹配，因此又称为匹配字段。匹配不上的分组就被丢弃，或被发送到 SDN 远程控制器做更多的处理。
![](./images/Pasted%20image%2020241020222034.png)
![](./images/Pasted%20image%2020241020222047.png)

- **匹配字段**：用于识别网络中的数据流，包括源 IP 地址、目的 IP 地址、源端口号、目的端口号等。
- **动作（Action）**：当数据包匹配到流表项时，交换机根据动作字段来处理该数据包，如转发到特定端口、丢弃数据包、修改报文头等。

##### OpenFlow 交换机工作流程

1. **匹配**：交换机接收到数据包后，首先通过流表中的匹配字段查找是否有对应的流规则。
2. **执行动作**：如果找到匹配项，执行相应的动作，如转发或丢弃。
3. **请求控制器**：如果没有匹配到流规则，交换机会向 SDN 控制器发送请求，控制器根据当前的网络状态下发新的流表项。

##### OpenFlow 的优点

- **集中控制**：SDN 控制器可以集中管理整个网络中的流量，使得网络配置和管理变得更加简单和高效。
- **灵活性与可编程性**：通过编程，网络管理员可以动态调整网络行为，快速响应业务需求。
- **全局视图**：控制器拥有全局网络视图，可以实现更优的流量调度和网络资源分配。

##### 应用

![](./images/Pasted%20image%2020241020222120.png)
![](./images/Pasted%20image%2020241020222126.png)
![](./images/Pasted%20image%2020241020222133.png)

### 2. 异构网络互联

- **异构网络**：指采用不同硬件技术、传输介质、网络协议和网络拓扑的网络

- **异构网络互联**：指将多个计算机网络，通过一定的方法，用通信处理设备（即中间设备、中继系统）相互连接起来，构成更大的网络系统

#### 中继系统

- **物理层中继系统**：中继器，集线器（Hub）
- **数据链路层中继系统**：网桥或交换机
- **网络层中继系统**：路由器
- **网络层以上的中继系统**：网关
  - 用网关连接两个不兼容的系统需要在高层进行协议的转换

#### 网络互联

![](./images/Pasted%20image%2020240907180506.png)
网络互联指用路由器进行网络互联和路由选择，路由器是一台专用计算机，用于在互联网中进行路由选择

> **注意**：物理层或数据链路层的中继系统，把一个网络扩大了，但从网络层的角度看，它仍然是同一个网络，不称之为网络互联

> [! ] 把网络层的路由器称为网关

#### TCP/IP 体系

![](./images/Pasted%20image%2020241020215714.png)
TCP/IP 体系采用 **网际协议（IP）** 实现异构网络互连，将互连后的计算机网络看成一个虚拟互联网
使用 IP 协议的虚拟互联网称为 **IP 网络**
在 IP 网络中，虽然物理网络的异构性是存在的，但是通过 IP 就可以在网络层上让它们看起来是一个统一的网络

### 3. 拥塞控制【全局性】

- **拥塞**：在通信子网中，因出现过量的分组而引起网络性能下降的现象

![拥塞控制示意图](./images/Pasted%20image%2020240907180510.png)

- 当路由器速率接近带宽 R 时，平均时延急剧增加，大量的分组被丢弃（路由缓冲有限），整个网络的吞吐量会骤降

#### 判断网络是否进入拥塞状态的方法

- **轻度拥塞状态**：随着网络负载的增加，网络的吞吐量也增加，但明显小于正常的吞吐量
- **拥塞状态**：吞吐量随着网络负载的增大而下降
- **死锁状态**：网络负载继续增大，而网络的吞吐量下降到零

#### 目标

- 防止网络进入拥塞状态
- 当网络进入拥塞时，迅速恢复到正常状态

#### 作用

- 确保子网能够承载所达到的流量，这是一个全局性的过程（涉及主机、路由器及路由器内部的转发处理过程等），单一地增加资源并不能解决拥塞

#### 拥塞控制方法

##### 开环控制【预防】

- **定义**：开环控制是一种**预防性**的网络拥塞控制方法。它不依赖于系统的实时状态，而是在系统运行前事先做出设计，考虑各种潜在的拥塞因素，确保在系统运行时尽量避免拥塞

- **特点**：
  - **静态方法**：一旦系统启动，就不再进行实时调整，不依赖于运行过程中网络状态的反馈信息
  - **预先配置**：通过事先设置的规则，系统能够决定**何时接收新流量**，**何时丢弃分组**，以及**使用什么样的调度策略**
  - **优势**：不需要复杂的实时检测和反馈，控制简单
  - **缺点**：因为没有依赖系统的状态，灵活性差，难以应对动态变化的网络负载或突发拥塞

##### 闭环控制 【检测与调整】

- **定义**：闭环控制是一种**响应性**的网络拥塞控制方法。它依赖于实时监测网络的运行状态，及时检测拥塞的发生，并动态调整系统的行为以解决问题

- **特点**：
  - **动态方法**：系统通过**检测**当前网络的状态，**反馈**信息到控制器，然后根据反馈进行调整，确保系统继续有效地运行
  - **反馈机制**：当发现拥塞时，会向源节点或网络节点发送反馈信号，告知其拥塞情况，从而采取行动，如减慢传输速率或丢弃部分数据包
  - **优势**：更灵活，可以根据实际的网络负载情况进行动态调整，适应性强
  - **缺点**：需要设计监测机制和反馈机制，系统设计较为复杂，增加了网络开销

#### 流量控制和拥塞控制的区别

- **流量控制（通信双方）**：用于控制发送端发送数据的速率，以确保接收端有能力处理这些数据，从而避免接收端发生溢出
- **拥塞控制（整个网络）**：用于防止网络内部的路由器或交换机因数据过载而发生拥塞，从而导致网络性能下降，是全局性问题

## 子网划分、路由聚集、子网掩码与 CIDR

分类的 IP 地址的弱点：

1. IP 地址空间的利用率有时很低
2. 两级 IP 地址不够灵活

### 子网划分

将一个大型网络分割成多个较小的子网的过程，其在 IP 地址中又增加了一个子网号字段，使两级 IP 地址变成了三级 IP 地址

![](./images/Pasted%20image%2020240907185523.png)

- 子网号不能全 0 或全 1，以避免与整个网络的广播地址冲突
- 主机号不能全 0 或全 1，全 0 为子网网络号，全 1 为子网广播地址

#### 子网划分的基本思路

1. 子网划分纯属一个单位内部的事情，单位对外仍然表现为没有划分子网的网络
2. 从主机号借用若干比特作为子网号，三级 IP 地址的结构如下：

      $$\text{IP 地址：} \{ \langle \text{网络号} \rangle, \langle \text{子网号} \rangle, \langle \text{主机号} \rangle \}$$

3. 其他网络根据 IP 数据报的目的网络号，先发送给连接到本单位网络上的路由器
4. 该路由器收到 IP 数据报后，按目的网络号和子网号找到目的子网，把 IP 数据报直接交付给目的主机

> **注意：**

1. 划分子网不改变 IP 地址原来的网络号，因此从一个 IP 地址本身或 IP 数据报的首部，**其网络看不出是否进行了子网划分**
2. RFC 950 规定，对分类的 IPv 4 地址进行子网划分时，子网号不能为全 1 或全 0；这是因为无法分清 192.168.1.255 是子网的广播还是本网络的广播，所以去掉子网号全 1 全 0 的情况；
3. 无类别域间路由 CIDR 消除了 A/B/C 类型网络，就可以使用全 1 和全 0，但要注意路由器是否支持 CIDR
4. 不论是分类的 IPv 4 地址还是 CIDR，其子网中的主机号为全 0 或全 1 的地址都不能被指派。**子网中主机号全 0 的地址为子网的网络号，主机号全 1 的地址为子网的广播地址。**

#### 二叉树子网划分

> **定长子网划分**
![](images/定长子网划分和变长子网划分的二叉树解法%20-%201.定长子网划分和变长子网划分的二叉树解法(Av817692587,P1).mp4_000541.354.jpg)
> 变长子网划分

![](images/定长子网划分和变长子网划分的二叉树解法%20-%201.定长子网划分和变长子网划分的二叉树解法(Av817692587,P1).mp4_000724.838.jpg)

##### 判定变长子网划分完成的方法

1. **将已分配的结点涂红**：

    - 首先，标记所有已经分配了子网的节点，将它们涂红
2. **从叶节点开始检查**：

    - 逐一检查每个叶节点，向上查找（包括当前节点本身）
3. **检查路径上是否有红色节点**：

    - **若路径上有红色节点**：说明该子网已分配，继续检查下一个叶节点
    - **若路径上没有红色节点并且到达根节点**：说明此路径的子网尚未分配，表示子网划分不完整，需要重新划分
4. **最后一个叶节点检查通过**：

    - 如果最后一个叶节点也检查通过，且所有路径上都有红色节点，说明子网划分已经完成

![](images/定长子网划分和变长子网划分的二叉树解法%20-%201.定长子网划分和变长子网划分的二叉树解法(Av817692587,P1).mp4_001514.740.jpg)

### 子网掩码

![子网掩码示意图](./images/Pasted%20image%2020240907185503.png)

- **定义**：子网掩码是一个 32 位的二进制数，用于将 IP 地址分为网络部分和主机部分。它由一串连续的 1 和一串连续的 0 组成，连续的 1 对应 IP 地址的网络号及子网，0 对应主机号
- **作用**：通过子网掩码，可以找出 IP 地址中的子网部分，从而判断源主机或目的主机所连接的网络是否进行了子网划分

#### 子网掩码的表示方法

- **点分十进制表示法**：如 255.255.255.0
- **前缀长度表示法**：如 /24

#### 因特网标准规定

- **所有的网络都必须使用子网掩码**
  - 如果一个网络未划分子网，则采用默认子网掩码：
    - A 类地址的默认子网掩码：255.0.0.0
    - B 类地址的默认子网掩码：255.255.0.0
    - C 类地址的默认子网掩码：255.255.255.0

#### 使用子网掩码的注意事项

- **主机设置**：一台主机在设置 IP 地址信息的同时，必须设置子网掩码
- **一致性**：同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码
- **路由器配置**：路由器的路由表中，所包含信息的主要内容必须有目的网络地址、子网掩码、下一跳地址

### 无分类域间路由选择 CIDR

![](./images/Pasted%20image%2020241020215955.png)

- CIDR 把 32 位 IP 地址划分前后两个部分，前面部分使用各种长度的 " 网络前缀 " 用来指明网络，后面部分则用来指明主机。IP 地址从三级编址（使用子网掩码）又回到了两级编址

    $$\text{IP 地址：} \{ \langle \text{网络前缀} \rangle, \langle \text{主机号} \rangle \}$$

#### CIDR 工作原理

![](./images/Pasted%20image%2020241020220032.png)

![](./images/Pasted%20image%2020241020220059.png)

- CIDR 使用 " 斜线记法 "【CIDR 记法】，即在 IP 地址后面加上一个斜线 "/"，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如：220.78.168.0/24

- **CIDR 虽然不使用子网了，但仍然使用 " 掩码 " 这一名词（但不叫子网掩码）。**

#### CIDR 地址块

- CIDR 地址块由网络前缀相同的所有连续 IP 地址组成
- 通过任意一个地址可以确定地址块的起始地址、最大地址和地址数
- 可指派的地址需减去主机号全 0 和全 1 的地址：
  - 全 0 表示网络号
  - 全 1 表示广播

#### 最长前缀匹配

- 查找路由表时，选择网络前缀最长的匹配项
- 网络前缀越长，地址块越小，路由越具体（more specific）

### CIDR 与路由表

- 使用 CIDR 时，路由表中的每个项目由网络前缀和下一跳地址组成
- 若**在查找路由表时得到不止一个匹配结果，就选择网络前缀最长的那一个**

因为网络前缀越长，其地址块就越小，因而路由就越具体（more specific）。最长前缀匹配又称为最长匹配或最佳匹配

#### CIDR 查找路由表的方法

- 使用层次式数据结构（如二叉线索）存放无分类编址的路由表，自上而下按层次查找
- 构造二叉线索的规则：
  1. 从根节点开始，深度最多 32 层，每层对应 IP 地址中的一位
  2. 检查 IP 地址左边的第一位：
     - 为 0，则节点在根节点左下方
     - 为 1，则在右下方
  3. 依次检查地址的每一位，构造相应层的节点，直到唯一前缀的最后一位

- 二叉线索的深度一般不到 32 层
- 每个叶节点代表一个唯一前缀，节点之间的连线表示前缀中的比特

#### 路由聚集（构造超网）

> [! ] 核心：找共同前缀

![](./images/Pasted%20image%2020240918192558.png)

- **一个 CIDR 地址块可以表示很多地址**，这种地址的聚合常称为**路由聚合**（或构成超网），它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由
- 路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能

#### 例题

![](./images/Pasted%20image%2020241020220206.png)
![](./images/Pasted%20image%2020241020220157.png)

#### IPv 4 地址的应用规划

![](./images/Pasted%20image%2020241020220342.png)

##### 定长子网掩码 FLSM

![](./images/Pasted%20image%2020241020220427.png)

##### 变长子网掩码 VLSM

![](./images/Pasted%20image%2020241020220516.png)

## ARP 协议、DHCP 协议与 ICMP 协议

### IP 地址与 MAC 地址

#### MAC 地址

- 每个网卡或三层网口都有一个 MAC 地址，MAC 地址是烧录到硬件上的，因此也称为硬件地址
- MAC 地址作为数据链路设备的地址标识符，需要保证网络中的每个 MAC 地址都是唯一的，才能正确识别到数据链路上的设备
- MAC 地址由 6 个字节组成：
 ![](./images/Pasted%20image%2020240907185614.png)
  - 前 3 个字节表示厂商识别码，每个网卡厂商都有特定唯一的识别数字
  - 后 3 个字节由厂商分配，确保生产的网卡不会有相同 MAC 地址的网卡
  - 现在可以通过软件修改 MAC 地址，虚拟机使用物理机网卡的 MAC 地址，但只要相同 MAC 地址的设备不在同一个数据链路上就没问题

> **MAC 地址表示**

- 为了查看方便，6 个字节的 MAC 地址使用十六进制表示，每个字节的 8 位二进制数分别用 2 个十六进制数表示。例如，网卡 MAC 地址是 E 0-06-E 6-39-86-31
- IP 数据报在数据链路层被封装成 MAC 帧
- IP 地址放在 IP 数据报的首部，硬件地址放在 MAC 帧的首部
- 网络层及以上使用 IP 地址，数据链路层及以下使用硬件地址
- IP 数据报在数据链路层中成为 MAC 帧的数据，数据链路层看不见 IP 地址

![](./images/Pasted%20image%2020240918181253.png)

![](./images/Pasted%20image%2020240907185544.png)

#### 通信路径示例

![](images/Pasted%20image%2020241008201749.png)
![](./images/Pasted%20image%2020241020220620.png)

![](./images/Pasted%20image%2020240918181446.png)

#### IP 层与 MAC 层的区别

- **MAC 地址**：数据链路层使用的地址，是平面式的
- **IP 层**：IP（Internet Protocol）层是网络层，用于在不同的网络间传输数据包
  - 网络层传输的单元是 IP 数据报。无论 IP 数据报经过多少路由器转发，数据报头中的源地址和目的地址保持不变
  - 网络层使用的地址，具有分层次等级
- **MAC 层**：MAC（Media Access Control）层属于数据链路层，负责在局域网中传输数据
  - 在这一层，IP 数据报被封装到 MAC 帧中传输。每次数据传输时，MAC 帧的源地址和目的地址都会根据所在网络的情况发生变化
  - H 1 到 R 1：MAC 帧首部从 HA 1 到 HA 3
  - R 1 到 R 2：MAC 帧首部从 HA 4 到 HA 5
  - R 2 到 H 2：MAC 帧首部从 HA 6 到 HA 2
  - MAC 帧首部的变化在 IP 层上是不可见的

> [! ] IP 层屏蔽了下层硬件地址体系的复杂细节，使得在网络层上可以使用统一的 IP 地址进行通信研究
>
> - IP 地址用于网络层及以上，硬件地址用于数据链路层及以下
> - IP 数据报在数据链路层被封装成 MAC 帧，MAC 帧首部的源地址和目的地址会在不同网络上传送时发生变化
> - IP 层屏蔽了下层硬件地址的复杂细节，使得通信研究更加统一和抽象

#### 网络分层和地址解析

> **二层网络与 MAC 地址**

在二层网络中，使用 MAC 地址进行传输。*MAC 地址作为数据链路层的设备标识符*
![](./images/Pasted%20image%2020240907185552.png)

> **三层网络与 IP 地址**

在三层网络中，使用 IP 地址进行传输。*IP 地址作为网络层的设备标识符*
![](./images/Pasted%20image%2020240907185555.png)

> **域名解析与 DNS**

容易记忆的域名通过 DNS 解析成 IP 地址，有了 IP 地址就可以在网络上找到目的地

![](./images/Pasted%20image%2020240907185559.png)

> **IP 地址与 ARP**

> 从 IP 地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程
IP 地址通过 ARP 协议获得 MAC 地址，有了 MAC 地址才能在物理网络上传输数据
![](./images/Pasted%20image%2020240907185604.png)

### ARP 协议【IP 地址 ➡️ MAC 地址】

![](./images/Pasted%20image%2020240918181631.png)

- **地址解析协议** (Address Resolution Protocol, ARP) 是一种**网络层协议**
  - 用于将同一局域网下的 IP 地址解析为物理地址（MAC 地址），*不能跨网使用*
  - **RARP 协议**：将 MAC 地址转换为 IP 地址

> [! ]  ARP 在主机的 ARP 高速缓存中存放一个从 IP 地址到 MAC 地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）
> 因为两者的对应关系不是一成不变的，例如，主机更换了一张新网卡

#### ARP 工作步骤

##### 1. 查看 ARP 表

- **步骤**：主机 A 首先查看自己的 ARP 表（即 ARP 缓存表），确定是否有主机 B 的 IP 地址对应表项
- **处理**：如果有，则直接使用表项中的 MAC 地址进行封装，封装成帧后发送给主机 B

![查看 ARP 表](./images/Pasted%20image%2020240907185620.png)

##### 2. 发送 ARP 请求

- **步骤**：如果没有找到，主机 A 会发送一个 ARP 请求广播到局域网
- **ARP 请求帧**：目标 MAC 地址字段为 `FF-FF-FF-FF-FF-FF`，这就是 ARP 请求报文

![发送 ARP 请求](./images/Pasted%20image%2020240907185624.png)

##### 3. 处理 ARP 请求

- **步骤**：同一个网段的所有主机都能收到 ARP 请求报文
- **主机 B**：发现报文中的目的 IP 地址是自己，于是发送 ARP 响应报文给主机 A。源 MAC 地址和源 IP 地址是主机 B，目的 MAC 地址和目的 IP 地址是主机 A
- **ARP 响应报文**：主机 B 的 ARP 表记录主机 A 的映射关系，即主机 A 的 IP 地址和 MAC 地址的对应关系

![处理 ARP 请求](./images/Pasted%20image%2020240907185631.png)

- **主机 C**：也收到了 ARP 请求报文，但目的 IP 地址不是自己，所以不会进行响应。主机 C 添加主机 A 的映射关系到 ARP 表，并丢弃 ARP 请求报文

![主机 C 处理 ARP 请求](./images/Pasted%20image%2020240907185637.png)

##### 4. 处理 ARP 响应

- **步骤**：主机 A 收到 ARP 响应报文后，添加主机 B 的映射关系
- **处理**：用主机 B 的 MAC 地址作为目的地址封装成帧，并发送给主机 B

![处理 ARP 响应](./images/Pasted%20image%2020240907185641.png)

#### 使用 ARP 的四种典型情况

![ARP 使用情况](./images/Pasted%20image%2020240918181659.png)

##### 1. 主机 H 1 发送 IP 数据报给本网络的主机 H 2

- **目的**：用 ARP 找到目的主机的硬件地址
- **过程**：主机 H 1 通过 ARP 请求获取主机 H 2 的 MAC 地址，然后将 IP 数据报封装成 MAC 帧发送给 H 2

##### 2. 主机 H 1 发送 IP 数据报给另一个网络的主机 H 3 或 H 4

- **目的**：用 ARP 获取网关路由器的硬件地址，剩下的工作由该路由器来完成
- **过程**：主机 H 1 通过 ARP 请求获取网关路由器的 MAC 地址，然后将 IP 数据报封装成 MAC 帧发送给网关路由器。网关路由器再根据目的 IP 地址进行下一步转发

##### 3. 路由器 R 1 发送 IP 数据报给本网络的主机 H 3

- **目的**：用 ARP 找到目的主机的硬件地址
- **过程**：路由器 R 1 通过 ARP 请求获取主机 H 3 的 MAC 地址，然后将 IP 数据报封装成 MAC 帧发送给 H 3

##### 4. 路由器 R 1 发送 IP 数据报给另一个网络的主机 H 4

- **目的**：用 ARP 获取下一跳路由器的硬件地址，剩下的工作由该路由器完成
- **过程**：路由器 R 1 通过 ARP 请求获取下一跳路由器的 MAC 地址，然后将 IP 数据报封装成 MAC 帧发送给下一跳路由器。下一跳路由器再根据目的 IP 地址进行下一步转发

### IP 数据报的转发

![](./images/Pasted%20image%2020241020222517.png)

#### <font color="#e36c09">主机</font>发送 IP 数据报

- **目标主机在同一网络**：

  - **查找 ARP 表**：主机检查自己的 ARP 表，寻找目标主机 IP 地址对应的 MAC 地址
  - **ARP 请求**：如果未找到对应项，主机发送 ARP 请求广播到局域网，询问目标主机的 MAC 地址
  - **接收 ARP 响应**：目标主机收到请求后，发送 ARP 响应给源主机，提供其 MAC 地址
  - **更新 ARP 表**：源主机更新其 ARP 表，添加目标主机的 IP-MAC 映射
  - **发送数据报**：源主机使用目标主机的 MAC 地址封装 IP 数据报，并通过数据链路层发送
- **目标主机在不同网络**：

  - **查找网关地址**：主机检查自己的 ARP 表，寻找默认网关的 IP 地址对应的 MAC 地址
  - **ARP 请求**：如果未找到对应项，主机发送 ARP 请求广播，询问网关的 MAC 地址
  - **接收 ARP 响应**：网关收到请求后，发送 ARP 响应，提供其 MAC 地址
  - **更新 ARP 表**：主机更新其 ARP 表，添加网关的 IP-MAC 映射
  - **发送数据报**：主机使用网关的 MAC 地址封装 IP 数据报，并发送给网关
  - **网关处理**：网关接收 IP 数据报后，根据路由表转发数据报

#### <font color="#e 36 c 09">路由器</font>转发 IP 数据报

- **接收数据报**：

  - 路由器从输入端口接收一个 IP 数据报，并检查其目的 IP 地址
- **查找路由表**：

  - **查找匹配**：路由器在其路由表中查找与目的 IP 地址匹配的路由条目
  - **决定下一跳**：根据匹配的路由条目，决定将数据报转发到哪个下一跳路由器或最终目标网络
- **下一跳在同一网络**：

  - **查找 ARP 表**：路由器检查其 ARP 表，寻找下一跳 IP 地址对应的 MAC 地址
  - **ARP 请求**：如果未找到对应项，路由器发送 ARP 请求广播，询问下一跳设备的 MAC 地址
  - **接收 ARP 响应**：下一跳设备收到请求后，发送 ARP 响应，提供其 MAC 地址
  - **更新 ARP 表**：路由器更新其 ARP 表，添加下一跳设备的 IP-MAC 映射
  - **转发数据报**：路由器使用下一跳设备的 MAC 地址封装 IP 数据报，并通过相应接口发送
- **下一跳在不同网络**：

  - **查找网关地址**：路由器在其 ARP 表中查找下一跳路由器的 IP 地址对应的 MAC 地址
  - **ARP 请求**：如果未找到对应项，路由器发送 ARP 请求广播，询问下一跳路由器的 MAC 地址
  - **接收 ARP 响应**：下一跳路由器收到请求后，发送 ARP 响应，提供其 MAC 地址
  - **更新 ARP 表**：路由器更新其 ARP 表，添加下一跳路由器的 IP-MAC 映射
  - **转发数据报**：路由器使用下一跳路由器的 MAC 地址封装 IP 数据报，并发送给下一跳路由器
  - **下一跳路由器处理**：下一跳路由器接收 IP 数据报后，根据其路由表继续转发数据报
![](./images/Pasted%20image%2020241022121854.png)

### DHCP 协议

- **应用层协议**，基于 UDP，DHCP 客户端使用的 UDP 端口号为 68，DHCP 服务器使用的 UDP 端口号是 67
- **即插即用联网机制**：允许一台计算机加入新的网络和获取 IP 地址而不需人工参与

#### DHCP 的工作原理

![](./images/Pasted%20image%2020240907185649.png)
![](./images/Pasted%20image%2020240907185651.png)
![](./images/Pasted%20image%2020240907185655.png)

- **DHCP 发现（Discover）**：

  - 客户端启动时，通过广播发送 DHCP 发现报文，目的 IP 地址为 `255.255.255.255`，源 IP 地址为 `0.0.0.0`
  - 所有广播域内的主机都能收到此广播报文，但只有 DHCP 服务器会响应
- **DHCP 提供（Offer）**：

  - DHCP 服务器收到发现报文后，查找其数据库中的配置信息。如果找到，则返回该信息；如果找不到，则从其 IP 地址池中分配一个地址
  - 服务器发送 DHCP 提供报文，源地址为 DHCP 服务器地址，目的地址为 `255.255.255.255`
- **DHCP 请求（Request）**：

  - 客户端收到 DHCP 提供报文后，如果接受该 IP 地址，则广播发送 DHCP 请求报文，源地址为 `0.0.0.0`，目的地址为 `255.255.255.255`，请求服务器提供的 IP 地址
- **DHCP 确认（Ack）**：

  - DHCP 服务器收到请求报文后，广播发送 DHCP 确认报文，源地址为 DHCP 服务器地址，目的地址为 `255.255.255.255`
  - 客户端进入已绑定状态，主机的 MAC 地址与 DHCP 服务器分配的 IP 地址绑定
- **租用期管理**：

  - 分配的 IP 地址有时限，即租用期。客户端在收到确认报文后，根据 DHCP 服务器提供的租用期 TTT 设置两个计时器 T1=0.5TT_1 = 0.5TT1​=0.5T 和 T2=0.875TT_2 = 0.875TT2​=0.875T
  - 当 T1T_1T1​ 时间到时，客户端发送请求报文请求更新租用期
    - 服务器同意则发回确认报文，客户端得到新的租用期并重新设置计时器
    - 服务器不同意则发回否认报文，客户端必须停止使用原来的 IP 地址并重新申请
    - 如果服务器不响应请求报文，当 T2T_2T2​ 时间到时，客户端重新发送请求报文，重复上述步骤
- **租用期终止**：

  - 客户端可以随时终止租用期，发送释放报文即可

#### DHCP 协议工作过程

![](./images/Pasted%20image%2020241020220757.png)
![](./images/Pasted%20image%2020240907185711.png)

1. **DHCP 服务器被动打开 UDP 端口 67**，等待客户端发来的报文
2. **DHCP 客户从 UDP 端口 68 广播发送 DHCP 发现报文（DHCP DISCOVER）**
    - 凡收到 DHCP 发现报文的 DHCP 服务器，会在自己维护的一个 IP 池里拿出一个空闲 IP，通过单播的形式发出 DHCP 提供报文（DHCP OFFER），因此 DHCP 客户可能收到多个 DHCP 提供报文
3. **DHCP 客户从几个 DHCP 服务器中选择其中的一个**，并向所选择的 DHCP 服务器发送 DHCP 请求报文（DHCP REQUEST）
4. **被选择的 DHCP 服务器发送确认报文（DHCP ACK）**，进入已绑定状态，并可开始使用得到的临时 IP 地址
5. **DHCP 客户根据服务器提供的租用期 T 设置两个计时器 T 1 和 T 2**，它们的超时时间分别是 0.5 T 和 0.875 T。当超时时间到就要请求更新租用期
    - 租用期过了一半（T 1 时间到），DHCP 发送请求报文（DHCP REQUEST），要求更新租用期
    - DHCP 服务器若同意，则发回确认报文（DHCP ACK）。DHCP 客户得到了新的租用期，重新设置计时器
    - DHCP 服务器若不同意，则发回否认报文（DHCP NACK）。这时 DHCP 客户必须立即停止使用原来的 IP 地址，而必须重新申请 IP 地址（回到步骤 2）
    - 若 DHCP 服务器不响应步骤 6 的请求报文（DHCP REQUEST），则在租用期过了 87.5% 时，DHCP 客户必须重新发送请求报文（DHCP REQUEST）（重复步骤 6），然后又继续后面的步骤
6. **DHCP 客户可随时提前终止服务器所提供的租用期**，这时只需向 DHCP 服务器发送释放报文（DHCP RELEASE）即可

> 自动获得 IP 地址和自动获得 DNS 服务器地址就表示是使用 DHCP 协议

- 网络上有多台 DHCP 服务器时，DHCP 客户端发出的 DHCP 请求可能收到多个应答消息，DHCP 客户端挑选最先到达的

#### DHCP 中继代理

在网络中并非每个子网都有 DHCP 服务器，这样会使得 DHCP 服务器过多。
为了减少 DHCP 服务器的数量，可以在每个子网配置一个 DHCP 中继代理，该中继代理具有 DHCP 服务器的 IP 信息

> DHCP 中继代理以单播方式转发发现报文

![](./images/Pasted%20image%2020240907185720.png)

- 主机通过广播发送发现报文给 DHCP 中继代理
- DHCP 中继代理收到发现报文后，以单播形式将报文转发给 DHCP 服务器
- DHCP 服务器响应 DHCP 中继代理，提供 IP 地址
- DHCP 中继代理将服务器的响应报文单播返回给主机

### ICMP 协议

 **网络层协议** (Internet Control Message Protocol, ICMP) 是一种网络层协议，主要用于在主机和路由器之间传递控制消息，报告网络连接问题和诊断网络故障。
 ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送

#### 功能

- 确认 IP 包是否成功送达目标地址
- 报告发送过程中 IP 包被废弃的原因
- 改善网络设置

#### ICMP 包头格式

> ICMP 报文是封装在 IP 包里面，它⼯作在网络层，因而不保证可靠的提交

![](./images/Pasted%20image%2020240907185729.png)

> ICMP 包头的类型字段，大致可以分为两大类：

- **查询报文类型**：用于诊断的查询消息
- **差错报文类型**：通知出错原因的错误消息

#### ICMP 差错报告报文

> **ICMP 差错报告报文**：用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况

- **终点不可达**：当路由器或主机不能交付数据报时，向源点发送终点不可达报文
  ![](./images/Pasted%20image%2020241020225643.png)
- **源点抑制**（最新的 ICMP 标准已经不再使用）：当路由器或主机由于拥塞而丢弃数据报时，向源点发送源点抑制报文，使源点把发送速率放慢
  ![](./images/Pasted%20image%2020241020225652.png)
  ![](./images/Pasted%20image%2020241020225710.png)
- **时间超过**：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，丢弃已收到的数据报片
  ![](./images/Pasted%20image%2020241020225722.png)
  ![](./images/Pasted%20image%2020241020225729.png)
- **参数问题**：路由器或目的主机收到的数据报的首部中有的字段的值不正确时，丢弃该数据报，向源点发送参数问题报文
  ![](./images/Pasted%20image%2020241020225739.png)
- **改变路由**：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的（更好的）路由器
  ![](./images/Pasted%20image%2020241020225809.png)

#### 不应发送 ICMP 差错报告报文的几种情况

- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
- 对具有组播地址的数据报都不发送 ICMP 差错报告报文
- 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文

#### ICMP 询问报文

- **回送请求或回送回答**：ICMP 回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态
  - **常见应用**：ping（测试主机之间的连通性，工作在应用层，但直接使用网络层的 ICMP，不使用 TCP 或 UDP）
- **时间戳请求或时间戳回答**：在 ICMP 时间戳请求报文发出后，就能够收到对方响应的 ICMP 时间戳回答报文。利用在报文中记录的时间戳（如报文的发送时间和接收时间），发送方很容易计算出当前网络的往返时延
- **掩码地址请求和回答报文、路由器询问和通告报文**（都已经不再使用）

#### 小结

![](./images/Pasted%20image%2020240907185750.png)

## IPv4

**IPv4（Internet Protocol version 4）** 是互联网协议第四版，广泛应用于互联网上的数据传输
它定义了数据报文的格式、寻址方案、分片和传输过程

### IPv4 分组格式

**IPv4 数据报**包含首部和数据部分。
首部包含重要的控制信息，用于正确传输和处理数据报。
首部由 20 字节（B）的固定部分和长度可变的可选字段组成

### IPv4 首部

![](./images/Pasted%20image%2020240907180524.png)

- **版本**：4 位，表示 IP 协议的版本号（IPv4 为 4）
- **首部长度**：4 位，表示 IP 数据报头部的长度，*以 4 字节 (B) 为单位*
  - *最小取值*：0101 即十进制的 5 表示 IP 数据报首部只有 20 B 的固定部分
  - *最大取值*：1111 即十进制的 15，表示最大 IP 数据报首部有 20 B 的固定部分和 40 B 最大可变部分
- **区分服务**：8 位，包含服务类型字段（旧称 TOS），用于区分不同服务的优先级
- **总长度**：16 位，表示整个数据报的总长度（头部 + 数据），*以字节为单位*
  - 总长度位数限制，数据报的最大长度为 $2^{16}−1 = 65535B$
  - 以太网帧的最大传送单元（MTU）为 $1500 B$，数据报总长度不能超过数据链路层的 MTU 值
- **标识**：16 位，标识数据报的唯一 ID，用于数据报分片和重组
- **标志**：3 位，控制数据报分片：
  - **DF (<font color="#e36c09">dont</font> fragment)**：禁止分片位
    - DF = 0 允许分片
    - DF = 1 禁止分片
  - **MF（<font color="#e36c09">more</font> fragment）**：更多分片位
    - MF = 1 有后续分片
    - MF = 0 没有后续分片
- **片偏移**：13 位，表示分片相对于原始数据报起始位置的偏移量，*以 8 字节（B）为单位【必须能整除】*
  - 除最后一个分片外，每个分片的长度一定是 8B 的整数倍
- **生存时间（TTL）**：8 位，表示数据报可以经过的最大路由器数量，防止数据报无限循环
  - *路由器在转发分组前，先把 TTL 减 1，若 TTL 被减为 0，则该分组必须丢弃*
- **协议**：表示封装在数据报中的上层协议，如 `TCP（6）`、`UDP（17）> 8`

    ![IPv4 数据报](images/Pasted%20image%2020240907180539.png)
- **首部校验和**：16 位，检验首部数据的完整性。只校验分组的首部，而不校验数据部分
- **源 IP 地址**：32 位，表示数据报的发送方 IP 地址
- **目的 IP 地址**：32 位，表示数据报的接收方 IP 地址
- **可选项**：可变长度，用于扩展功能

### IP v4 数据报首部长度字段和总长度字段

![](./images/Pasted%20image%2020241020222757.png)

### IP 数据报分片

- **最大传送单元 MTU**：一个数据链路层数据报能承载的最大数据量
  - 标准以太网的 MTU 为 $1500B$，许多广域网的 MTU 不超过 $576B$
- **分片**：IP 的数据报最终会封装成帧，数据报大于 MTU 时就要分成多份
  - 为了让接收方可以把拆开的数据报合起来，让它们每个都带个 IP 头，形成的小 IP 数据报叫做片
  - 创建一个 IP 数据报时，源主机为该数据报加上一个标识号
  - 当一个路由器或主机需要将一个数据报分片时，形成的每个数据报都具有原始数据报的标识号
  - 目的主机收到来自同一发送主机的一批数据报时，检查数据报的标识号来确定属于同一个原始数据报的片
  - 目的主机在对片进行重组时，使用**片偏移字段**来确定片应放在原始 IP 数据报的哪个位置

  ![](./images/Pasted%20image%2020240907180552.png)
  - 改 IPv4 数据报分片长度不超过 1420 B
  - **片偏移**：13 位，表示分片相对于原始数据报起始位置的偏移量，*以 8 字节（B）为单位*
    - 除最后一个分片外，<font color="#e36c09">每个分片的长度一定是 8 B 的整数倍</font>

|            |   总长度   |  标识   | MF  | DF  |    片偏移     |
| :--------: | :-----: | :---: | :-: | :-: | :--------: |
| 原 IPv4 数据报 | 20+3800 | 23333 |  0  |  0  |     0      |
|    分片 1    | 20+1400 | 23333 |  1  |  0  |     0      |
|    分片 2    | 20+1400 | 23333 |  1  |  0  | 1400/8=175 |
|    分片 3    | 20+1000 | 23333 |  0  |  0  | 2800/8=350 |

#### IP 数据报分片过程中需要修改的首部字段

- **总长度**：表示分片后的每个 IP 数据报的总长度
- **标志**（注意区别标志和标识，标识不变，标志位会改变）：
  - **MF 位**：
    - 对于所有非最后一个片段，MF 位设置为 1，表示后续还有更多片段；
    - 对于最后一个片段，MF 位设置为 0
  - **DF 位**：通常不修改，除非在分片时必须强制设置为 0 以允许分片
- **片偏移**：表示当前片段在原始 IP 数据报中的位置
- **首部校验和**：每个分片后的 IP 数据报都需要重新计算首部校验和

![](./images/Pasted%20image%2020240918194146.png)
![](./images/Pasted%20image%2020240918194150.png)

### IP 分组首部校验和计算

![](./images/Pasted%20image%2020240907180611.png)

- **发送方**：
    1. 将 IP 数据报的首部划分为 16 位字（即两个字节）的序列
    2. 将检验和字段置为零
    3. 使用二进制反码求和规则，对所有 16 位字进行相加
    4. 将得到的和的反码写入检验和字段

- **接收方**：
    1. 接收到数据报后，再次对首部的所有 16 位字进行二进制反码求和
    2. 得到的和取反码，即得出接收方检验和的计算结果
    3. 若首部未发生任何变化，则此结果必为 0，于是就保留这个数据报
    4. 否则即认为出差错，并将此数据报丢弃

> **二进制反码求和的规则**：

- 从低位到高位逐列进行计算
- 0 和 0 相加是 0，0 和 1 相加是 1，1 和 1 相加是 0 但要产生一个进位 1，加到下一列
- 若最高位相加后产生进位，则最后得到的结果要加 1

### IPv4 地址与 NAT

#### IPv4 地址

- **定义**：IPv4 地址是用来标识互联网设备的**逻辑地址**，用来表示**主机或路由器的接口**
- **格式**：它是一个 **32 位**的**二进制数**，通常表示为**点分十进制格式**（如 192.168.0.1）
- **结构**：一个 IPv4 地址可以分为网络部分和主机部分
  - **网络部分**：标识特定的网络
  - **主机部分**：标识网络中的特定设备（主机）
  - **唯一性**：
    - 网络号在因特网范围内是唯一的（即一个网络号只能表示一个网络）
    - 主机号在网络号指明的情况下也必须是唯一的
      - 一个 IP 地址在整个因特网范围内是唯一的

**同一网段**：不需要由路由器进行转发
**不同网段**：交由路由器进行转发

> 早期采用的分类的 IP 地址

$$\text{IP 地址：} \{ \langle \text{网络号} \rangle, \langle \text{主机号} \rangle \}$$

![](./images/Pasted%20image%2020240907180621.png)

> 特殊的 IP 地址【一般不指派的的 IP 地址】：

|  网络号   | 主机号  | 用作源地址 | 用作目的地址 |               用途               |
| :----: | :--: | :---: | :----: | :----------------------------: |
|  全为 0  | 全为 0 |  可以   |  不可以   | 默认路由出，表示整个实网</br>表示木网路 1 上的本主机 |
|  全为 1  | 全为 1 |  不可以  |   可以   |    本网络的 " 广播地址 "</br>路由器不转发    |
| 普通网络号  | 全为 0 |  不可以  |  不可以   |             表示某个网络             |
| 普通网络号  | 全为 1 |  不可以  |   可以   | 表示某网路的 " 广播地址 "</br>对特定网络进行广播  |
|  127   | 特定值  |  不可以  |   可以   |              环回地址              |
| D 类网络号 | 特定值  |  不可以  |   可以   |              用于组播              |
| E 类网络号 | 特定值  |  不可以  |  不可以   |              保留地址              |

![](./images/Pasted%20image%2020240918193128.png)

- **网络地址**：主机号全 0，用于**标识整个网络**
  - 例如，192.168.0.0 表示 192.168.0.0/24 网络
- **广播地址**：主机号全 1，用于**向网络中的所有主机发送数据**
  - 例如，192.168.0.255 是 192.168.0.0/24 网络的广播地址
- **受限广播地址**：32 位全为 1，即 255.255.255.255，**表示整个 TCP/IP 网络的广播地址**
  - **只能做目的地址**
  - 实际使用时，由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址
- **本网络上的本主机**：32 位全为 0，即 0.0.0.0
- **环回地址**：127.x.x.x 保留为**环回自检 (Loopback Test) 地址**，用于主机内部通信
  - 127.0.0.1 是最常用的环回地址，通常用于测试和调试
  - *目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。*

- 如果是网络号全为 0，主机号为确定值，则是一个特殊地址形式，被限制在本网内部，指向本网内特定的主机

##### IP 地址特点

1. 每个 IP 地址都由网络号和主机号两部分组成，是一种**分等级的地址结构**
     - **IP 地址管理机构只分配网络号**，而主机号由该网络的单位自行分配，方便了 IP 地址的管理
     - 路由器**仅根据网络号来转发分组**，从而减小了路由表所占的存储空间
2. IP 地址是**标志一台主机或路由器和一条链路的接口**
3. 一台主机同时连接到两个网络时，该主机就必须**同时具有两个不同网络号的 IP 地址**，路由器也是一样
4. 用转发器或桥接器连接的若干 LAN 仍然是同一个网络，IP 地址的网络号必须相同，但主机号必须不同
5. 在 IP 地址中，**所有分配到网络号的网络都是平等的**
6. **同一个局域网上**的主机或路由器的 IP 地址中的**网络号必须一样**
7. 路由器的**每个端口都有一个不同网络号的 IP 地址**

#### 网络地址转换 (NAT)

- **定义**：网络地址转换 (NAT) 是指通过将专用网络地址转换为公用地址，从而对外隐藏内部管理的 IP 地址
- **目的**：
  - **解决 IPv4 地址枯竭问题**：
    - 划出部分 IP 地址为私有 IP 地址，**私有 IP 地址只用于 LAN**，并且**允许私有 IP 地址被不同的 LAN 重复使用**，有效解决 IP 地址不足的问题
    - 整个专用网只需要一个全球 IP 地址就可以与因特网连通
  - **提高网络安全性**：
    - 隐藏了内部网络结构，降低内部网络受到攻击的风险

##### 私有 (专用)IP 地址

| 地址</br>类别 |             地址范围              | 网段个数 |
| :-------: | :---------------------------: | :--: |
|    A 类    |   10.0.0.0 ~ 10.255.255.255   |  1   |
|    B 类    |  172.16.0.0 ~ 172.31.255.255  |  16  |
|    C 类    | 192.168.0.0 ~ 192.168.255.255 | 256  |

| 网络</br>类别 |   最大可用</br>网络数   | 最小可指派</br>网络号 | 最大可指派</br>网络号 | 每个网络中的</br>最大主机数 | 不能指派</br>网络号 | 地址空间</br>占比 |
| :-------: | :--------------: | :-----------: | :-----------: | :--------------: | :----------: | :---------: |
|    A 类    | $2^{(8-1)} - 2$  |       1       |      126      |   $2^{24} - 2$   |   0 和 127    |     50%     |
|    B 类    | $2^{(16-2)} - 1$ |     128.1     |    191.255    |   $2^{16} - 2$   |              |     25%     |
|    C 类    | $2^{(24-3)} - 1$ |    192.0.1    |  223.255.255  |    $2^8 - 2$     |              |    12.5%    |

- **A 类网络数减 2**：
  - 网络字段全为 0 的 IP 地址是保留地址
  - 网络字段号全为 1【127】的 IP 地址是环回自检地址

- **在因特网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发**
- 这种采用私有 IP 地址的互联网称为**专用互联网或本地互联网**，私有 IP 地址也称**可重用地址**

##### NAT 分类

- **静态 NAT（Static NAT）**：

  - **定义**：每个内部私有 IP 地址映射到一个唯一的外部公共 IP 地址
  - **用途**：适用于需要固定 IP 地址的服务，如服务器和远程访问设备
- **动态 NAT（Dynamic NAT）**：

  - **定义**：内部私有 IP 地址动态映射到一个外部公共 IP 地址池中的任意一个 IP 地址
  - **用途**：用于不需要固定外部 IP 地址的设备，提供一定的灵活性
- **源地址端口转换（NAPT，Network Address and Port Translation）**：

  - **定义**：将多个内部私有 IP 地址映射到一个外部公共 IP 地址，通过不同的端口号区分会话
  - **用途**：适用于需要大量设备共享少量公共 IP 地址的情况，是最常用的 NAT 类型

##### NAT 工作原理

使用 NAT 时需要在专用网连接到因特网的路由器上安装 NAT 软件，**NAT 路由器至少有一个有效的外部全球 IP 地址**

> NAT 的工作原理如下：

1. **地址转换**：

   - NAT 路由器使用 **NAT 转换表**，将专用网的本地 IP 地址转换为全球 IP 地址，或将全球 IP 地址转换成本地 IP 地址。
   - NAT 转换表包含 **{本地 IP 地址: 端口} 到 {全球 IP 地址: 端口}** 的映射，允许多个私有 IP 地址共享同一个全球 IP 地址。

2. **数据报转换**：

      - **发起通信：**
      - 专用网内主机 A（IP 地址：`192.168.0.3`）发送数据报给互联网主机 B（IP 地址：`213.18.2.4`）。
      - NAT 路由器将数据报的 **源 IP 地址** 从 `192.168.0.3` 转换为 **NAT 的全球 IP 地址** `172.38.1.5`，然后转发数据报。
      - **应答返回：**
      - 当主机 B 回复数据报时，它将目的 IP 地址设置为 NAT 的 IP 地址 `172.38.1.5`。
      - NAT 路由器接收到应答数据报后，通过 NAT 表将 **目的 IP 地址** 从 `172.38.1.5` 转换回 A 的本地 IP 地址 `192.168.0.3`。

3. **地址转换表**：

   - **方向字段**：
   - **" 出 "**：数据报从专用网离开，发送到互联网。
   - **" 入 "**：数据报从互联网进入专用网。
   - 例如，主机 `192.168.0.7` 也通过 NAT 路由器发送数据，并使用另一个全球 IP 地址 `172.38.1.6` 进行通信。

4. **两次地址转换**：
     - **离开专用网**：将 **源 IP 地址** 替换为 NAT 的全球 IP 地址。
     - **进入专用网**：将 **目的 IP 地址** 替换为专用网内部的本地 IP 地址。

5. **全球 IP 地址的利用**：

   - 如果 NAT 路由器有 **n 个全球 IP 地址**，则最多可以同时支持 **n 台主机** 访问互联网。
   - 这样，专用网内部的多台主机可轮流使用有限的全球 IP 地址来与互联网通信。

6. **通信发起**：【**专用网内主机必须发起通信**】

   - NAT 仅支持 **专用网内主机主动发起的通信**。
   - 互联网主机**无法直接请求专用网内主机的服务**，因此专用网内的主机无法作为服务器对外提供服务。

7. **NAPT（网络地址与端口转换）**：

- **NAPT 的原理**：将 NAT 转换表扩展为使用 **传输层端口号**，实现多个本地主机共用同一个全球 IP 地址与外界通信。
- **NAPT 的优势**：不同的本地主机可以共用 **一个全球 IP 地址**，通过不同的端口号区分通信。
- **传统 NAT**：只进行 IP 地址转换，不使用端口号。

> 注意

| 路由器类型   | 转发 IP 数据报时是否更换 IP 地址 | 是否涉及传输层           |
| ------------ | -------------------------------- | ------------------------ |
| 普通路由器   | 否                               | 否                       |
| NAT 路由器   | 是                               | 是【需要查看和转换传输层的端口号】|

- **NAT 主要解决专用网与公网 IP 地址不足的问题**，并通过地址转换让私有 IP 地址访问互联网。
- **NAPT 是 NAT 的增强形式**，提高了全球 IP 地址的利用率。

## IPv6

### 解决 IP 地址耗尽问题的措施

1. 采用无类别编址 CIDR，使 IP 地址的分配更加合理
2. 采用网络地址转换 NAT 方法以节省全球 IP 地址
3. 采用具有更大地址空间的新版本的 IPv6，从根本上解决了 IP 地址的耗尽问题

### 主要特点

- **更大的地址空间**：IPv6 将地址从 IPv4 的 32 位增大到了 128 位
- **扩展的地址层次结构**
- **灵活的首部格式**，减少了首部条目，首部固定，扩展首部在数据部分
- **改进的选项**
- **允许协议继续扩充**
- **支持即插即用**（即自动配置，不需要 DHCP）
- **支持资源的预分配**
- **IPv6 只在包的源节点才能分片**，是端到端的，所以从一般意义上说，IPv6 不允许分片
- **IPv6 首部长度必须是 8B 的整数倍**，而 IPv4 首部是 4B 的整数倍
- **增大了安全性**，身份验证和保密功能是 IPv6 的关键特征（支持质量服务 QoS）

### IPv6 数据报

IPv6 数据报由两大部分组成，即基本首部和后面的有效载荷（也称为净负荷）。有效载荷允许有零个或多个扩展首部，再后面是数据部分。注意，所有的扩展首部并不属于 IPv6 数据报的基本首部。IPv6 仍支持无连接的传送，但将协议数据单元 PDU 称为分组

所引进的主要变化如下：

- 灵活的首部格式：IPv6 定义了许多可选的扩展首部
- **改进的选项**：IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中
- 支持即插即用（即自动配置）：因此 IPv6 不需要使用 DHCP
- **支持资源的预分配**：IPv6 支持实时视像等要求，保证一定的带宽和时延的应用
- IPv6 首部改为 8 字节对齐：首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐

![](./images/Pasted%20image%2020240907185757.png)

### IPv6 首部

![](./images/Pasted%20image%2020240907185800.png)

- **版本**：占 4 位。指明协议的版本，对 IPv6 该字段是 6
- **通信量类**：占 8 位。这是为了区分不同的 IPv6 数据报的类别或优先级
- **流标号**：占 20 位。IPv6 的一个新机制是支持资源预分配，并且允许路由器把每一个数据报与一个给定的资源分配相联系。IPv6 提出流的抽象概念。" 流 " 就是互联网网络上从特定源点到特定终点 (单播或组播) 的一系列数据报 (如实时音频或视频传输)，而在这个 " 流 " 所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。因此，流标号对实时音频/视频数据的传送特别有用。对于传统的电子邮件或非实时数据，流标号则没有用处，把它置为 0 即可
- **有效载荷长度**：占 16 位。指明 IPv6 数据报除基本首部以外的字节数 (所有扩展首部都算在有效载荷之内)。这个字段的最大值是 64KB(65535 字节)
- **下一个首部**：占 8 位。它相当于 IPv4 的协议字段或可选字段
  - 当 IPv6 数据报没有扩展首部时，下一个首部字段的作用和 IPv4 的协议字段一样，它的值指出了基本首部后面的数据应交付 IP 层上面的哪一个高层协议 (例如：6 或 17 分别表示应交付传输层 TCP 或 UDP)
  - 当出现扩展首部时，下一个首部字段的值就标识后面第一个扩展首部的类型
- **跳数限制**：占 8 位。用来防止数据报在网络中无限期地存在。和 IPv4 的 TTL 字段相似。源点在每个数据报发出时即设定某个跳数限制 (最大为 255 跳)。每个路由器在转发数据报时，要先把跳数限制字段中的值减 1。当跳数限制的值为零时，就要把这个数据报丢弃
- **源地址**：占 128 位。是数据报的发送端的 IP 地址
- **目的地址**：占 128 位。是数据报的接收端的 IP 地址

### IPv6 地址

#### IPv6 地址的表示方法⸺冒号十六进制记法

128 位长，以冒号分隔的八组十六进制数字表示，每组由 16 位组成

- **全写法**：每组 16 位用 4 位十六进制数表示，如 `2001:0db8:85a3:0000:0000:8a2e:0370:7334`
- **省略零**：前导零可以省略，如 `2001:db8:85a3:0:0:8a2e:370:7334`
- **双冒号**：一组连续的零可以用双冒号表示，但在一个地址中只能使用一次，如 `2001:db8:85a3::8a2e:370:7334`
- **冒号十六进制记法可结合使用点分十进制记法的后缀**，这种结合在 IPv4 向 IPv6 的转换阶段特别有用
  - 例如：`0:0:0:0:0:0:128.10.2.1` 再使用零压缩即可得出：`::128.10.2.1`
  - 冒号所分隔的每个值是两个字节（16 位）的量，但每个点分十进制部分的值则指明一个字节（8 位）的值
- **CIDR 的斜线表示法仍然可用**

#### 一般来讲，一个 IPv6 数据报的目的地址可以是以下三种基本类型地址之一

- **单播**：单播就是传统的**点对点**通信
- **组播**：组播是**一点对多点的**通信，数据报发送到一组计算机中的每一个。IPv6 没有采用广播的术语，而是将广播看作组播的一个特例
- **任播**：这是 IPv6 增加的一种类型。任播的终点是一组计算机，但数据报只交付其中的一个，通常是按照路由算法得出的距离最近的一个

![](./images/Pasted%20image%2020240907185830.png)

#### 常用地址

- **未指明地址**：16 字节的全 0 地址，可缩写为两个冒号 "::"。不能用作目的地址，而只能将某台主机当作源地址使用，条件是这台主机还没有配置到一个标准的 IP 地址。仅此一个
- **环回地址**：`0:0:0:0:0:0:0:1`，可缩写为：`::1`。作用和 IPv4 的环回地址一样。仅此一个
- **组播地址**：功能和 IPv4 的一样。这类地址占 IPv6 地址总数的 1/256
- **本地站点单播地址**：连接在这样的内部网络上的主机都可以使用这种本地站点地址进行通信，但不能和互联网上的其他主机通信。其用途和 IPv4 的专用地址是一样的
- **本地链路单播地址**：这种地址是在单一链路上使用的。当一个节点启用 IPv6 时就自动生成本地链路地址（请注意，这个节点现在并没有连接在某个网络上）。当需要把分组发往单一链路的设备而不希望该分组被转发到此链路范围以外的地方时，就可以使用这种特殊地址。这类地址占 IPv6 地址总数的 1/1024
- **全球单播地址**：单播地址的划分方法非常灵活：可把整个的 128 位都作为一个节点的地址；也可用 n 位作为子网前缀，用剩下的（128-n）位作为接口标识符（相当于 IPv4 的主机号）；当然也可以划分为三级，用 n 位作为全球路由选择前缀，用 m 位作为子网前缀，而用剩下的（128-n-m）位作为接口标识符

![](./images/Pasted%20image%2020240915134348.png)

#### IPv4 向 IPv6 过渡

向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由

两种向 IPv6 过渡的策略：使用双协议栈、使用隧道技术

##### 双协议栈

![](./images/Pasted%20image%2020240918181946.png)

- 双协议栈的主机或路由器记为 IPv6/IPv4，表明它同时具有两种 IP 地址：一个 IPv6 地址和一个 IPv4 地址
- 与 IPv6 主机通信时，采用 IPv6 地址；与 IPv4 主机通信时，采用 IPv4 地址
- 根据 DNS 返回的地址类型确定使用 IPv4 地址还是 IPv6 地址

> IPv6 首部中的某些字段却无法恢复。例如，原来 IPv6 首部中的流标号 X 在最后恢复出的 IPv6 数据报中只能变为空缺。这种信息的损失是使用首部转换方法所不可避免的

##### 隧道技术

![](./images/Pasted%20image%2020240918181927.png)

- 将 IPv6 数据包封装在 IPv4 数据包中进行传输，或将 IPv4 数据包封装在 IPv6 数据包中进行传输
- 在 IPv6 数据报进入 IPv4 网络时，将其封装为 IPv4 数据报
- 在离开 IPv4 网络的隧道时，再将数据部分交给 IPv6 协议栈

## 路由算法

![](./images/Pasted%20image%2020241020223146.png)

### 静态路由算法（*非自适应路由算法*）

![](./images/Pasted%20image%2020241020223029.png)
![](./images/Pasted%20image%2020241020223052.png)

- 由网络管理员**手动配置并维护**
- **应用场景**：适用于网络拓扑结构相对简单、变化较少的小型网络环境
- **优点**：简单、安全、转发路径确定
- **缺点**：灵活性和拓展性差，维护工作量大

### 动态路由算法（自适应路由算法）

- 使用路由协议自动发现和维护网络中的路由信息
- **应用场景**：适用于大型、复杂的网络环境
- **优点**：减少管理员的维护工作，改善网络性能，流量控制
- **缺点**：算法复杂，增加网络负担

> [! ] 动态路由算法可分为*距离 - 向量路由算法*和*链路状态路由*算法两类

#### 距离 - 向量路由算法【RIP】

- **基本概念**
  - **距离向量**：每个节点维护一个包含所有目标节点距离的向量
  - **路由表**：每个节点根据距离向量构建并维护一张路由表，记录到达各目标节点的下一跳节点和路径距离

- **路由信息的交换**
  - 节点周期性地向相邻节点广播其距离向量
  - 接收到距离向量后，节点根据 Bellman-Ford 算法更新自己的路由表

- **Bellman-Ford 算法**
  - 每个节点 i 对其每个相邻节点 j 的距离向量进行处理，更新其到目标节点 k 的最短路径距离 $D_i(k)$：
    - $D_i(k) = \min_{j} \{ D_j(k) + c_{i,j} \}$
    - 其中，$c_{i,j}$ 表示节点 i 到节点 j 之间的路径代价（通常为 1 表示一跳）

- **收敛与稳定**
  - 通过多次迭代和信息交换，最终使得每个节点的路由表达到稳定状态，即收敛
  - 收敛后，所有节点的路由表将包含到达所有目标节点的最短路径

- **特点**：**慢收敛**，可能遇到**路由环路**等问题

- **典型算法**：RIP 路由协议

#### 链路状态路由算法【OSPF】

- **基本概念**
  - **链路状态**：每个节点了解其直接相连链路的状态及其相邻节点
  - **链路状态包**（Link-State Packet, LSP）：包含节点的链路状态信息，广播给整个网络

- **算法步骤**
  1. **初始化**：每个节点仅了解与其直接相连的链路状态和相邻节点信息
  2. **链路状态包生成**：节点创建链路状态包，包含节点 ID、相邻节点 ID、链路成本等信息
  3. **链路状态包广播**：节点将链路状态包发送给所有相邻节点，确保每个节点最终收到全网的链路状态包
  4. **拓扑数据库更新**：每个节点根据收到的链路状态包构建全网拓扑图（即链路状态数据库）
  5. **最短路径计算**：每个节点使用 Dijkstra 算法计算从自身到所有其他节点的最短路径，并生成路由表

- **特点**
  - 向本自治系统中**所有路由器**发送信息，使用**泛洪法**
  - 发送的信息是**与路由器相邻的所有路由器的链路状态**，但这只是一个路由器所知道的**局部信息**
  - 只有当链路状态发生变化时，路由器才向所有路由器发送此信息
  - 广泛用于大型和复杂网络

- **优点**
  - 每个路由结点都使用同样的原始状态数据独立地计算路径，不依赖中间结点的计算
  - 链路状态报文不加改变地传播，易于查找故障
  - 当一个结点从所有其他结点接收到报文时，可以在本地立即计算正确的通路，保证一步汇聚
  - 链路状态报文大小只与邻接结点数有关，具有更好的规模可伸展性

- **典型算法**：OSPF

#### 距离 - 向量算法与链路状态算法的对比

|                 | 距离 - 向量算法【RIP】                  | 链路状态算法【OSPF】                         |
| --------------- | ------------------------------- | ------------------------------------ |
| **网络状态信息的交换范围** | 每个节点只与其相邻节点交换距离向量信息             | 每个节点向整个网络广播链路状态信息（信息包括与其他节点的连接状态和代价） |
| **网络状态信息的可靠性**  | 最短路径是基于节点间的信息交换，存在道听途说的情况，可靠性较弱 | 链路信息基于整个网络的链路状态，可靠性较强                |
| **健壮性**         | 节点之间会传递错误路径信息，相互之间容易产生误导，健壮性较弱  | 每个节点根据全局信息和特定算法计算最短路径，健壮性较强          |
| **收敛速度**        | 距离向量通过信息的交换逐步更新，收敛速度相对较慢        | 使用 Dijkstra 算法一次性确定到所有节点的最短路径，收敛速度较快 |

### 层次路由

![](./images/Pasted%20image%2020240915134109.png)

## 路由协议

### 自治系统

- 自治系统（AS）是在单一技术管理下的许多网络、IP 地址以及路由器，而这些路由器使用一种自治系统内部的路由选择协议和共同的度量
- AS 内部自主决定本系统内应采用何种路由选择协议
- 每一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略

### 域内路由与域间路由

![](images/Pasted%20image%2020241007005257.png)
![](images/Pasted%20image%2020241007005350.png)
![](./images/Pasted%20image%2020240918193309.png)

- 因特网将路由协议划分为**内部网关协议**和**外部网关协议**

- 使用层次路由时，使用内部网关协议 (OSPF) 把一个自治系统再划分为多个区域，每个路由器都仅知道在本区域内转发的细节

- 划分区域会令交换信息种类增多，使区域内部交换路由信息的通信量大大减小，从而使内部网关协议 (OSPF) 能够用于规模很大的自治系统中

### RIP 路由协议

![](images/Pasted%20image%2020241006234629.png)

- RIP（Routing Information Protocol）是一种分布式的基于距离向量的路由选择协议，优点是简单
- 规定：
  - **距离向量**：每个路由器维护到其他每个目的网络的距离记录
  - **跳数**：从一个路由器到直接连接网络的距离为 1，每经过一个路由器距离加 1
  - **优先选择跳数少的路径**：RIP 认为好的路由是跳数少的路径
  - **最大跳数**：最多包含 15 个路由器，距离等于 16 表示网络不可达（适用于小型互联网）
  - **防止环路**：规定路径上的最高跳数防止数据报不断循环，减少网络拥塞
  - **路由更新**：默认每 30 秒广播一次 RIP 路由更新信息，自动建立并维护路由表
  - **子网掩码**：RIP 不支持子网掩码的广播，RIP2 支持变长子网掩码和 CIDR

#### RIP 的特点

![](./images/Pasted%20image%2020240918193513.png)

- <font color="#e36c09">仅和相邻路由器交换信息</font>
- 路由器交换**路由表**信息
- 按固定时间间隔（如每 30 秒）**周期性交换路由信息**
- 路由器刚开始工作时，路由表是空的，逐步更新到达所有网络的最短距离和下一跳路由器的地址
- 所有节点最终得到正确的路由选择信息，RIP 通常可以较快收敛

#### 距离向量算法

![](./images/Pasted%20image%2020240907185847.png)
![](./images/Pasted%20image%2020240907185849.png)

> 对每个相邻路由器发送的 RIP 报文，执行以下步骤：

1. **修改报文**：

    - 将报文中的所有项目进行修改：将 " 下一跳 " 字段改为相邻路由器地址 XXX
    - 将所有 " 距离 " 字段值加 1
2. **处理修改后的每个项目**：

    - **如果路由表中没有目的网络 Net**，则添加该项目
    - **如果路由表中有目的网络 Net**：
        - **若下一跳路由器地址是 XXX**，则替换原项目
        - **若下一跳路由器不是 XXX**，且收到的距离 ddd 小于路由表中的距离，则更新项目
3. **处理未收到更新的情况**：

    - 若 3 分钟未收到相邻路由器的更新，则将其记为不可达（距离置为 16）
4. **完成并返回**

#### RIP 报文

![](images/Pasted%20image%2020241008220023.png)

- RIP 是**应用层协议**，报文作为 UDP 数据部分传送
- UDP 端口号 520
- 报文由首部和路由部分组成：
  - 路由部分包括自治系统号 ASN、目的网络地址（含子网掩码）、下一跳路由器地址及到网络的距离
  - 一个 RIP 报文最多包含 25 个路由，超过则需用多个报文传送

#### RIP 协议的优缺点

![](./images/Pasted%20image%2020241020223316.png)

#### 例题

![](./images/Pasted%20image%2020241020223345.png)
![](./images/Pasted%20image%2020241020223338.png)

### OSPF 路由协议

#### OSPF（Open Shortest Path First）：开放最短路径优先

- **开放**：表示 OSPF 协议不是受某一家厂商控制，而是公开发表的
- **最短路径优先**：使用 Dijkstra 提出的最短路径算法 OSPF
- 不使用 UDP 或 TCP，*而直接使用 IP 数据报传送*
  - IP 数据报首部的协议字段为 89
- *采用分布式的链路状态协议* (link state protocol)
- OSPF 只是一个协议的名字，并不表示其他的路由选择协议不是 " 最短路径优先 "
- **不会产生路由环路**

#### 各字段

![](./images/Pasted%20image%2020240907185856.png)

- **版本**：当前版本号是 2
- **类型**：
  1. **问候（Hello）分组**：用于发现和维持邻站的可达性
  2. **数据库描述（Database Description）分组**：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
  3. **链路状态请求（Link State Request）分组**：向对方请求发送某些链路状态项目的详细信息
  4. **链路状态更新（Link State Update）分组**：用洪泛法对全网更新链路状态，是 OSPF 协议最核心的部分
  5. **链路状态确认（Link State Acknowledgment）分组**：对链路更新分组的确认
- **分组长度**：包括 OSPF 首部在内的分组长度，以字节为单位
- **路由器标识符**：发送该分组的路由器接口的 IP 地址
- **区域标识符**：分组所属区域的标识符
- **检验和**：用于检测分组中的差错
- **鉴别类型**：0（不用）和 1（口令）
- **鉴别**：鉴别类型为 0 时填入 0，鉴别类型为 1 时填入 8 个字符的口令

#### 特点（与 RIP 的区别）

- **信息发送范围**：
  - **OSPF**：向本自治系统中**所有路由器**发送信息，使用洪泛法（flooding）
    - **洪泛法**：路由器通过所有输出端口向所有相邻路由器发送信息，最终整个区域中所有路由器都得到信息副本
  - **RIP**：仅向**相邻路由器**发送信息

- **信息内容**：
  - **OSPF**：发送与本路由器相邻的所有路由器的链路状态
    - **链路状态**：说明本路由器与哪些路由器相邻，以及该链路的 " 度量 "（metric），如费用、距离、时延、带宽等
  - **RIP**：发送到所有网络的距离和下一跳路由器

- **信息更新**：
  - **OSPF**：当链路状态变化或每隔一段时间（如 30 分钟），路由器用洪泛法发送链路状态信息
  - **RIP**：定期（每 30 秒）交换路由表信息

- **链路状态数据库**：
  - **OSPF**：各路由器频繁交换链路状态信息，最终建立全网一致的链路状态数据库，即全网拓扑结构图
  - **RIP**：每个路由器只知道到各个网络的距离和下一跳，不知道全网的拓扑结构

#### 区域

- 每个区域有一个 32 位的区域标识符（用点分十进制表示）
- 区域内路由器最好不超过 200 个
- 划分区域将洪泛法交换链路状态信息的范围局限于每个区域，减少全网通信量
- 区域内部路由器只知道本区域的完整网络拓扑，不知道其他区域的网络拓扑

![区域划分](images/Pasted%20image%2020240907185902.png)

- **主干区域**：连接其他区域的上层区域，标识符为 `0.0.0.0`
  - 区域边界路由器概括其他区域的信息，每个区域至少有一个区域边界路由器
  - 主干区域内的路由器称为主干路由器
  - 主干路由器可同时是区域边界路由器
  - 自治系统边界路由器与本自治系统外的其他自治系统交换路由信息

#### 工作过程

![](./images/Pasted%20image%2020241020224031.png)
![](./images/Pasted%20image%2020241020223844.png)

- **邻居发现与保持**
 ![](./images/Pasted%20image%2020241020223906.png)
 ![](./images/Pasted%20image%2020241020223915.png)
 ![](./images/Pasted%20image%2020241020223931.png)
  - **问候分组（Hello Packets）**：每两个相邻路由器每隔 10 秒钟交换一次问候分组，以确认相邻路由器是可达的。在正常情况下，网络中传送的绝大多数 OSPF 分组都是问候分组
  - **邻居失效检测**：如果 40 秒钟内没有收到某个相邻路由器发来的问候分组，则认为该相邻路由器不可达。此时，立即修改链路状态数据库，并重新计算路由表
- **初始数据库同步**

  - **数据库描述分组（Database Description Packets）**：路由器刚开始工作时，OSPF 让每个路由器使用数据库描述分组与相邻路由器交换本数据库中已有的链路状态摘要信息
  - **链路状态请求分组（Link-State Request Packets）**：路由器使用链路状态请求分组，向对方请求发送自己所缺少的某些链路状态项目的详细信息
  - **链路状态更新分组（Link-State Update Packets）**：通过这些分组交换详细信息，最终建立全网同步的链路状态数据库
- **链路状态更新**
 ![](./images/Pasted%20image%2020241020223947.png)
 ![](./images/Pasted%20image%2020241020224012.png)
 ![](./images/Pasted%20image%2020241020224018.png)

  - **链路状态变化**：在网络运行过程中，如果某个路由器的链路状态发生变化（例如，链路的增加或减少），该路由器会立即生成链路状态更新分组
  - **洪泛法更新**：该路由器使用洪泛法将链路状态更新分组发送给所有相邻路由器
  - **更新确认**：其他路由器收到更新分组后，会发送链路状态确认分组，以确认收到更新信息
- **快速收敛**

  - **重新计算路由表**：当链路状态数据库更新后，路由器使用 Dijkstra 算法重新计算从自身到所有其他节点的最短路径，并更新路由表
  - **全网同步**：通过上述过程，OSPF 确保整个网络的链路状态数据库始终保持同步，快速响应网络拓扑的变化，保证路由表的快速收敛

#### 多点网络的 OSPF 路由器

![](./images/Pasted%20image%2020241020224146.png)
![](./images/Pasted%20image%2020241020224209.png)

### BGP 路由协议

![](./images/Pasted%20image%2020241022122052.png)

![BGP 路由协议示意图](images/Pasted%20image%2020240907185908.png)

#### 概述

- **BGP（边界网关协议）**：目前常用的是 BGP-4，用于不同自治系统的路由器之间交换路由信息，是一种外部网关协议，主要用于互联网的网关之间
- **目标**：找到一条能够到达目的网络且比较好的路由（避免兜圈子，但不一定是最佳路由）
- **原因**：
- 互联网规模太大，自治系统之间的路由选择非常困难
- 自治系统之间的路由选择要寻找最佳路由是不现实的（自治系统权重不同，度量路由的代价不同）
- 自治系统之间的路由选择必须考虑有关策略（政治、经济、安全等）
- **协议类型**：路径向量路由选择协议，是应用层协议，基于 TCP

#### BGP 工作原理

![](./images/Pasted%20image%2020241020224301.png)

- **BGP 发言人选择**：

  - 每个自治系统的管理员选择至少一个路由器作为该自治系统的 BGP 发言人
- **BGP 会话建立**：

  - BGP 发言人与其他自治系统中的 BGP 发言人交换路由信息，需先建立 TCP 连接（端口号 179）
  - 在此连接上交换 BGP 报文以建立 BGP 会话，再利用 BGP 会话交换路由信息
- **路由信息交换**：

  - 当所有 BGP 发言人都相互交换网络可达性的信息后，各 BGP 发言人就可找出到达各个自治系统的较好路由（树形结构，不存在回路的自治通图）s

#### BGP 的特点

- **交换路由信息的结点数量级**：BGP 交换路由信息的结点数量级是自治系统的数量级，比这些自治系统中的网络数少很多
- **BGP 发言人数量少**：每个自治系统中 BGP 发言人的数目很少，使得自治系统之间的路由选择不致过分复杂
- **支持 CIDR**：BGP 支持无类别域间路由（CIDR），因此 BGP 的路由表包括目的网络前缀、下一跳路由器、要经过的各个自治系统序列
- **初始与增量更新**：在 BGP 刚运行时，BGP 的邻站交换整个 BGP 路由表，但以后只需在发生变化时更新有变化的部分

#### BGP-4 使用的 4 种报文

1. **打开（Open）报文**：用于与相邻的另一个 BGP 发言人建立关系
2. **更新（Update）报文**：用于发送某一路由的信息，以及列出要撤销的多条路由
3. **保活（Keepalive）报文**：用于确认打开报文并周期性地证实邻站关系
4. **通知（Notification）报文**：用于发送检测到的差错

#### 邻站关系的建立与维持

- **建立邻站关系**：

  - 若一个 BGP 发言人想与另一个 AS 的 BGP 发言人建立邻站关系，则要向对方发送 Open 报文
  - 若对方接受这种邻站关系，则用 Keepalive 报文响应
- **维持邻站关系**：

  - 邻站关系一旦建立，就要继续维持这种关系
  - 为此，这两个 BGP 发言人彼此要周期性地交换 Keepalive 报文（一般每隔 30 秒）

#### 习题

![](./images/Pasted%20image%2020241020224344.png)
![](./images/Pasted%20image%2020241020224358.png)

### 三种路由协议对比

![](./images/Pasted%20image%2020240915134644.png)

## IP 组播（IP Multicasting）

### 组播的概念

![](./images/Pasted%20image%2020241022123901.png)

- **定义**：
  IP 组播是一种 **一对多** 或 **多对多** 的通信方式，允许一个主机将 **同一个数据报发送给多个接收者**，而不需要为每个接收者单独发送多份数据。

- **优势**：
  在需要向多个接收者传递相同数据的场景（如网络视频会议、在线直播、分布式数据库更新等），组播可以**节约带宽和网络资源**。
  - 源主机只需将数据发送到 **组播地址**，由网络自动复制和转发给组内的所有成员。

- **组播组**：
  每个组播通信的接收方属于一个特定的**组播组**，该组由一个 **D 类 IP 地址**标识。主机通过 **IGMP**（Internet Group Management Protocol）向局域网中的路由器声明加入或退出某个组播组。
  - 组播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个组播组。

- **组播路由器**：
  支持组播功能的路由器能够**识别组播数据报**，并基于组播路由协议将其转发给正确的目标组成员。

- **传输协议**：
  IP 组播使用 **UDP** 进行传输。UDP 是无连接、尽最大努力交付的协议，因此不保证组内所有成员都能收到数据报。
  - **TCP** 不能用于组播通信，因为它是面向连接的协议，只支持 **一对一通信**。

### IP 组播地址 【**D 类地址**】

- **D 类 IP 地址**专门为组播保留。

- **D 类地址特点**：
  - 最高四位固定为 **1110**。地址范围是：**224.0.0.0 到 239.255.255.255**。
  - **部分地址有特殊用途**：
    - **224.0.0.0~224.0.0.255**：预留为局域网内部的特殊组播地址（如路由协议使用的组播）。
  - **不能用于源地址**：D 类 IP 地址只能作为 **目的地址**，用于标识组播组。

- **组播数据报的特点**：
  - 使用 **D 类地址** 作为目的地址。首部中的协议字段值是 2，表明使用 IGMP。
  - **对组播数据报不产生 ICMP 差错报文。若在 PING 命令后面键入组播地址，将永远不会收到响应**。

> [! ] 组播地址只能用于目的地址，不能用于源地址

> [! ] 并非所有 D 类地址都可以作为组播地址
>
> - **224.0.0.1**：所有主机组。
> - **224.0.0.2**：所有路由器组。
> - **224.0.0.5** 和 **224.0.0.6**：分别为 OSPF 路由器和 DR 组播地址。
> - **224.0.1.1**：NTP（网络时间协议）的组播地址。

### 组播 IP 地址与 MAC 地址的换算过程

组播 IP 地址与组播 MAC 地址的映射规则基于 D 类 IP 地址的特定二进制位，并且通过固定的 MAC 地址前缀加上 IP 地址的部分位数生成。由于映射规则只使用了 IP 地址的后 23 位，这导致多个组播 IP 地址可能会映射到同一个 MAC 地址。

1. **组播 IP 地址范围：**
   - 组播 IP 地址属于 D 类地址，范围是 **224.0.0.0** 到 **239.255.255.255**。
   - 前 4 位固定为 `1110`，只需映射**后 28 位**，但实际仅映射后**23 位**。

2. **映射规则：**
   - **组播 MAC 地址格式**：`01-00-5E` 是固定的前缀，后续部分由组播 IP 地址的后 23 位生成。
   - **第 24 位强制为 0**：虽然 IP 地址有 32 位，但只映射后 23 位，IP 地址的第 24 位设为 0。

---

> 示例 假设组播 IP 地址为 **224.215.145.230**，换算步骤如下

- IP 地址转换为二进制：【取后 23 位】
  - `224.215.145.230` ➡️ `1110 0000.1101 0111.1001 0001.1110 0110`
- 转换为十六进制：
  - 二进制表示转换为十六进制：`57-91-E6`
- 组播 MAC 地址：
  - 在前面加上固定前缀 `01-00-5E` ➡️ 01-00-5E-57-91-E6

##### 地址映射冲突问题

由于组播 IP 地址与 MAC 地址的映射规则只使用了 IP 地址的 23 位，剩下的 5 位未参与映射，因此**每 32 个组播 IP 地址可能映射到同一个组播 MAC 地址**。但是不会出现严重错误的原因:

1. **上层协议过滤**：即使不同的组播 IP 地址映射到相同的 MAC 地址，接收主机也会通过上层协议（如 IP 层）检查数据报。如果 IP 地址不在主机订阅的组播组中，数据报将被丢弃。

2. **冲突概率较低**：尽管可能发生 IP 地址冲突的情况，但在实际网络中，不同的组播 IP 地址映射到同一 MAC 地址的情况较为罕见。

### 组播类型

#### 局域网硬件组播

![](./images/Pasted%20image%2020241022124817.png)

- 在 **以太网**中，MAC 地址的第 1 个字节最低位为 **1** 即为组播地址。
- **IANA** 分配的以太网组播地址范围：
  **01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF**。
  这与 D 类 IP 地址的前 **23 位**有一一对应关系。
![](./images/Pasted%20image%2020241022124851.png)
![](./images/Pasted%20image%2020241022124941.png)

#### 互联网范围组播

- **IGMP 协议**用于通知路由器主机是否需要接收某个组播组的流量。
- 组播路由协议协同工作，将组播数据包通过**最优路径**转发给所有组成员。

### IGMP（网际组管理协议）

#### 定义与功能

- IGMP 是 IP 层的组成部分，用于**管理主机与路由器之间的组播组关系**。
- 网际组管理协议（Internet Group Management Protocol，IGMP）是 TCP/IP 体系结构网际层中的协议，其作用**是让连接在本地局域网上的组播路由器知道本局域网上是否有主机（实际上是主机中的某个进程）加入或退出了某个组播组**。

#### 工作过程

1. **加入组播组**：
 ![](./images/Pasted%20image%2020241022125643.png)

   - 主机向局域网内的组播路由器发送 **IGMP 报文**，声明加入某个组播组。
   - 路由器收到报文后，将主机**加入该组的成员关系**，并通过组播路由协议通知其他路由器。

2. **探询组成员关系**：
  ![](./images/Pasted%20image%2020241022130020.png)
  ![](./images/Pasted%20image%2020241022130033.png)
  ![](./images/Pasted%20image%2020241022130041.png)

   - 组播路由器会定期发送 **查询报文**，探询局域网内的主机是否仍是某个组播组的成员：
     - **只要一台主机响应**，该组播组就保持活跃状态。
     - 如果路由器**多次查询未收到响应**，则认为组内成员已全部离开，停止转发该组的数据。
     ![](./images/Pasted%20image%2020241022130221.png)

> [!NOTE]
> **IGMP 仅在本地网络内有效**。IGMP **无法获取组播组成员的数量**，也无法了解组播组成员所在的具体网络。
> 在广域网（Internet）进行组播传输时，**还需使用组播路由协议**，以便组播数据报能够以最低代价传递给所有组成员。

#### 三种报文

![](./images/Pasted%20image%2020241022125608.png)

### 组播路由选择协议

- 组播路由选择协议的**核心任务**是：
  - **为每个组播组建立一棵组播转发树**，以实现高效的数据转发。

- **组播成员的动态性**：
  组播组的成员**随时可能加入或离开**，路由器需动态调整转发路径。

- **组播转发树**：
  - **转发树的结构**：
    - 每个组播路由协议会根据**源主机的位置**建立一棵 **组播转发树**。
    - 数据报会沿着转发树，从源主机向所有接收者传递，**不产生重复的数据包**。

  - **不同组播源的树结构**：
    - **同一组播组的不同源主机**会生成不同的组播转发树。
    - 不同组播组也会有各自的独立转发树。
- **数据转发流程**
  - 在组播路由器之间，**IP 组播数据报沿着转发树进行洪泛**（Flooding），将数据传递给所有拥有组成员的组播路由器。
  - 在每个组播路由器直连的局域网中，**硬件组播**将数据报转发给组播组的所有成员。

### IP 组播的应用场景

- **视频直播**：
  实现大规模网络广播和在线视频会议，减少重复流量。

- **在线教学**：
  支持多个学生同时收看课程，实现高效教育资源分发。

- **分布式系统**：
  确保多个节点之间的数据保持同步，提高系统一致性。

## 移动 IP

### 移动 IP 的概念

**移动 IP（Mobile IP）** 是因特网工程任务组 IETF 开发的一种技术（[RFC 3344]），该技术*使得移动主机在各网络之间漫游时，仍然能够保持其原来的 IP 地址不变*。

- 移动 IP 使移动站能够以**固定的 IP 地址实现跨越不同网络的漫游功能**，并**保证基于 IP 的网络权限不发生改变**。
- **目标**：自动地将分组投递给移动站，使其在移动中的 TCP 连接不中断，IP 地址保持不变。

#### 基本概念

- **移动结点（Mobile Node）**：具有**永久 IP 地址**的移动主机。
- **归属代理（Home Agent）**：连接在**归属网络**上的路由器。用于维护移动结点的位置，接收发往移动结点的数据包，并通过**隧道转发**给移动结点。
- **外地代理（Foreign Agent）**：位于**被访网络**（外地网络）的路由器，为移动主机分配临时使用的**转交地址（Care-of Address, CoA）**，并负责数据的封装和解封。
- **永久地址（归属地址）**：移动站的原始地址，与归属网络绑定。整个通信过程始终不变。
- **归属网络**：移动站最初连接的网络，永久地址与归属网络的关联不变。
- **被访网络（外地网络）**：移动站移动后所接入的网络。
- **转交地址（Care-of Address）**：外地代理为移动站提供的临时地址。
- **同址转交地址**：当移动站本身充当外地代理时的转交地址。

> [! ] 当移动结点自带转交地址时，它充当自己的外地代理，这称为同址转交地址。

### 移动 IP 通信过程

#### 在归属网络中通信

移动结点在归属网络时，直接按照传统 TCP/IP 方式通信，无需额外操作。

#### 外地网络注册

1. 当移动结点离开归属网络，进入外地网络时，会向外地代理（FA）注册，申请一个转交地址（CoA）。
 ![](./images/Pasted%20image%2020241023130841.png)
2. 外地代理会将该转交地址通知归属代理（HA），完成位置注册。
    ![](./images/Pasted%20image%2020241023130859.png)
    ![](./images/Pasted%20image%2020241023130947.png)

#### 数据包的隧道传输

![](./images/Pasted%20image%2020241023131006.png)

1. 归属代理会将所有发给移动结点的数据包通过 **IP 隧道技术**发送到转交地址。
2. 数据包经过隧道封装，并在到达外地代理时解除封装。

#### 通信过程中的数据包传递

##### 固定主机向移动主机发送 IP 数据报

![](./images/Pasted%20image%2020241023131452.png)

- 固定主机发送的数据报的目的地址是移动主机的**永久地址**。
- 归属代理接收到该数据报后，通过隧道将数据报发送到外地代理。
- 外地代理解除隧道封装后，查找移动主机的 MAC 地址，将数据报传送到移动主机。

##### 移动主机向固定主机发送 IP 数据报

![](./images/Pasted%20image%2020241023131714.png)

- 移动主机按照正常的发送流程发送数据报，数据包的源地址为移动主机的**永久地址**。
- 由于 IP 路由器只关心目的地址，该数据报会被直接路由到固定主机。

##### 同址转交方式

![](./images/Pasted%20image%2020241023132402.png)

- 如果外地代理和移动主机在同一台设备上，转交地址就是移动主机的 IP 地址。

#### 数据包的解封与转发

1. 外地代理解除隧道封装后，将原始数据包转发给移动主机。
2. 如果移动主机再次移动到新的网络，会向归属代理更新转交地址，确保通信不中断。

#### 基本通信流程

1. **归属网络通信**：移动结点在归属网络时，按传统的 TCP/IP 方式通信。
2. **外地网络登记**：移动结点漫游到外地网络时，向外地代理登记，获得临时转交地址。外地代理向归属代理登记转交地址。
3. **隧道传输**：归属代理接收注册后，构建通向转交地址的隧道，将发给移动结点的 IP 分组再封装，通过隧道送到外地代理。
4. **解除封装**：外地代理解除隧道封装，恢复原始 IP 分组，发送给移动站。
5. **数据报发送**：移动结点在被访网络发送数据报时，使用永久地址作为源地址，通过外地代理向通信对端发送 IP 数据包（在转交地址处进行隧道封装）。
6. **更新转交地址**：移动结点来到另一个外网时，向本地代理更新注册的转交地址，继续通信。无论如何，移动站收到的数据报都是由归属代理转发。
7. **回归本地网**：移动结点回到本地网时，向本地代理注销转交地址，按传统的 TCP/IP 方式通信。

#### 通信示例

1. 移动主机在外地代理处**注册永久地址和归属代理地址**。
2. 归属代理将移动主机的**转交地址记录下来**，并代替移动主机接收所有发往它的数据报。
3. 归属代理使用**IP 隧道技术**将数据报转发到外地代理。
4. 归属代理通过**ARP 代理技术**响应针对移动主机的 ARP 请求，并将自己的 MAC 地址提供给其他设备。
5. 移动主机返回归属网络时，**注销转交地址**，恢复正常通信。

### 三角路由问题

![](./images/Pasted%20image%2020241022131226.png)
三角路由（Triangular Routing）问题是指在*移动 IP* 中，通信对端（Correspondent Node）发送给移动主机的数据包必须先经过归属代理，再由归属代理转发到移动主机当前所在的网络。

- **延迟增加**：由于数据包必须经过归属代理，导致整体通信路径变长，增加了传输延迟。
- **资源浪费**：数据包在传输过程中需要多次封装和解封，造成了带宽的浪费和网络负担。

#### 解决方案

1. **优化路由**：引入**路由优化（Route Optimization）** 技术，使通信对端直接向移动主机的转交地址发送数据包。
2. **代理应答**：归属代理采用**ARP 代理**技术，将自己的 MAC 地址映射为移动主机的永久 IP 地址，并通过 ARP 广播更新归属网络中的缓存表，确保通信正常进行。

#### 外地代理的功能

#### 示例

![](./images/Pasted%20image%2020241022131239.png)
假设移动主机 A 通过代理发现协议与外地代理建立联系，并从外地代理获得一个属于该外地网络的转交地址（如 175.1.1.1/16）。此后，移动主机向外地代理注册自己的永久地址和归属代理地址。

1. **记录转交地址**：归属代理记录下移动主机 A 的转交地址，之后会代替移动主机接收所有发往该主机的 IP 数据报，并通过 IP 隧道技术将这些数据报转发给外地网络中的移动主机。

2. **ARP 应答**：当移动主机不在归属网络时，归属代理会用自己的 MAC 地址应答所有对移动主机的 ARP 请求，并主动发送 ARP 广播更新归属网络中的高速缓存。这样，发送给移动主机的 IP 数据报会被路由到归属代理，再由其转发。

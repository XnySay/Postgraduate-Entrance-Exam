## 数据链路层的概述

### 研究思想：**水平**

- **结点**：网络中的设备，例如计算机、路由器、交换机等
- **链路**：
  - 网络中两个结点之间的**物理通道**（有线或无线），中间没有任何其他交换节点
  - 传输介质主要有双绞线、光纤和微波
- **数据链路**：
  - 网络中两个结点之间的**逻辑通道**
  - 把实现数据传输协议的硬件和软件加到链路上就变成了数据链路
- **帧**：
  - **定义**：数据链路层对等实体之间进行逻辑通信时使用的协议数据单元（PDU）
  - **功能**：
    - 作为数据链路层的传输单位，帧使得网络中的数据传输变得有序且高效
    - 通过封装网络层的数据报，帧为数据提供了必要的格式，以便在数据链路层进行处理
  - **结构**：
    - **首部**：包含了用于数据传输的重要信息，如地址信息、控制信息以及校验信息等
    - **尾部**：主要包含校验信息，用于检测数据在传输过程中是否出现错误

## 数据链路层的功能 (5 个)

### 1. 为网络层提供服务

- 数据链路层在物理层提供服务的基础上向网络层提供服务
- 对于网络层而言，数据链路层的基本任务是将源机器中来自网络层的数据传输到目标机器的网络层
- 通常提供**无确认的无连接**服务

![](./images/Pasted%20image%2020240915153710.png)

![](./images/Pasted%20image%2020240919195135.png)

#### 无确认的 无连接服务

- 发送数据帧时不需先建立链路连接，收到数据帧时不需发回确认
- 对丢失的帧，交给上层处理
- 适用于实时通信或误码率较低的通信信道，如<font color="#00b050">以太网</font>
- 通信质量好，有线

#### 有确认的 无连接服务

- 发送数据帧时不需先建立链路连接，但收到数据帧时必须发回确认
- 源机器在所规定的时间内未收到确定信号时，就重传丢失的帧 (超时重传)
- 适用于误码率较高的通信信道，如<font color="#00b050">无线通信</font>

#### 有确认的 面向连接服务

- 帧传输过程分为三个阶段：建立数据链路、传输帧、释放数据链路
- 收到每一帧都要确认，收到确认后才能发送下一帧，可靠性最高
- 适用于通信要求（可靠性、实时性）较高的场合

> [! ] 不存在无确认的面向连接的服务;【有连接的服务一定要确认】

#### 小结

| 特性     | 无确认的无连接服务      | 有确认的无连接服务    | 有确认的面向连接服务     |
| ------ | -------------- | ------------ | -------------- |
| 建立链路连接 | 不需要            | 不需要          | 需要             |
| 发送数据确认 | 不需要            | 需要           | 需要             |
| 数据重传机制 | 上层处理           | 源机器在规定时间内重传  | 每帧确认，确认后发送下一帧  |
| 适用场景   | 实时通信，误码率低的信道   | 误码率高的信道      | 可靠性、实时性要求高的场合  |
| 实际应用   | UDP（视频直播、在线游戏）| 无线局域网（Wi-Fi）| TCP（文件传输、电子邮件）|

### 2. 链路管理（<font color="#e36c09">面向连接</font>的服务）

链路管理即**数据链路层连接的建立、维持和释放过程**，主要用于**面向连接的服务。**

#### 信道分配与管理

在多站点共享同一物理信道的情况下，如何在要求通信的站点间分配和管理信道也属于数据链路层管理的范畴

### 3. 帧定界、帧同步与透明传输

![](./images/Pasted%20image%2020241021215532.png)
![](./images/Pasted%20image%2020241021215550.png)
![](./images/Pasted%20image%2020240907175326.png)

**组帧**：封装网络层的分组，前后添加首部和尾部后构成

**帧定界**：首部和尾部中含有很多控制信息 (帧定界符)，作用：确定帧的界限

**帧同步**：接收方应能从接收到的二进制比特流中区分出帧的起始与终止

- 发送方插入，接收方删除

#### 透明传输

数据在传输过程中不被修改或解释，数据链路层不对数据内容做任何处理，只是将数据从源端传递到目的端
传输过程会采取有效措施防止发送信息中出现标志，导致被误以为结束，即**无论数据是什么都可以正常（无差错）传输**

> 为了提高帧的传输效率，应使帧的数据部分尽量大，但协议规定了帧的数据部分的长度上限（最大传送单元 MTU）

### 4. 流量控制（限制发送方）

流量控制是指由接收方控制发送方的发送速率，使接收方有足够的缓冲空间来接收每个帧
常见的流量控制方法有两种：

- 停止 - 等待协议
- 滑动窗口协议

数据链路层和传输层均有流量控制功能，均使用滑动窗口协议，但有所区别

#### 不同层次的流量控制

| 层级    | 流量控制范围     | 控制手段                     |
| ----- | ---------- | ------------------------ |
| 数据链路层 | **相邻节点之间** | 帧间间隔、流量整形和窗口机制           |
| 网络层   | **整个网络中**  | 路由算法、拥塞控制技术              |
| 传输层   | **端到端**    | 拥塞控制协议如 TCP 的流量控制和拥塞避免机制 |

| 体系结构        | 流量控制所在层 |
| :---------: | :-----: |
| OSI 体系结构    |  数据链路层  |
| TCP/IP 体系结构 |   传输层   |

### 5. 差错控制（位错/帧错）

差错控制是发送方确定接收方是否正确收到由其发送的数据的方法

#### 位错: 帧中某些位出现差错

- 通常采用循环冗余校验（CRC）方式发现位错
- 通过自动重传请求（ARQ）方式来重传出错的帧：

#### 帧错: 帧的丢失、重复或失序等错误

在数据链路层引入**定时器和编号**机制：

- 定时器过时时没确认就重传，避免帧的丢失
- 编号避免重复并保证有序

## 组帧的四种方法

### 字符计数法（易出错，不常用）

字符计数法在**帧头部**使用一个计数字段来标明**帧内字符数**，接收方根据计数字段的值确定帧的边界
计数字段的字节数包含自身所占用的一个字节

![](./images/Pasted%20image%2020240919195352.png)

- **优点**：简单直接，易于实现
- **缺点**：如果传输过程中计数字段出错，接收方会误解帧的长度，导致帧同步失效

### 字符（节）填充的首尾定界符法（复杂且不兼容，不常用,**PPP**中使用）

字符填充的首尾定界符法使用特定的字符（如 SOH 和 EOT）来标识帧的开始和结束
![](./images/Pasted%20image%2020240920201721.png)

- 控制字符 `SOH (start of header)` 表示帧的首部开始
- 控制字符 `EOT (end of header)` 表示帧的结束

如果数据部分包含这些特殊字符，在传输前在特殊字符前填充一个转义字符（ESC）加以区分

- ⽂本⽂件（ASCII 组成）——SOH、EOT
- ⾮ ASCII 码⽂本⽂件（图像…）——SOH、EOT、ESC

![](./images/Pasted%20image%2020241026144751_pixian_ai.png)

- 遇到 PDU 里的 `Flag`,`ESC`，前面插入转义字符 `ESC`

- **优点**：定界符明显，便于识别帧边界
- **缺点**：如果帧内的数据包含定界符字符，则需要进行字符填充，增加了数据传输的复杂性

### 零比特填充的首尾标志法（**HDLC**中使用）

- 发送方在数据中每出现 5 个连续的 "1" 时，自动插入一个 "0".
- 防止数据中出现与标志相同的序列。（确保不会出现连续的 6 个 1）
- 注意封装的帧首尾要有 `FLAG 帧定界符`
- 接收方在接收数据时，检测到标志后移除填充的 0

![](./images/Pasted%20image%2020241026145043.png)

- **优点**：比特级别的操作，适合高效的硬件实现
- **缺点**：需要在发送端和接收端都实现零比特填充和移除的逻辑

### 违规编码法（**局域网 IEEE 802 标准**中使用）

违规编码法使用在正常数据编码中不会出现的特殊码组来标识帧边界

如：曼彻斯特编码的 " ⾼ - ⾼ "，" 低 - 低 " 定界帧的起始和终⽌

- 在物理层⽤编码实现

- **优点**：不需要进行填充操作，帧边界的识别相对简单
- **缺点**：只适用于采用冗余编码的特殊编码环境

## 差错控制（只讨论比特差错）

实际通信链路不是理想的。数据在传输过程中可能会受到**噪声**、干扰等因素的影响，从而导致比特错误

- **自动重传请求（ARQ）**：检错编码
- **前向纠错（FEC）**：纠错编码

### 自动重传请求 ARQ 方式

在 ARQ 方式中，检测出差错时，通知发送端重发，直到接收到正确的码字为止

### 前向纠错 FEC 方式

在 FEC 方式中，检测出差错时，还能定位比特串的出错位置，并进行纠正

![](./images/Pasted%20image%2020241021220054.png)
![](./images/Pasted%20image%2020241021220044.png)

## 检错编码

采用冗余编码技术，发送前在有效数据添加冗余位，接收端根据一定的规则来判断是否出错

常见的检错编码有 `奇偶校验码`，`循环冗余码`

### 奇偶校验码【检错】

通过在数据 **末尾（最低位）** 添加一个奇偶校验位来实现

- **奇校验**：确保数据中 **1 的个数为奇数**
  - 如果数据中 1 的个数已经是奇数，则校验位设为 0
  - 如果数据中 1 的个数是偶数，则校验位设为 1，以使 1 的总数变为奇数
- **偶校验**：确保数据中 **1 的个数为偶数**
  - 如果数据中 1 的个数已经是偶数，则校验位设为 0
  - 如果数据中 1 的个数是奇数，则校验位设为 1，使 1 的总数变为偶数

**优点**：实现简单，计算开销低

**缺点**：*只能检测单个比特错误，无法检测偶数个比特错误*

> [! ] 奇偶校验可以通过异或操作来快速计算
> 数据中的所有位按位异或，结果是 1 就表明奇数个 1，结果是 0 则表明偶数个 1

### 循环冗余码（CRC）【检错】

循环冗余码（CRC）是一种**高效的错误检测方法**
通过将数据视为一个多项式，并利用预先商定的**生成多项式**进行模 2 除法运算
生成多项式的余数作为校验码，附加在数据后面
接收方使用相同的生成多项式对收到的数据进行验证

#### CRC 检错步骤总结

1. **选择生成多项式 G (x)**：通信双方商定一个特定的多项式 G (x)【r 次多项式有 r+1 位】
   - 多项式的最低位必须是 1 不能是 0

2. **扩展数据**：将 r 个零附加在数据后面
3. **模 2 除法**：将扩展后的数据多项式与 G (x) 进行模 2 除法，得到余数 R (x)【r 位】
4. **附加校验码**：将余数 R(x) 附加在原始数据后面
5. **接收端校验**：接收端用 G(x) 对整个数据帧进行模 2 除法，验证数据完整性

> [! ]  **模 2 除法**：加法不进位，减法不借位，是**异或**操作
>
> 1. 异或运算就是无进位相加
> 2. 异或运算满足交换律、结合律，也就是同一批数字，不管异或顺序是什么，最终的结果都是一个
> 3. 0^n=n，n^n=0
> 4. 整体异或和如果是 x，整体中某个部分的异或和如果是 y，那么剩下部分的异或和是 x^y

#### CRC 的优缺点

- **优点**：
  - CRC 可以检测大多数传输错误，包括单比特错误、突发错误等
  - 错误检测能力比简单的奇偶校验强得多，且计算效率高

- **缺点**：
  - 虽然 CRC 可以检测大部分错误，但仍然无法保证 100% 无错误，尤其是生成多项式设计不合理时

#### 例子

![](./images/Pasted%20image%2020241026145150.png)

- 待传送数据: $M = 101001$
- 除数: $P = 1101$
- 任务：计算最终发送的数据

> **计算步骤**：

1. **附加零位**：为了进行模 2 除法，我们在数据后面附加与除数位数减 1 相同数量的零

   - 原始数据 $101001$ 附加零位后变为 $101001000$

2. **进行模 2 除法**：使用模 2 除法处理待传送数据和除数，计算出余数

   - 初始数据：`101001000`
   - 除数：`1101`
   - 除法过程如下：

   - 通过对齐最高位并进行异或操作来逐步计算余数：

   - 计算结果显示最终余数为 `001`

3. **附加余数**：将计算得到的余数附加到原始数据的末尾

   - 附加余数后的数据为 $101001001$

4. **最终发送的数据**：完成以上步骤后，最终发送的数据为 `101001001`

#### 发送方

![](./images/Pasted%20image%2020241021220135.png)
![](./images/Pasted%20image%2020241021220230.png)

#### 接收方

![](./images/Pasted%20image%2020241021220140.png)
![](./images/Pasted%20image%2020241021220237.png)

#### 小结

![](./images/Pasted%20image%2020240924113717.png)

- 循环冗余码本身具有纠错功能，但是数据链路层仅使用其检错功能，检测到帧出错直接丢弃
  - 检测所有奇数位个错误
  - 检测出所有双比特的错误
  - 检测出所有小于等于检验位长度的连续错误
- CRC 检验码可以检错出所有的单比特错误
- 带 r 个检测位的多项式编码可以检测出所有长度小于或者等于 r 位的突发性错误
- CRC 检验不是 " 可靠传输 "，而是 " 差错检测 ";【出错的数据被丢弃了】
- 可以用硬件实现，快
- 帧检错序列：余数 R(x) 即为帧检验序列，用于检验数据帧的完整性
- 帧检测序列（FCS）与循环冗余校验（CRC）的区别总结

| 类别        | FCS                          | CRC                          |
| --------- | ---------------------------- | ---------------------------- |
| 定义        | 数据链路层错误检测方法<br/>使用特定算法如 CRC 计算 | 检错编码方法<br/>基于二进制除法用于数据传输错误检测 |
| 用途        | 用于数据链路层帧校验<br/>确保帧传输无误       | 用于生成 FCS<br/>文件校验等多 1 种数据校验场景   |
| 工作<br/>原理 | 计算帧的校验值并在接收端验证               | 对数据进行二进制除法<br/>检查余数验证数据正确性   |
| 计算<br/>方法 | 依赖选用的算法，如 CRC-32              | 涉及附加零位、二进制除法等步骤              |

## 纠错编码

纠错编码就是在每个要发送的数据块上附加足够的冗余信息使接收方能够推导出发送方实际送出的应该是什么样的比特串
最常见的纠错编码是海明码

### 海明码【纠错】

通过在数据中插入冗余校验位，使得数据和校验位的组合能够**唯一地标识错误位置**

 **海明距离**：两个二进制字符串之间相应位不同的位数

 **冗余校验位**：在海明码中，冗余校验位的位置和数量由数据位的数量决定

- 设数据位的数量为 n，校验位的数量为 r，则满足以下关系：$$2^r - 1 \geq n + r$$

- n 位数据位，r 位校验位，总共 n+r 位
- r 个分组可以表示 $2^r - 1$ 个不同的位置

 校验位插入的位置通常采用自右向左（即 1, 2, 4, 8, …）这些指数位置

**步骤**：

1. **确定校验位位数和位置**：【校验码 $P_{1}$ 在编码中的位置】

    |   | $M_{1}$ | $M_{2}$ | $M_{3}$ | $M_{4}$ | $M_{5}$ | $M_{6}$ | $M_{7}$ | $M_{8}$ | $M_{9}$ | $M_{10}$ |
    |---|---|---|---|---|---|---|---|---|---|---|
    | 甲 | $P_{1}$ | $P_{2}$ |   | $P_{3}$ |  |   |   | $P_{4}$ |   |   |

    > 【数据在编码中的位置】

    |     | $M_{1}$ | $M_{2}$ | $M_{3}$ | $M_{4}$ | $M_{5}$ | $M_{6}$ | $M_{7}$ | $M_{8}$ | $M_{9}$ | $M_{10}$ |
    | --- | ------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- | -------- |
    | 甲   | $P_{1}$ | $P_{2}$ | $D_{1}$ | $P_{3}$ | $D_{2}$ | $D_{3}$ | $D_{4}$ | $P_{4}$ | $D_{5}$ | $D_{6}$  |
    | 乙   |         |         | 1       |         | 0       | 1       | 1       |         | 0       | 1        |

    - 数据位为 4 位
    - 校验位计算得出为 3 位，满足最小要求
    - 海明码共 7 位，分别为 H1, H2, H3, H4, H5, H6, H7，对应关系如下：

        ```plaintext
        H7 H6 H5 H4 H3 H2 H1
        D4 D3 D2 P3 D1 P2 P1
        ```

    - 例如，数据为 1100，海明码为 7 位，包括 3 位校验位

        ```plaintext
        H7 H6 H5 H4 H3 H2 H1
        1  1  0  P3 0  P2 P1
        ```

2. **计算校验位值**

   - 校验位的值通过计算其覆盖范围内所有位的异或（XOR）值得到
   - 计算示例：

     - `P1 = H3 ⊕ H5 ⊕ H7 = D1 ⊕ D2 ⊕ D4 = 0 ⊕ 1 ⊕ 0 = 1`
     - `P2 = H3 ⊕ H6 ⊕ H7 = D1 ⊕ D3 ⊕ D4 = 0 ⊕ 0 ⊕ 0 = 0`
     - `P3 = H5 ⊕ H6 ⊕ H7 = D2 ⊕ D3 ⊕ D4 = 0 ⊕ 1 ⊕ 1 = 0`

   - 最终海明码为：110 **0** 0 **01**

   - 每个校验位覆盖一定范围内的数据位。校验位的值通过计算覆盖范围内所有位的异或（XOR）值得到。如
   - `P1 = H3 ⊕ H5 ⊕ H7 = D1 ⊕ D2 ⊕ D4 = 0 ⊕ 1 ⊕ 0 = 1`
   - `P2 = H3 ⊕ H6 ⊕ H7 = D1 ⊕ D3 ⊕ D4 = 0 ⊕ 0 ⊕ 0 = 0`
   - `P3 = H5 ⊕ H6 ⊕ H7 = D2 ⊕ D3 ⊕ D4 = 0 ⊕ 1 ⊕ 1 = 0`

   - P1 的检验位覆盖位置：1, 3, 5, 7 …（转为二进制表示第 1 位为 1 的集合）
   - P2 的检验位覆盖位置：2, 3, 6, 7 …（转为二进制表示第 2 位为 1 的集合）
   - P3 的检验位覆盖位置：3, 5, 6, 7 …（转为二进制表示第 3 位为 1 的集合）

3. **接收方检验和纠错**：
   - 接收方接收到码字后，通过计算所有校验位的覆盖范围内的异或值（**偶校验**），检测是否存在错误
     - 如果某些校验位的异或值不为零，则根据这些校验位的组合确定错误位置

   - **偶校验**：如果数据中 1 的个数为偶数，则校验位为 0；如果为奇数，则校验位为 1
   - ![](./images/Pasted%20image%2020240924151112.png)
   - **示例**：假设收到的海明码为 `111 0 0 01`
     - `S1 = P1 ⊕ H3 ⊕ H5 ⊕ H7 = 1 ⊕ 0 ⊕ 1 ⊕ 1 = 1` ❌
     - `S2 = P2 ⊕ H3 ⊕ H6 ⊕ H7 = 0 ⊕ 0 ⊕ 1 ⊕ 1 = 0` ✅
     - `S3 = P3 ⊕ H5 ⊕ H6 ⊕ H7 = 0 ⊕ 1 ⊕ 1 ⊕ 1 = 1` ❌
   - **结果**：`S3 S2 S1 = 101 = 5`。若值为 "000"，则说明无错；否则出错，且这个数是错误位的下标

---

> [! ] 可以发现双比特错误，但只能纠正单比特错误
>
> - **检**d 位错，需要最小码距：d+1
> - **纠**d 位错，需要最小码距码距：2d+1

## 流量控制

发送方和接收方之间协调数据传输速率的机制
确保发送方不会以超过接收方处理能力的速度发送数据

## 可靠传输

- **不可靠传输**：收到有误码的帧，直接丢弃，其他什么也不做；未收到发送方发送的帧，也不进行任何处理。
- **可靠传输**：发送方发送的数据能被接收方正确接收。实现可靠传输需要以下两个重要机制：

### 确认

- 接收方收到数据帧后，向发送方发回确认帧，表示已准确接收

### 超时重传

- 发送方发送某帧后，若在规定时间内未收到确认帧，则重发该帧
- 通过给每帧设置超时计时器实现

### 自动重传请求 (ARQ)

- 使用确认和超时重传机制的协议称为 ARQ 协议，重传自动进行，接收方无需请求重传
- 发送方发出一帧后，暂时保存该帧副本，收到确认后清除
- 数据帧和确认帧需编号，以辨别确认帧针对哪一帧
- 超时计时器的重传时间应比帧的往返传播时间长一些，避免不必要的重传或降低通信效率

### ARQ 协议类型

- **停止 - 等待协议**
- **后退 N 帧协议**
- **选择重传协议**

> [! ] 这些机制不仅限于数据链路层，可应用于其他层

### 传输服务

- 不可靠传输服务：丢弃有误码的帧
- 可靠传输服务：确保发送端发送的数据与接收端接收的数据一致

![](./images/Pasted%20image%2020241021221759.png)

### 不同层次的可靠性对比

![](./images/Pasted%20image%2020241021221913.png)

- **可靠传输服务并不局限于数据链路层**，其他各层均可以选择可靠传输
- 可靠传输的实现比较复杂，开销比较大，是否使用可靠取决于应用需求

### 机制

- **确认**：
  - 一种**无数据的控制帧**，使得接收方可以让发送方知道哪些内容被正确接收
  - 有些情况下，为了提高传输效率，将确认捎带在一个回复帧中，称为**捎带确认。**

- **超时重传**：发送方在发送数据帧后开启一个**计时器**，若超时未收到确认，则重新发送该数据帧，直到收到确认

  - **自动重传请求 (ARQ)**
    - 接收方请求发送方**重传出错的数据帧**来恢复出错的帧，用于处理信道所带来的差错

  - **停止 - 等待 (Stop-and-Wait) ARQ**

  - **后退 N 帧 (Go-Back-N) ARQ**

  - **选择重传 (Selective Repeat) ARQ**

后两种是滑动窗口与请求重发的结合，**当窗口尺寸足够大时，帧在线路上可以连续地流动，又称其为连续 ARQ 协议。**

数据链路层中的流量控制机制和可靠传输机制是**交织在一起**的

- **有线链路**：传输出错概率较低，通常**不要求**数据链路层向上提供可靠传输服务

- **无线链路**：传输出错概率较高，**要求**数据链路层向上提供可靠传输服务

## 滑动窗口

- **发送窗口**：发送方维护的一个窗口，窗口内的数据帧可以连续发送而不等待确认
- **接收窗口**：接收方维护的一个窗口，窗口内的数据帧可以按序接收和确认
- **窗口滑动**：每当接收方确认一个数据帧，窗口向前滑动，允许发送下一个数据帧
- **接收窗口控制**：接收端设置接收窗口是为了控制可以接收哪些数据帧和不可以接收哪些帧
  - 接收端收到数据帧后，将窗口向前移一个位置，并发回确认帧，若收到的数据帧落在接收窗口之外，则一律丢弃

### 滑动窗口特性

- **窗口滑动**：接收窗口向前滑动（发送了确认帧）时，发送窗口才有可能（收到确认帧后才）向前滑动
- **窗口大小**：三个协议只在发送窗口【$W_T$】和接收窗口【$W_R$】的大小上有所差别：

  - **停止 - 等待协议**：$W_T = 1$，$W_R = 1$
  - **后退 N 帧协议**：$W_T > 1$，$W_R = 1$
  - **选择重传协议**：$W_T > 1$，$W_R > 1$
- **有序接收**：接收窗口的大小为 1 时，可以保证帧的有序接收
- **窗口大小固定**：
  - 数据链路层的滑动窗口协议中，窗口的大小在传输过程中是固定的
  - 传输层的滑动窗口协议中，窗口的大小是动态变化的

#### 发送窗口大小 ≤ 窗口总数 - 1

1. **避免帧序号重叠**：当发送窗口大小过大时，发送方可能在尚未收到之前发送帧的确认之前，就发送了带有相同序号的新帧。由于接收方已经处理了一个相同序号的旧帧，可能会错误地将新帧误认为是之前的重复帧。因此，通过限制发送窗口的大小，使得接收方总能区分旧帧和新帧

2. **确认机制的顺畅运行**：发送窗口需要控制发送的数据量，使接收方有足够的时间进行确认。窗口大小较小时，发送方必须等待接收方的确认，才能继续发送新的数据，确保数据传输的可靠性

3. **同步问题**：发送窗口的大小受限于帧序号空间的大小。如果发送窗口过大，会导致接收方和发送方失去同步，导致接收方无法正确识别每个数据帧的顺序，尤其是在确认信号未及时到达时

##### 举例说明

假设窗口总数为 8，那么帧序号的范围是 `0-7`。如果发送窗口的大小为 7（即窗口总数 - 1），则在最极端情况下，发送方可以连续发送 7 个帧，而接收方只要收到 7 个帧的确认信息即可

1. **初始状态**：发送方发送序号为 `0, 1, 2, 3, 4, 5, 6` 的帧，接收方收到并处理这些帧，并发送确认
2. **帧序号回绕**：一旦发送方发送了第 `7` 个帧，窗口滑动后，帧序号回到 `0`，但此时接收方知道前一个 `0` 序号帧已经确认，因此不会混淆

如果发送窗口的大小为 8（等于窗口总数），则会产生同步问题，因为接收方可能无法区分当前接收到的帧是新的帧还是之前已经确认过的帧，从而导致数据传输的错误

### 停止 - 等待协议 (单帧滑动窗口)

#### 原理

- 发送方在发送每个数据帧后，必须等待确认
- 接收方的确认帧（ACK）到达发送方后，发送方才能发送下一个数据帧
- 相当于 $W_T = 1 = W_R = 1$

#### 过程

![](./images/Pasted%20image%2020240918194634.png)

1. **发送方**发送一个数据帧，并设置**超时计时器**
2. **接收方**收到数据帧后，进行差错检测：
   - 无误码，接收并发送确认帧（ACK）
   - 有误码丢弃并发送否认帧（NAK）。发送方收到 NAK 后，重发误码的数据分组
3. 发送方收到确认帧（ACK）后，停止计时器，准备发送下一个数据帧
4. 如果发送方在所设置的**超时重传时间（RTO）**内未收到确认帧，将重传数据帧

> **异常情况处理**
>
> - **数据帧丢失或出错**：发送方在所设置的**超时重传时间（RTO）** 内未收到确认帧，将重传数据帧
> - **数据帧正确，但确认帧丢失或出错**：
>   - 发送方重传已经发送并被接收的数据帧
>   - 接收方收到重复的数据帧后，将丢弃该帧，并重传一个确认帧（ACK）

#### 细节

![](./images/Pasted%20image%2020240907175542.png)

- 超时计时器设置的重传时间（RTO）应当比平均 RTT 长一些
- 发送的帧交替使用 0、1 进行标识，确认帧用 ACK0 和 ACK1 表示，仅需**1bit**进行编号
- DATA 和 ACK 都需要编号，以区分不同的帧，两组使用的比特数量相同
- 连续出现**相同序号**的确认帧时，表明接收端收到了重复帧
- 为了**超时重发和判定重复帧**的需要，发送方和接收方都须设置一个帧缓冲区
- **发送端在发送完数据帧时，在缓存中保留此数据帧的副本**，出差错时重传，收到确认帧时清除副本
- 使用超时重传机制后，可以不使用否认机制（可以简化实现）。但是如果是点对点链路的误码率很高，使用否认机制可以使发送方在超时计时器超时前尽快重传
- 数据链路层一般不会出现分组迟到的情况，因此数据链路层的停止等待协议可以不用给确认分组编号
- 一般将 RTO 设置为略大于双方的平均往返时间 RTT

#### 🌟信道利用率

- 信道实际用于数据传输的时间与信道可用总时间的比例
![](./images/Pasted%20image%2020241021224123.png)

![](./images/Pasted%20image%2020241021224146.png)
![](./images/Pasted%20image%2020241021223851.png)

- 出现超时重传，对于传送有用的数据信息来说，信道利用率还要降低
- 往返时间 RTT 较大的情况下，为了提高信道利用率，不适合使用 停止等待协议，可以选择 GBN 和 SR 协议

$$信道吞吐率 = 信道利用率 × 发送方的发送速率$$

- **优点**: 实现简单，确保每个数据帧被正确接收
- **缺点**: 等待确认期间信道空闲，信道利用率低，适合低速率传输

### 后退 N 帧协议 (GBN) (多帧滑动窗口)

#### 原理

![](./images/Pasted%20image%2020240907175607.png)

后退 N 帧协议 (GBN) 是一种多帧滑动窗口协议，允许发送方在未收到接收方确认的情况下，连续发送多个数据帧

- **发送窗口 (WT)**

  - 发送方维护的一个窗口，在未收到接收方确认分组的情况下，发送方可以将序号落在 WT 内的所有数据分组连续发送出去
  - 若帧编号使用 n 比特，则发送窗口的尺寸范围是 $1 \le W_T \leq 2^n - 1$
  - 特例：WT = 1 时，协议退化为停止 - 等待协议

- **接收窗口 (WR)**

  - 接收方维护的一个窗口，只有正确到达接收方（无误码）且序号落在 WR 内的数据分组才被接收
  - WR 的大小固定为 1，与停止等待协议相同，保证数据帧按序接收

- **窗口滑动**

  - 若接收到确认帧，则窗口滑动
  - 若某个数据帧出错，发送方从出错帧开始重传

#### 异常情况处理

- **超时重传**

  - **场景**：如果在计时器超时后，发送方发现之前发送的某个帧及其后续的 n 个帧没有收到确认信息，这表明该帧可能出错或丢失
  - **处理**：发送方将重传该出错或丢失的帧及其后的 n 个帧

- **失序处理**

  - **场景**：接收方检测到信息帧失序（收到的帧不是期待的下一个帧）
  - **处理**：要求发送方从最后一个正确接收的帧之后开始重发所有未被确认的信息帧

#### 流程

![](./images/Pasted%20image%2020240907175612.png)

1. **发送数据**

   - 发送方连续发送窗口大小内的数据帧，每发送一帧都设置超时计时器等待 ACK
   - 若接收到的帧超出期望序号，则丢弃，并重新发送最后一个 ACK

2. **接收数据**

   - 接收方接收数据帧并按序处理，发送 ACK 确认最后一个按序到达的帧（" 累积确认 "）
   - 接收方可以在连续收到好几个确认的数据帧后，才对最后一个数据帧发送确认信息，或者可在自己有数据要发时才对以前正确收到的帧 (" 捎带确认 ")

   - **累积确认**：接收方按序处理接收到的数据帧，并发送 ACK 来确认最后一个按序到达的帧。这意味着一个 ACK 可以确认多个数据帧
     - ACKn 表示已经收到了 n 号及以前所有帧，期待收到 n+1 号帧
   - **捎带确认**：接收方在有数据要发送时，可以顺带确认之前正确收到的帧

3. **滑动窗口**

   - 发送方收到 ACK 后，确认相应帧并滑动窗口，发送新数据帧

4. **超时重传**

   - 若定时器超时，发送方重传从第一个未确认帧开始的所有帧

![](./images/Pasted%20image%2020241021224326.png)

#### 信道利用率

$\eta = \frac{n \times T_D}{T_D + RTT + T_A}$

- $n$ 为周期 $T$ 内发送的帧的数量
- $T_D$ 为数据传输时间
- $RTT$ 为往返时间
- $T_A$ 为其他额外时间（如确认时间）

最大平均传输速率 $\frac{\text{可发送数据量}}{\text{数据帧的发送时延} + \text{信号的单向传播时延} \times 2}$

有效数据传输速率：$\frac{\text{帧长} - \text{帧头}、\text{帧尾} = \text{数据部分长度}}{T_D + RTT + T_A}$

- $\text{帧长}$ 为每帧的总长度
- $\text{帧头、帧尾的长度}$ 为每帧中非数据部分的长度

信道吞吐率：$\frac{n \times \text{帧长}}{T_D + RTT + T_A}$，其中 $n$ 为周期 $T$ 内发送的帧的数量

- $n$ 为周期 $T$ 内发送的帧的数量
- $\text{帧长}$ 为每帧的总长度
- $T_D$ 为数据传输时间
- $RTT$ 为往返时间
- $T_A$ 为其他额外时间（如确认时间）
为其他额外时间（如确认时间）

#### 小结

- **优点**

  - 提高了信道利用率；简化了接收方的处理逻辑

- **缺点**

  - 出错时重传数据量较大，效率下降
  - 若信道的传输质量很差导致误码率较大时，后退 N 帧协议不一定优于停等协议

![](./images/Pasted%20image%2020241021224637.png)

![](./images/Pasted%20image%2020241021224617.png)

### 选择重传协议（SR）

#### 原理

选择重传协议（SR）允许发送方连续发送窗口大小内的数据帧，而接收方可以按序接收和确认这些帧。与后退 N 帧协议（GBN）不同，SR 协议在处理出错的帧时更加高效

- **发送窗口 (WT)** 和 **接收窗口 (WR)**

  - $W_T > 1$，$W_R > 1$：这允许双方同时管理多个帧的发送和接收
  - 若采用 n 比特对帧编号，则发送窗口和接收窗口满足：$W_T + W_R \leq 2^n$
  - 通常发送窗口和接收窗口的大小相同，都为 $2^{n-1}$

#### 流程

![](./images/Pasted%20image%2020240907175657.png)

1. **发送数据**

   - 发送方发送窗口内的数据帧，每个帧对应一个发送缓冲区，同时设置计时器

2. **接收数据**

   - 接收方接收数据帧，发送确认帧（逐一确认）
   - 接收方会接收序号不连续但在接收窗口范围内的帧

3. **帧出错处理**

   - 若某个数据帧出错，接收方发送一个否定帧 NAK，请求重传该帧

4. **滑动窗口**

   - 发送方收到 ACK 后，确认相应帧并滑动窗口，发送新数据帧
   - 若定时器超时，发送方仅重传未确认的帧

选择重传协议需要在接收端设置具有相当容量的缓冲区来暂存那些未按序正确收到的帧。
接收端不能接收窗口范围以外的序号的帧，所需缓冲区的数量等于窗口的大小。

#### 异常处理

- **帧出错**：接收方通过发送否定确认帧（NAK）来请求重传出错的帧
- **超时重传**：发送方仅重传未收到确认而超时的数据帧，而不是整个窗口内的所有帧

#### 小结

![](./images/Pasted%20image%2020241021224513.png)

- **GBN** 采用 " 累计确认 "，**SR** 采用 " 逐一确认 "
- 选择重传协议（SR）适用于错误率较高的网络环境，其中单独重传出错的帧比重传整个窗口的帧更为高效

- **优点**

  - **效率高**：仅重传出错的帧，而不是整个窗口的帧，这提高了带宽的利用率
  - **灵活性**：接收方可以接收和确认非顺序到达的帧，增加了协议的灵活性和效率

#### 例题

![](./images/Pasted%20image%2020241021224449.png)

### 小结

![](./images/Pasted%20image%2020241021224352.png)
![](./images/Pasted%20image%2020240915130722.png)

### 信道利用率

信道利用率通常指发送数据所需要的时间占整个发送周期/传输周期的比率

发送方的有效传输速率通常指实际信道中单位时间内发送的数据量。
若发送方的发送速率为 $v$ b/s，信道利用率为 $U$，则有效传输速率可以表示成 $v_e = U \times v$

#### 公式

- **信道利用率**：

  $$
  U = \frac{\text{发送数据的时间}}{\text{一个发送周期的总时间}}
  $$

- **有效传输速率**：

  $$
  v_e = \frac{\text{一个发送周期发送的数据量}}{\text{一个发送周期的总时间}}
  $$

> [! ] 发送周期/传输周期
> 指从发送一帧开始到收到对该帧的确认所经历的时间
> 一般情况下，发送周期 = 发送数据帧的时间 + 一个 RTT + 发送确认帧的时间

- $T_d$ 表示一帧的发送时间
- $T_a$ 表示确认帧的发送时间
- RTT 表示往返传播时延
- $n$ 表示发送窗口的大小

#### 停止 - 等待协议的信道利用率

$$
U = \frac{T_d}{T_d + RTT + T_a}
$$

#### GBN 与 SR 协议的信道利用率

> 当 $nT_d < T_d + T_a + RTT$，即在一个发送周期内可以发送完 $n$ 帧时：

   $$
   U = \frac{nT_d}{T_d + RTT + T_a}
   $$

> 当 $nT_d \geq T_d + T_a + RTT$，即在一个发送周期内发送不完 $n$ 帧时, $U$ 可以达到最大值 1

## 介质访问控制

介质访问控制（MAC）是一种机制，用于协调多个网络设备在共享通信介质（如以太网、无线网络）上的数据传输，防止数据帧在传输过程中发生碰撞和干扰

- **点对点链路**：不需要介质访问控制
- **广播式链路**：需要介质访问控制

### 信道访问控制（静态划分）

将使用介质的每个设备与来自同一通信信道上的其他设备的通信隔离开来，把**时域**和**频域**资源合理地分配给网络上的设备

#### 多路复用

当传输介质的带宽大于单个信号的带宽需求时，可以通过**多路复用**技术在一条介质上同时传输多个信号，从而提高传输系统的利用率。多路复用技术通过整合多个输入通道的信息，在接收端将其分离并传送到对应的输出通道。

- **共享通信资源**

![多路复用](./images/Pasted%20image%2020240919165018.png)

信道划分的实质就是**把广播信道逻辑上转变为点对点信道**

##### 频分多路复用（FDM）类 " 并行 "，共享时间，不共享空间

![](./images/Pasted%20image%2020240919165040.png)

- **原理**：
  - 将可用频谱划分为多个频带，每个用户在不同的频带上通信。
  - 各个频带间需留出保护带防止相邻信道干扰。
  - 多个用户可以**并行**通信，但每个用户在**独立频带**上操作。

- **优点**：传输效率高、技术成熟，常用于模拟信号。
- **缺点**：仅适用于模拟信号传输，无法直接用于数字信号。

##### 时分多路复用（TDM） 类 " 并发 "，共享空间吗，不共享时间

![](./images/Pasted%20image%2020240919165049.png)
![](./images/Pasted%20image%2020240919165115.png)

- **原理**：将时间划分为若干时隙，每个用户在自己的时隙内独占信道进行通信。
  - 某个时刻来看：时分多路复用信道上传送的仅是某一对设备之间的信号
  - 某段时间来看：传送的是按时间分割的多路复用信号

- **特点**：
  - 用户在特定时隙内独占信道，需要时隙同步机制
  - TDM 帧是在**物理层**传送的比特流所划分的帧，标志一个周期（并非数据链路层）

##### 统计时分多路复用（STDM，又称异步时分多路复用）

 ![](./images/Pasted%20image%2020240919165131.png)

- **原理**：TDM 的一种改进，采用 STDM 帧，**按需动态地分配时隙**，当终端有数据要传送时，才会分配到时间片，因此可以提高线路的利用率；会在帧头添加信息表示自己是谁发过来的

- **缺点**：信道利用率可能低，适用于数字信号

##### 波分多路复用（WDM）【共享时间，不共享空间】

- **原理**：在一根光纤中传输多种不同波长的光信号，各路光信号互不干扰

![](./images/Pasted%20image%2020240919165148.png)

> [! ] 光的频分复用
> 在一根光纤中传输多种不同波长（频率）的光信号
> 由于波长（频率）不同，各路光信号互不干扰
> 最后再用波长分解复用器将各路波长分解出来

##### 码分多路复用（CDM）【同时共享了时间和空间】

- 每个用户被分配一个唯一的 **地址码**，用于识别其传输信号。
- 所有用户在 **同一频带** 上同时通信，不同用户的信号通过不同的码来区分。
- 每个比特时间划分为多个短的时间槽，称为 **码片**，各用户的码片序列相互正交，确保不同用户的信号不会互相干扰。

1. **码片序列正交**：
   - 分配给每个站点的码片序列必须各不相同。
   - 每个码片序列是 **正交的**，即两个不同用户的码片序列的内积为 0。

   $$A \cdot B = \frac{1}{m} A_{i}B_{i} = 0$$

2. **m 值**：
   - 码片序列的长度通常是 64 或 128 位。
   - 每个站点分配一个 **m 位的码片序列**，用于发送信息。

3. **信号传输**：
   - 发送 **1** 时，站点发送其码片序列。【*和自己内积为 1，和其他内积为 0*】
   - 发送 **0** 时，站点发送该码片序列的反码。【*和反码内积为 -1，和其他内积为 0*】
   - 多个站点同时发送时，信号在信道中以线性方式相加。

    $$ A \cdot B = \frac{1}{m} \sum_{i} A_{i} B_{i} = 0 \quad \quad A \cdot \bar{B} = \frac{1}{m} \sum_{i} A_{i} \bar{B_{i}} = 0 $$

    $$ A \cdot A = \frac{1}{m} \sum_{i} A_{i}^2 = 1 \quad \quad A \cdot \bar{A} = - \frac{1}{m} \sum_{i} (A_{i}^2) = -1 $$

4. **信号接收与解码**：
   - 在接收端，接收器使用站点的码片序列对接收到的信号进行 **规格化内积** 计算：
     - 内积结果为 **1**，表示发送了 1。
     - 内积结果为 **-1**，表示发送了 0。
     - 内积结果为 **0**，表示该站点未发送信号。

- **频谱利用率高**：多用户可以同时共享频带资源。
- **抗干扰能力强**：由于正交码片序列的设计，不同用户间的干扰可以被有效抵消。
- **保密性强**：每个用户使用不同的码片序列，提升了信号的保密性。
- **适用于无线通信**：尤其是 **移动通信系统** 中，CDM 被广泛应用。

![](./images/Pasted%20image%2020241021211958.png)
![](./src/images/Pasted%20image%2020241016122217.png)

### 随机访问控制（争用型协议）

- 在随机访问协议（争用型协议）中，用户能根据自己的意愿随机地发送信息，占用信道全部速率
- 在总线形网络中，当有两个或多个用户同时发送信息时，就会产生帧的冲突，导致所有冲突用户的发送均以失败告终
- 为了解决随机接入发生的碰撞，每个用户需要按照一定的规则反复地重传它的帧，直到该帧无碰撞地通过
- 采用随机访问控制机制，各节点之间的通信就可既不共享时间，也不共享空间
- 随机介质访问控制实质上是一种**将广播信道转化为点到点信道**的行为

#### ALOHA 协议

##### 纯 ALOHA 协议（想发就发，不听就说）

![](./images/Pasted%20image%2020240915154151.png)

- **特点**：节点在任意时刻可以发送数据帧。
- 如果数据帧在传输过程中发生冲突（即两个或多个节点同时发送数据），不予确认，发送方在一定时间内收不到就判断发生冲突，超时后等一随机事件再重传
- **吞吐量**：
  - 假设网络负载为 G，则纯 ALOHA 网络的吞吐量为 $S = Ge^{-2G}$
- **网络负载**：T 时间内所有站点发送成功和因冲突未发送成功的帧数
- **网络的吞吐量**：T 时间内成功发送的平均帧数

- **优点**：实现简单，无需时隙同步，适用于突发性数据传输
- **缺点**：G=0.5 时，纯 ALOHA 的理论信道利用率为**18.4%**，信道利用率低，冲突概率高

##### 时隙 ALOHA 协议【约束下，想发就发】

![](./images/Pasted%20image%2020240915154200.png)

- **特点**：时间被划分为等长的时隙，节点只能在时隙的开始发送数据帧，从而减少碰撞概率。时隙 T 的长度使得每个帧正好在一个时隙内发送完毕
- **吞吐量**：
  - 假设网络负载为 G，则时隙 ALOHA 网络的吞吐量为 $S = Ge^{-G}$
  - G=1 时，时隙 ALOHA 的理论信道利用率为**36.8%**，吞吐量比纯 ALOHA 协议大了一倍

#### CSMA 协议 （先听后说）

> [! ] 载波监听多路访问（Carrier Sense Multiple Access，CSMA 协议）

- 一种**基于竞争的介质访问控制协议**，设备发送数据前会监听信道状态，**只有信道空闲时**才会发送数据。

##### 1 - 坚持 CSMA（1-Persistent CSMA）【忙则一直监听，一有空闲立即发送数据】

- **原理**：
  - 设备在发送数据前**先监听信道**。
  - 如果信道**空闲**，**立即发送数据**。
  - 如果信道**忙**，则**持续监听**，直到信道变为空闲后立刻发送数据。

- **传播延迟对 1- 坚持 CSMA 协议的性能影响较大**：
  - A 节点发送时信道已经空闲，但其数据未及时传播到 B；
  - B 节点也检测到信道空闲，立刻发送，结果 A、B 的数据**发生冲突**。

- **优点**：信道利用率高，因为空闲信道被立即利用
- **缺点**：- 冲突概率较高，尤其在高流量时，频繁的重传会影响效率。

##### 非坚持 CSMA（Non-Persistent CSMA）【忙则等待一个随机时间再监听】

- **原理**：
  - 设备在发送数据前先**监听信道**。
  - 如果信道**空闲**，则**立即发送**。
  - 如果信道**忙**，设备会**等待一个随机时间**再重新监听。

- **优点**：减少了碰撞概率，避免了信道的过度占用
- **缺点**：由于随机等待，**平均传输延迟增加**。

##### p - 坚持 CSMA（p-Persistent CSMA）【不一定马上发，但一直在监听】

> 用于**时序信道**（如时隙信道）。

- **原理**：
  - 设备在发送数据前先**监听信道**。
  - 如果信道**空闲**，则**以概率 $p$ 发送数据**，以概率 $1−p$ 等待下一个时间单位再重新监听。
  - 如果信道**忙**，则**持续监听**，直到信道空闲后再按概率 $p$ 发送数据。

- **概率发送**：降低了 1- 坚持 CSMA 中**多个节点检测到空闲**时**同时发送数据**的冲突概率。

- **持续监听**：克服了非坚持 CSMA 中**随机等待**导致的传输延迟问题。

- **优点**：在**减少碰撞**和**提高信道利用率**之间取得了平衡。
- **缺点**：**实现较复杂**，需要合理选择概率 p

##### 小结

![](./images/Pasted%20image%2020240915130843.png)

> [! ] **冲突问题**：所有这三种 CSMA 协议**一旦发生冲突**，都只能等冲突后的**重传**来补救，没有及时的冲突检测机制（如 CSMA/CD 中的冲突检测）。

#### CSMA/CD 协议

> [! ] 载波监听多路访问/碰撞检测（CSMA/CD,Carrier Sense Multiple Access with Collision Detection）协议

- **适用范围**：<font color="#00b050">总线形网络或半双工网络环境，应用于使用有线连接的局域网（LAN）。</font>

> **半双工环境**：考虑 CSMA/CD 协议

> **全双工环境**：不考虑 CSMA/CD 协议

- 全双工采用两条信道，分别用于发送和接收数据
- 在任何时间双方都可以收发数据，不可能产生冲突，因此不需要 CSMA/CD 协议

##### 工作流程

> 先听后发，边听边发，冲突停发，随机重发

###### 帧发生流程

![](./images/Pasted%20image%2020240907175915.png)

1. **载波监听**：

   - 发送数据前检测信道是否空闲，若信道中有信号在传输则等待信道空闲时再发送数据（1- 坚持 CSMA）
   - 发送数据时要不停检测信道，以及时发现发送的数据是否发生了碰撞

   - 碰撞检测通过比较发送信号与监听到的信号来实现，如果不一致则发生碰撞

2. **多路访问**：多个站点连接到一条总线上，竞争使用总线

3. **碰撞检测**：适配器边发送边监听，如果监听到碰撞，立即停止数据发送

###### 帧接受流程

![](./images/Pasted%20image%2020240907175919.png)

##### 操作步骤

![](./images/Pasted%20image%2020240907175922.png)

1. **帧封装与准备发送**
    - 适配器接收网络层分组，封装为以太网帧，并存入适配器的缓存待发送

2. **信道检测与发送**
    - 使用 1- 坚持 CSMA 策略：
      - 如果信道空闲（96 比特时间内无信号），则发送帧
      - 如果信道忙，持续监测直至空闲

3. **发送过程中的碰撞检测**
    - **无碰撞**：顺利发送完成
    - **有碰撞**：
      - 立即停止发送，并广播拥塞信号
      - 适配器执行指数退避算法，随机等待后重试发送

4. **碰撞处理措施**(**以太网**采用**强化碰撞措施**)
    - 检测到碰撞后，除了停止当前发送外，额外发送 32 或 48 比特干扰信号，确保所有站点都能检测到碰撞，增强网络的健壮性

##### 争用期（冲突窗口、碰撞窗口）

争用期是指从一个节点开始发送数据到这个数据能够被网络上最远端的节点检测到的最长时间

这个时间段内，即使信道检测为空闲，也不能保证信道实际上是空闲的，因为可能存在尚未传播到检测点的数据
![](./images/Pasted%20image%2020240907175929.png)
当节点 A 发送数据后的τ时间内，如果节点 B 尝试发送数据，它会发现信道忙并等待，从而节点 A 可以在 2τ时间后确定是否发生了冲突
这段端到端往返时间 2τ被称为**争用期**

- 争用期：2τ = 最远两个端点往返传播时延，从发送帧后最多经过 2τ能知道有无碰撞

只有在争用期过后没有检测到碰撞，才能确认此次发送不会发生冲突
![](./images/Pasted%20image%2020241022102559.png)

##### 最小帧长

- **CSMA/CD 作用**
  - 在发送数据时检查到碰撞而停止发送，帧太短发完了才检查到碰撞，协议就没作用了

- 所以数据的发送时间应该大于等于争用期，得

  $$最小帧长 = 总线传播时延 \times 数据传输速率 \times 2 = 数据传输速率 \times 2 \tau $$

  - 收到帧长小于最小帧长时，把它当作无效帧立即丢弃
  - 发送帧长小于最短帧时，在数据字段后面增加填充字段填充若干字节
![](./images/Pasted%20image%2020241022102702.png)
- 以太网规定**最短帧长**为 64B,且 最小帧长=数据传输速率×2τ
- 凡长度小于 64B 的帧都是由于冲突而异常中止的无效帧，收到这种无效帧时应立即丢弃

  - 对于 10Mb/s 的共享总线以太网，取 51.2us 为争用期的长度，最小帧长 512bit，即 64B
  - 对于 100Mb/s 的共享总线以太网，取 5.12us 为争用期的长度，最小帧长 512bit，即 64B

- 以太网规定总线长度不能超过 2500m
![](./images/Pasted%20image%2020241022102724.png)

##### 截断二进制指数退避算法

![](./images/Pasted%20image%2020241022002957.png)

![](./images/Pasted%20image%2020241026110035.png)

1. 确定**基本退避时间**，一般取**争用期**：两倍的总线端到端传播时延 2τ

2. 定义参数 k，它等于重传次数，**但 k 不超过 10，即 k=min{重传次数, 10};**

3. 从集合 $[0,1,…, 2^k-1]$ 中随机取出一个数 r，重传所需要退避的时间就是 r 倍的基本退避时间，即

   $$\text{重传所需要退避的时间} = 2r\tau$$

4. 当**重传达 16 次仍不能成功**时，说明网络太拥挤，认为此帧永远无法正确发出，**抛弃此帧并向高层报告出错**

##### 信道利用率

**信道利用率**，即在给定的时间内，信道被有效使用的程度

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据
![](./images/Pasted%20image%2020241022003038.png)

- **碰撞检测**：当一个站点在发送数据帧时发生碰撞，它会在经历了一个或多个争用期（2τ）后重新尝试。每个争用期的发生都会延迟数据的成功传输
- **信道占用**：成功发送一个数据帧所需的时间包括帧的发送时间（$T_0$）和信道上的传播延迟（τ），即 $T_0 + τ$

##### 极限信道利用率 $S_{\text{max}}$

在理想情况下，我们考虑以下几点：

- **总线空闲即发送**：一旦总线空闲，就有某个站点立即发送帧
- **无碰撞**：所有站点发送的帧都不会发生碰撞
- **发送时间**：发送一帧占用总线的时间为 $T_0 + \tau$，其中帧本身的发送时间是 $T_0$

基于上述条件，我们可以得出极限信道利用率的表达式：

$$

S_{\text{max}} = \frac{T_0}{T_0 + \tau} = \frac{1}{1 + \frac{\tau}{T_0}} = \frac{1}{1 + a}

$$

其中，$a = \frac{\tau}{T_0}$ 表示发送一帧占用总线的时间与帧本身发送时间的比值

- **高信道利用率**：当 $a \rightarrow 0$，即碰撞可以立即被检测到并停止发送时，信道利用率很高
- **信道利用率下降**：随着 $a$ 值的增大，争用期占比增大，导致信道资源浪费更多，从而信道利用率降低

##### 以太网的设计原则

- **限制端到端距离**：以太网端到端的距离受到限制，以减少传播延迟
- **增加帧长度**：以太网帧的长度应尽量长，以提高数据传输效率
- **避免碰撞**：设计以太网时，应确保各主机发送帧不会产生碰撞
- **快速响应**：总线一旦空闲，就应有某个主机立即发送帧，以提高信道利用率

#### CSMA/CA 协议

> [! ] 载波监听多路访问/碰撞检测（CSMA/CA, Carrier Sense Multiple Access with Collision Avoidance）协议

> 为何**无线网络**使用 CSMA/CA 而不是 CSMA/CD：：

1. **信号强度衰减**：无线发送和接收信号的强度差距较大，难以实现边发边听。
2. **隐蔽站问题**：某些站点无法听到其他站点的信号，导致即使信道空闲检测也不能保证没有冲突。

> 802.11 标准定义应用于**无线局域网**的 CSMA/CA 协议，对 CSMA/CD 协议进行了修改，把碰撞检测改为**碰撞避免**

- **碰撞避免**
  - **目的**：降低网络碰撞的可能性，提高网络效率
  - **原理**：不使用碰撞检测，而是通过技术手段尽量避免碰撞的发生
  - **挑战**：无线信道的误码率较高，完全避免碰撞几乎不可能

- **数据链路层确认机制**
  - 由于不可能避免所有的碰撞，同时无线信道的误码率较高，
  - IEEE 802.11 标准采用了**停止 - 等待协议作**为数据链路层的确认机制

- **介质访问控制方式**

> 802.11 的 MAC 层定义了两种介质访问控制方式：

1. <font color="#00b050">分布式协调功能（DCF）</font>

   - **特点**：无中心控制，站点通过 CSMA/CA 协议争用发送权
   - **要求**：所有实现都必须支持 DCF
   - **关键参数**：短帧间间隔（SIFS）和分布协调功能帧间间隔（DIFS）

2. **点协调功能（PCF）**

   - 集中控制的接入算法（一般在接入点 AP 实现集中控制）。
   - 可选方式，实际中较少使用

##### 帧间间隔

![](./images/Pasted%20image%2020241022004344.png)

- **帧间间隔 IFS**：为了尽量避免碰撞，所有的站完成发送后，必须再等待一段很短的时间才能发送下一帧

> 帧间间隔的长短取决于该站要发送的帧的类型：

- **SIFS (Short Inter-Frame Space, 短 IFS，28 微秒)**：
  - 这是最短的 IFS，用于分隔属于同一通信对话的连续帧，如确认帧（ACK）、准备发送帧（RTS）、清除发送帧（CTS）等
- **PIFS (PCF Inter-Frame Space, 点协调 IFS)**：
  - 这是中等长度的 IFS，主要在点协调功能（PCF）操作中使用
- **DIFS (Distributed Coordination Function Inter-Frame Space, 分布式协调 IFS，128 微秒)**：
  - 这是最长的 IFS，用于异步帧的竞争访问，以确保网络中可能存在的其他站点有机会发送具有更高优先级的帧

> [! ] 总时间为发送数据帧 DATA 的时间 +SIFS 时间 + 发送确认帧 ACK 的时间，该值记录在数据帧的首部

> 特殊帧类型

- **RTS (Request To Send, 请求发送控制帧)**：在发送数据前，发送站点先发送一个 RTS 帧，以减少碰撞的可能性
- **CTS (Clear To Send, 允许发送控制帧)**：接收站点在收到 RTS 后，回复 CTS 帧，表示可以开始发送数据帧
- **帧较短时一般不使用 RTS/CTS**，因为 RTS/CTS 帧增加了额外的开销。

##### 工作原理

![](./images/Pasted%20image%2020241022004344.png)

1. 若站点最初有数据要发送，且检测到信道空闲，在等待时间 DIFS 后，就发送整个数据帧

2. 否则，站点执行 CSMA/CA 退避算法，选取一个随机回退值。检测到信道忙时，退避计时器就保持不变；只有信道空闲，且在时间间隔 DIFS 内均空闲，则开始争用信道，退避计时器进行倒计时；当退避计时器减到 0 时，这时信道只可能是空闲的，站点就发送整个帧并等待确认

3. 发送站若收到确认，就知道已发送的帧被目的站正确接收，否则超时重传从步骤 2 开始，直到被确认或失败太多被抛弃。要发送第二帧，也要从步骤 2 开始帧间间隔 IFS：为了尽量避免碰撞，所有的站完成发送后，必须再等待一段很短的时间才能发送下一帧

##### 隐蔽站问题

![](./images/Pasted%20image%2020240915130952.png)
![](./images/Pasted%20image%2020240907180008.png)
![](./images/Pasted%20image%2020240907180010.png)

- **隐蔽站问题**：站 A 和 B 虽然都在 AP 的信号覆盖范围内，但彼此间的信号无法检测。当 A 和 B 同时检测到信道空闲时，会同时发送数据给 AP，导致碰撞。

- **RTS 请求**：发送站在发送数据前，先发送一个 **RTS（Request to Send）** 控制帧，包含源地址、目标地址及这次通信（含相应的确认帧）所持续的时间，该帧能被其范围内包括 AP 在内的所有站点听到

- **CTS 响应**：AP 在确认信道空闲后，发送 **CTS（Clear to Send）** 帧 (包括这次通信所需的持续时间)，授予发送权限，并通知其他站点避免在此期间发送数据。

- **CTS 帧有两个目的**：
  1. 给源站明确的发送许可
  2. 指示其他站点在预约期内不要发送数据

- 使用 RTS 和 CTS 帧会使网络效率有所下降，但这两种帧都很短，与数据帧相比开销不算大
- 若不使用这种控制帧，一旦发生碰撞而导致数据帧重发，则浪费的时间更多

![](./images/Pasted%20image%2020241026105926.png)
![](./images/Pasted%20image%2020241026105920.png)

##### 小结

CSMA/CA 的退避算法与 CSMA/CD 的主要区别在于处理信道从忙态变为空闲态的方式

在 CSMA/CA 中，站点不仅需要等待一个时间间隔，还需要进入一个争用窗口 $([0，CW])$ 来计算随机退避时间，这有助于降低碰撞的发生概率。具体使用退避算法的情况包括：

1. 在发送第一个帧前，如果检测到信道忙
2. 每次需要重传帧时
3. 每次成功发送帧后，准备发送下一帧时

此外，CSMA/CA 通过虚拟载波监听机制，允许站点通过监听数据帧、RTS 帧或 CTS 帧来预知信道将被占用的持续时间，而无需直接监听信道上的信号。这种机制有助于减少由隐蔽站问题引起的碰撞

> 相同点

CSMA/CD 和 CSMA/CA 都遵循 CSMA 的基本原则——**先听再说**。即在尝试接入信道之前，两者都需要先进行监听，只有在信道空闲时才能进行数据传输

> 差异

| 特性  | CSMA/CD | CSMA/CA  |
| --------- | ------------------------- | -------------------------------- |
| 冲突<br/>处理 | 可以检测冲突，但无法避免  | 不能边发边检查，尽量避免冲突 |
| 传输<br/>介质 | 用于总线型以太网【有线】| 用于无线局域网 802.11a/b/g/n 等【无线】|
| 检测<br/>方式 | 通过电缆中的电压变化来检测 | 采用能量检测、载波检测、能量载波混合检测三种方式|
| 基本<br/>思想 | 发送前侦听，边发送边侦听，一旦出现碰撞马上停止发送 | 发送数据时先广播告知其他结点，让其他结点在某段时间内不要发送数据 |

### 轮询访问控制【适用于负载过重的网络】

#### 令牌传递协议

- 在轮询访问中，通过一个集中控制的监控站以循环方式轮询每个节点来分配信道资源。
- 轮询机制保证某个节点在使用信道时，其他节点无法使用信道。
- **典型的协议：** 令牌传递协议，主要用于**令牌环（Token Ring）局域网**中。

#### 令牌传递协议过程

![](./images/Pasted%20image%2020241026103101.png)

> **逻辑结构为环形结构**：主控站与各从属节点通过环网相连。

> 令牌本质上是一个 **轻量级 MAC 控制帧**，用于管理信道访问权限，防止冲突。

1. **网络空闲时：**
   - 令牌帧在环路中循环传递，确保每个节点都有机会获得访问信道的权利。

2. **持有令牌的节点：【只有获得令牌的站才有权发送数据】**
   - 持有令牌的设备检查是否有数据需要发送。如果有，则将数据附加到令牌上，将其转换为数据帧，并发送出去。

3. **数据传输：**
   - 数据帧沿着环路传输，每个接收节点查看数据帧的**目的地址**。
   - 如果目的地址与当前节点的地址匹配，则该节点复制该帧，并继续将其转发到下一个节点。

4. **数据返回：**
   - 当数据帧回到源站点时，源站点确认数据是否被正确接收。
   - 如果无误，源站丢弃该数据帧，并生成新的空令牌，传递给下一个节点，释放信道。

#### 网络拓扑与特性

- **逻辑拓扑：** 在令牌传递协议中，**逻辑拓扑**总是一个**环形结构**。即使物理连接可能是**星型**或其他拓扑，数据传递在逻辑上仍表现为一个环。
- **适用场景：**
  - 适合**高负载广播信道**（即多个节点可能频繁发送数据）。
  - 避免碰撞：因为每次只有持有令牌的节点可以发送数据，所以不会发生冲突。

#### 令牌传递协议的局限与问题

1. **令牌开销：**
   - 令牌在环路中传递会占用一定的带宽资源，降低了网络的整体效率。

2. **等待延迟：**
   - 一个节点必须等待令牌传递到自己时才能发送数据，这种**轮询机制**会增加传输延迟，特别是在节点较多时。

3. **单点故障：**
   - 如果**令牌丢失**或节点发生故障，整个网络可能陷入瘫痪，需要特殊机制（如令牌恢复协议）来重建令牌。

### 小结

| 控制<br>方式 | 信道访问的控制方式<br>（多路复用技术）         | 随机访问控制<br>（随机发送、可独占）                       | 轮询访问控制<br>（基于载波检测网络）                          |
| -------- | ----------------------------- | ------------------------------------------ | --------------------------------------------- |
| 特点       | 不会产生冲突                        | 独占信道，每次只有一个节点能发送数据                         | 结合了**多路复用**和**随机访问**的优点<br>**无冲突**且**独占**信道使用 |
| 适用<br>场景 | 网络负载高                         | 网络负载低                                      | 需要控制信道使用顺序的网络环境                               |
| 优点       | - 传输速率高<br>- 延迟小<br>- 性能良好且公平 | - 轻载时可充分利用全部带宽                             | -                                             |
| 缺点       | - 设备成本高<br>- 资源利用效率低          | - 容易发生数据包碰撞<br>- 碰撞导致传输速率降低<br>- 争抢信道时效率较低 | -                                             |

## 局域网（LAN）

![](./images/Pasted%20image%2020240907180043.png)

### 局域网的基本概念与体系结构

- 局域网（LAN）覆盖**较小地理范围**（如办公室、建筑物、校园等）
- 通过**双绞线、同轴电缆**等连接介质，将计算机和其他网络设备连接起来
- 提供**高数据传输速率和低延迟**的通信服务

#### 局域网的介质访问控制方法

局域网（LAN）的介质访问控制方法主要包括**CSMA/CD**、**令牌总线**和**令牌环**，不同的网络类型使用不同的控制方式和拓扑结构

![](./images/Pasted%20image%2020240918194716.png)

1. **CSMA/CD（载波监听多路访问/碰撞检测）**：
    - **应用**：主要用于**总线形局域网**，典型代表是**以太网**
    - **原理**：所有站点在发送数据前先监听信道。如果信道空闲，站点可以发送数据；如果检测到碰撞，站点会停止发送并等待一段随机时间再重试

2. **令牌总线**：
    - **应用**：也用于**总线形局域网**
    - **原理**：站点通过接收到的令牌来获得发送数据的权限。只有持有令牌的站点才能发送数据。令牌在站点之间按顺序传递

3. **令牌环**：
    - **应用**：主要用于**环形局域网**
    - **原理**：和令牌总线类似，但采用环形拓扑，令牌沿着环在各站点之间传递，持有令牌的站点可以发送数据

#### 局域网的具体应用

1. **以太网**：
    - **逻辑拓扑**：总线形逻辑拓扑（所有设备共享一条逻辑总线）
    - **物理拓扑**：物理上通常是**星形**或**扩展星形**拓扑，中心为交换机或集线器
    - **协议**：使用**CSMA/CD**作为访问控制机制，是目前应用最广泛的局域网标准

2. **令牌环**（Token Ring，IEEE 802.5）：
    - **逻辑拓扑**：环形逻辑拓扑（数据沿环传递）
    - **物理拓扑**：通常是**星形物理拓扑**，实际连接通过中心的 MAU（多站访问单元）
    - **协议**：使用令牌控制访问，防止碰撞

3. **FDDI**（光纤分布式数据接口，IEEE 802.8）：
    - **逻辑拓扑**：环形拓扑，采用双环设计以增加可靠性
    - **物理拓扑**：双环物理拓扑，常用于光纤网络传输
**物理拓扑**：双环物理拓扑，常用于光纤网络传输​​

#### 特点

- **单一单位管理**：局域网通常为一个组织或单位所有，地理范围有限
- **高带宽共享**：所有站点共享一个高带宽的通道，带宽效率高
- **低时延、低误码率**：局域网内部的时延较低，传输可靠性高
- **平等站点**：各站点地位平等，不存在主从关系
- **支持广播和组播**：局域网能够有效地进行广播和组播通信​​

#### IEEE 802 标准

- 定义的局域网参考模型只对应于 OSI 参考模型的数据链路层和物理层

IEEE 802 委员会是专门指定局域网和城域网标准的机构，它为不同规格的局域网制定了一系列标准：

1. **IEEE 802.3**: 对应了以太网
2. **IEEE 802.4**: 对应了令牌总线网
3. **IEEE 802.5**: 对应了令牌环网
4. **IEEE 802.8**: 对应了 FDDI（光纤分布式数据接口）
5. **IEEE 802.11**: 对应了无线局域网

| 标准编号     | 名称         | 逻辑拓扑   | 物理拓扑     | 介质访问控制协议 |
|-------------|--------------|------------|--------------|------------------|
| IEEE 802.3  | 以太网       | 总线型     | 星形/拓展星形 | CSMA/CD 协议     |
| IEEE 802.4  | 令牌总线网   | 环形       | 总线型       | 令牌总线协议     |
| IEEE 802.5  | 令牌环网     | 环形       | 星形         | 令牌环协议       |
| IEEE 802.6  | FDDI         | 环形       | 双环形       | 定时令牌协议     |
| IEEE 802.11 | 无线局域网 (WLAN)   | 星形       | 星形         | CSMA/CA 协议     |

#### 媒体接入控制（MAC）子层

- 与传输媒体有关，提供对物理层的统一访问接口，处理与物理层相关的事务，如组帧和拆卸帧、比特传输差错检测、透明传输
![](./images/Pasted%20image%2020240915131811.png)

#### 逻辑链路控制（LLC）子层

![](./images/Pasted%20image%2020240915131642.png)
![](./images/Pasted%20image%2020240928194019.png)

> **注意：** 由于以太网在局域网取得了垄断地位，现在许多网卡仅装有 MAC 协议而没有 LLC 协议

### 以太网与 IEEE 802.3

- **IEEE 802.3 标准**：定义了一种基带总线形的局域网技术，涵盖物理层和数据链路层的 MAC 子层
- **以太网拓扑结构**：逻辑上采用总线形结构，所有计算机共享同一条总线
- **通信方式**：信息通过**广播**方式发送，采用**CSMA/CD**协议进行通信
- **以太网标准**：DIX Ethernet V2 是一种局域网标准，与 IEEE 802.3 存在细微差别，但通常将 802.3 局域网也简称为以太网
- **通信特点**：在没有交换机的总线以太网中，任一结点发送的消息可以被网络上所有结点接收

#### 以太网的通信简化措施

- **无连接工作方式**：
  - 发送的数据帧不进行编号，接收方不需要发送确认，这是一种**不可靠的传输方式**
  - 差错的纠正交由上层协议处理
- **曼彻斯特编码**：
  - 通过在每个码元中间进行一次电压转换来同步信号，简化了信号的接收和解码过程

#### 以太网标准

![](./images/Pasted%20image%2020240907180050.png)

- **速率**：数字 `10` 表示网络的速率为 10Mbit/s
- **基带以太网**：`BASE` 指的是基带信号传输，即整个带宽被单一信号占用
- **最大传输距离**：`5` 或 `2` 分别表示单段最大传输距离为 500 米或 185 米
- **传输介质**：
  - `T` 代表使用双绞线（Twisted Pair）作为传输介质
  - `F` 代表使用光纤（Fiber）作为传输介质
  - `FL` 代表 "FiberLink"，即光纤链路，是 10BASE-F 系列中的一种
- **10BASE-FL**：属于 10BASE-F 系列，使用光纤作为传输介质，适用于较长距离的网络连接
- **10BASE-T**：通过连接集线器，可以在逻辑上构建成一个总线网络，所有节点共享同一冲突域

#### 传输介质

![](./images/Pasted%20image%2020241022003224.png)

- 粗缆、细缆、双绞线和光纤
- 参数解释：
  - `10` 指速率为 10Mbit/s，`BASE` 指基带以太网
  - `BASE` 后的 `5` 或 `2` 指单段最大传输距离不超过 500m 或 185m
  - `BASE` 后的 `T` 指双绞线，`F` 指光纤，`FL` 代表 "Fiber Link"（光纤链路），10BASE-FL 是 10BASE-F 系列中的一种

#### 网卡

- **网络接口卡（Network Interface Card, NIC）**，又称网卡、网络适配器，是连接计算机和网络的硬件设备
- 网卡装有处理器和存储器，负责将计算机的数据转换为网络可以传输的格式，并通过物理介质传输到网络中

#### 功能

- **数据的串并行转换**：
  - 网卡和局域网的通信是通过电缆或双绞线以串行方式进行
  - 网卡和计算机通信是通过计算机主板上的 I/O 总线以并行方式进行
- **数据封装和解封装**：将数据封装成帧进行传输，并解封装接收到的数据
- **数据传输**：通过物理介质发送和接收数据
- **介质访问控制**：控制对共享介质的访问，避免冲突
- **数据缓冲**：缓存发送和接收的数据，以便处理速度不一致时进行协调
- **网络协议支持**：支持网络层和数据链路层的协议，如以太网协议（IEEE 802.3）和 Wi-Fi 协议（IEEE 802.11）

![](./images/Pasted%20image%2020240915131847.png)

#### 介质访问控制 MAC 地址

- 每块网卡在出厂时都有唯一的代码，用于控制主机在网络上的数据通信
- 数据链路层设备如网桥和交换机，使用各个网卡的 MAC 地址

#### 三类 MAC 地址

1. **单播 MAC 地址**：第一个字节最低位为 0 的 MAC 地址，如 `80-80-90-36-25-D4`，用于**一对一通信**
2. **组播 MAC 地址**：第一个字节最低位为 1 的 MAC 地址，如 `81-80-90-36-25-D4`，用于**一对多通信**
3. **广播 MAC 地址**：所有位全为 1 的 MAC 地址，即 `FF-FF-FF-FF-FF-FF`，用于**一对全体通信**

#### 以太网的 MAC 帧

![](./images/Pasted%20image%2020240907180057.png)

- **定义**：也称物理地址，长 6 字节（48bit），一般用由连字符或冒号分隔的 12 个十六进制数表示，如 `02-60-8c-e4-b1-21`
  - **高 24 位**：厂商代码
  - **低 24 位**：厂商自行分配的网卡序列号
- **多个地址**：如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个 " 地址 "。这种 48 位 " 地址 " 应当是某个接口的标识符
- **广播通信**：网卡每收到一个 MAC 帧，先检查

##### 以太网 MAC 帧格式

- **两种标准**：DIX Ethernet V2 标准和 IEEE 802.3 标准

- **前导码**
  - 用于使接收端与发送端时钟同步
  - 前导码的 8 字节可再分为两个字段：
    - **前同步码**：7 字节，用来快速实现 MAC 帧的比特同步
    - **帧开始定界符**：1 字节，表示后面的信息就是 MAC 帧

- **地址**：目的地址在前，源地址在后，各占 6 字节

- **数据**：46-1500 字节，包含高层的协议消息
  - 由于 CSMA/CD 算法的限制，以太网帧必须满足最小长度要求 64 字节，数据较少时必须加以填充 (0~46 字节)

- **校验码 (FCS)**
  - 4 字节
  - 校验范围从目的地址段到数据段的末尾，算法采用 32 位循环冗余码 (CRC)
  - 不但需要检验 MAC 帧的数据部分，还要检验目的地址、源地址和类型字段，但**不校验前导码**

> IEEE 802.3 帧格式与 DIX 以太帧格式的不同之处在于用长度域替代了 DIX 帧中的类型域，指出数据域的长度

##### V2 标准 MAC 帧格式

![](./images/Pasted%20image%2020240907180102.png)

- MAC 帧 = $\underbrace{\text{目的地址}}_{6B} + \underbrace{\text{源地址}}_{6B} + \underbrace{\text{类型}}_{2B} + \underbrace{\text{数据(IP 数据报)}}_{范围在 46 \sim 1500 B} + \underbrace{\text{FCS (32 位 CRC 校验)}}_{4B}$

> [! ] 当数据部分小于 46 B 时需要填充字节

- 帧定界符大小为 8B

- **帧头部和尾部**

- **头部**：目的地址（6B）、源地址（6B）、类型（2B）
- **尾部**：校验码（4B FCS，32 位 CRC 校验）

- **前导码**:8 字节，分为两个部分：
  - **前同步码**：7 字节，用于实现 MAC 帧的比特同步
  - **帧开始定界符**：1 字节，标志着后面的内容是 MAC 帧的开始

> [! ] MAC 帧并不需要帧结束符，
> 因为以太网在传送帧时，各帧之间必须有一定的间隙，对于曼切斯特编码来说，停止传送是很明显的，因为传送一位时中间会有一次跳转，若没有跳转就知道没有传送，就知道帧结束了

- **地址**
  - 使用 6 字节的 MAC 地址表示目的地址和源地址

- **类型**
  - 2 字节，类型字段用来标志上一层使用的是什么协议，以便把收到的 MAC 帧的数据上交给上一层的这个协议
  - 对于 802.3 帧，这里是数据的长度

> [! ] 长度/类型机制共存
> 由于 IEEE 802.3 数据段最大字节数是 1500，所以前 1500 表示长度，1501~65535 用于类型段识别符

- **数据**
  - 46~1500 字节 (B)，包含高层的协议消息，少于 46 字节时会进行填充
  - 由于 CSMA/CD 算法的限制，以太网最短帧是 64 字节，头尾占了 18 字节，所以数据起码要 46 字节
  - 最大的 1500 字节是规定

- **校验码（FCS）**
  - 4 字节，采用 32 位循环冗余码进行校验，校验范围从目的地址到数据段的末尾，不包括前导码

##### 无效的 MAC 帧

- 数据字段的长度与长度字段的值不一致
- 帧的长度不是整数个字节
- 用收到的帧检验序列 FCS 查出有差错
- 数据字段的长度不在 46 ~ 1500 字节之间

> [! ] 接收方收到无效的 MAC 帧时，就简单将其丢弃，以太网的数据链路层没有重传机制。

#### 以太网的传输介质

以太网针对不同的传输介质给出了 4 种物理层标准，分别是 10Base5、10Base2、10Base-T、10Base-F。这些名称的含义如下：

1. **10**：数据传输速率为 10Mb/s
2. **Base**：基带（Baseband），表示使用单一的频率带宽来传输数据信号而没有使用频分复用技术
3. **Base 后面的数字**：5 或 2 代表电缆最长为 500m 或 200m（实际只有 185m）
4. **Base 后面的字母**：T 代表双绞线（Twisted pair），F 代表光纤（optical Fiber）

| 标准编号    | 10Base5 | 10Base2  | 10Base-T | 10Base-F |
| ------- | ------- | -------- | -------- | -------- |
| 传输介质    | 同轴电缆（粗缆）| 同轴电缆（细缆）| 双绞线     | 光纤       |
| 每段最大长度  | 500m    | 185m     | 100m     | 2000m    |
| 每段最大节点数 | 100     | 30       | 1024     | 1024     |
| 物理拓扑    | 总线形     | 总线形      | 星形       | 点对点      |

### 高速以太网

![](./images/Pasted%20image%2020241022095453.png)

#### 100BASE-T 以太网

- **定义**：以 100 Mb/s 速率在**双绞线**上传输基带信号的星形拓扑以太网。
- **协议**：遵循 IEEE 802.3 的 CSMA/CD 协议。
- **工作模式**：支持全双工和半双工模式：
  - **全双工模式**：无冲突，不使用 CSMA/CD。
- **帧格式**：采用 IEEE 802.3 标准 MAC 帧格式。
- **最短帧长**：64 字节，最大电缆长度缩短至 100m，帧间时间为 0.96 微秒。

#### 吉比特以太网（千兆以太网）

- **速率**：支持 1000 Mb/s（1 Gb/s）传输速率。
- **协议**：使用 IEEE 802.3 帧格式，与 10 Mbps 和 100 Mbps 以太网兼容。
- **工作模式**：
  - **半双工模式**：使用 CSMA/CD，并增加**载波延伸**和**分组突发**：
    - **载波延伸**：保持最短 MAC 帧长度，争用期提高至 512 字节。
    - **分组突发**：第一帧使用载波延伸，后续帧在 **96 比特时间**间隔后直接发送。
  - **全双工模式**：不使用 CSMA/CD。
- **应用**：适用于干线网和高速交换机连接，向后兼容 10BASE-T 和 100BASE-T。

#### 10 吉比特以太网

- **速率**：提供 10 Gb/s 的数据传输能力。
- **工作模式**：采用**全双工模式**，支持双向同时传输数据。
- **协议**：取消了 CSMA/CD 协议，提升网络性能。
- **应用**：用于骨干网连接，满足大型网络的高速传输需求。
- **传输介质**：主要使用多模光纤或单模光纤，少量情况下可使用短距离铜缆。

#### 小结

| **名称**       | **100BASE-T 以太网** | **吉比特以太网**           | **10 吉比特以太网** |
| -------------- | -------------------- | -------------------------- | ------------------ |
| **传输速率**   | 100 Mb/s             | 1 Gb/s                     | 10 Gb/s            |
| **传输介质**   | 双绞线               | 双绞线或光纤               | 光纤               |
| **通信模式**   | 支持全双工和半双工    | 支持全双工和半双工         | 仅全双工模式       |
| **访问控制协议** | 半双工模式下使用 CSMA/CD | 全双工模式无需 CSMA/CD | 不使用 CSMA/CD     |

### 虚拟局域网 VLAN

- **定义**：VLAN（Virtual Local Area Network，虚拟局域网）允许在同一个局域网内通过逻辑划分，创建多个广播域
  - 这意味着即使用户处于不同地理位置，也能够通过同一 VLAN 形成虚拟工作组
- **通信**：VLAN 成员即使连接到不同的交换机端口，也能够互相通信
  - VLAN 技术还能防止不同 VLAN 间的广播传播，有效减少广播风暴的影响
- **实现方式**：通过交换机配置实现 VLAN,交换式以太网中的所有站点都属于同一个广播域。

#### 传统局域网的局限性

1. **流量隔离缺失**：缺乏有效的流量隔离机制，所有设备共享同一广播域，可能导致数据泄露或不必要的数据流量
2. **用户管理不便**：用户管理困难，尤其是在需要迁移用户时，配置变更复杂且易出错
3. **成本问题**：依赖于路由器进行网络分割，增加了网络建设和维护的成本

#### VLAN 的实现

![](./images/Pasted%20image%2020241022094921.png)
![](./images/Pasted%20image%2020241022095051.png)
![](./images/Pasted%20image%2020241022095111.png)

#### VLAN 的优势

1. **减少广播风暴**：通过限制广播域的大小，VLAN 减少了广播风暴的可能性，提高了网络的稳定性和性能
2. **提高安全性**：限制广播域可以减少潜在的安全风险，防止数据泄露
3. **广播域控制**：随着网络规模的扩大，广播域的增大可能导致广播风暴，增加网络管理和维护的难度，以及潜在的安全风险
4. **逻辑划分**：VLAN 允许将大型局域网逻辑上划分为多个小的、地理位置无关的 VLAN，每个 VLAN 构成一个独立的小广播域，提高了网络的灵活性和管理效率
5. **流量隔离**：VLAN 通过逻辑上划分网络，实现了流量隔离，提高了网络的安全性
6. **管理便利性**：VLAN 支持不便迁移的用户管理，提高了网络的灵活性和管理效率
7. **成本效益**：相比使用路由器进行网络划分，VLAN 通过交换机实现网络划分，能显著降低成本
8. **支持多租户环境**：VLAN 更好地支持多租户环境，提高了网络资源的利用率

> **注意**：在 VLAN 内，通信不需要路由器，但 VLAN 之间的通信则需要通过路由器或三层交换机进行

#### VLAN 的划分（配置）方式

1. **基于端口**
   - **特点**：根据交换机的端口来划分 VLAN，每个端口被分配到特定的 VLAN 中
   - **优点**：实现简单，易于管理
   - **缺点**：灵活性较低，改变 VLAN 配置需要手动重新分配端口

2. **基于 MAC 地址**
   - **特点**：根据设备的 MAC 地址来划分 VLAN，交换机根据 MAC 地址将数据帧分配到对应的 VLAN
   - **优点**：灵活性高，即使主机物理位置变动（从一个交换机移动到另一个交换机），仍然保持在原来的 VLAN 中
   - **缺点**：需要交换机具备高级的 MAC 地址识别能力，配置相对复杂

3. **基于 IP 地址**
   - **特点**：根据网络层的地址或协议类型（如 IP、IPX、AppleTalk）来划分 VLAN
   - **优点**：可以跨越路由器进行扩展，连接多个局域网的主机，适用于大型网络环境

#### 支持 VLAN 的以太网帧格式

- **VLAN ID**：每个 VLAN 都有一个唯一的标识符（VLAN ID），范围是 0~4095。其中 0 和 4095 保留，用户 VLAN ID 范围是 1~4094
- **标准**：VLAN ID 在 IEEE 802.1Q 标准中定义，用于区分不同 VLAN 的数据帧

**802.3ac 标准**定义了支持 VLAN 的以太网帧格式。在以太网帧中插入一个 VLAN 标签，用以标识发送该帧的主机属于哪个虚拟局域网。插入 VLAN 标签的帧称为 802.1Q 帧

#### VLAN 标签（4 字节，共 28 比特）

![](./images/Pasted%20image%2020241022093030.png)

- **标签协议标识符 TPID**（Tag Protocol Identifier）：前 2 字节，固定值 0x8100，表示帧包含 802.1Q 标签
- **TCI**（Tag Control Information）：后 2 字节，包含以下字段：
  - **优先级 PRI**：长度为 3 比特，取值范围是 0~7，值越大优先级越高。当网络阻塞时，设备优先发送优先级高的 802.1Q 帧。
  - **规范格式指示符 CFI**：1 位，丢弃合格指示，用于拥塞管理
  - **VID**：12 位，VLAN 标识符，标识帧属于哪个 VLAN，取值范围 0-4095，但是其中 0 和 4095 都不用来表示 VLAN

> [! ] 加入 VLAN 标签后，以太网 MAC 帧的最大帧长从原来的 1518 字节变为 1522 字节。但是最小帧长不变。广播帧只在同一 VLAN 内转发，这样就将广播域限制在了一个 VLAN 内。

#### 802.1Q 帧处理

> [! ] 802.1Q 帧的处理是由交换机完成的，而非用户主机。

这一过程涉及到对以太网帧的 " 打标签 " 和 " 去标签 " 操作：

- **打标签**：当交换机接收到一个普通的以太网帧时，它会插入一个 4 字节的 VLAN 标记，将其转换为 802.1Q 帧
- **去标签**：在交换机转发 802.1Q 帧时，它可能会移除这 4 字节的 VLAN 标记，将其转换回普通的以太网帧

> [! ] 802.1 Q 帧只在跨交换机的干线链路中使用，在交换机和主机之间使用的是标准以太网帧
>
> - 连接两个交换机端口之间的链路称为汇聚链路或干线链路。

### 无线局域网（WLAN）

- WLAN 是使用无线通信技术连接计算机和网络设备的局域网，主要标准是 IEEE 802.11 系列

#### 主要特点

1. 灵活性和移动性
2. 安装方便，布线成本低
3. 适合经常变动的网络环境
4. 安全性相对较低，需要采用加密技术保护数据传输

![](./images/Pasted%20image%2020240915132946.png)

#### 802.11 无线局域网的 MAC 帧

802.11 帧共有数据帧、控制帧和管理帧三种类型

![](./images/Pasted%20image%2020241022092110.png)
数据帧组成如下：

1. MAC 首部，共 30 字节。帧的复杂性都在 MAC 首部

2. 帧主体，即帧的数据部分，不超过 2312 字节

3. 帧检验序列 FCS，4 字节

![](./images/Pasted%20image%2020240907180149.png)

- **地址 1**：永远是**接收地址**，即**直接接收数据帧的节点地址**
- **地址 2**：永远是**发送地址**，即**实际发送数据帧的节点地址**
- 地址 3 和地址 4 取决于数据帧中 " 来自 AP " 和 " 去往 AP " 两个字段的数值
  - " 来自 AP "：源地址
  - " 去往 AP "：目的地址

![](./images/Pasted%20image%2020240915133040.png)
![](images/Pasted%20image%2020241006162524.png)
![](images/Pasted%20image%2020241006162457.png)
![](./images/Pasted%20image%2020241022091941.png)

#### 常见标准

| 标准  | 频段| 最大速率  | 特点|
|--|--|--|--|
| IEEE 802.11a | 5 GHz| 54 Mbit/s  | 穿透性差，适合开阔环境 |
| IEEE 802.11b | 2.4 GHz | 11 Mbit/s  | 穿透性较好  |
| IEEE 802.11g | 2.4 GHz | 54 Mbit/s  | 兼容 802.11b 设备|
| IEEE 802.11n | 2.4 GHz / 5 GHz | 600 Mbit/s | 引入 MIMO 技术<br/>提高传输速率和覆盖范围|
| IEEE 802.11ac| 5 GHz| >1 Gbit/s  | 适合高密度无线接入场景<br/>速率可达 1 Gbit/s 以上|

#### 安全性

- 常用的加密技术有 WEP、WPA、WPA2 和 WPA3
- 认证方式有开放认证、共享密钥认证、802.1X 认证等

> **注意：** 随着无线局域网的发展，安全性问题日益突出，需要不断改进和加强

## 广域网

### 广域网的基本概念

#### 广域网 (WAN) 概述

- **定义**：广域网（WAN）是覆盖范围很广的长距离网络，是因特网的核心部分，其任务是长距离运送主机所发送的数据
- **连接方式**：广域网连接各节点交换机的链路都是高速链路，可能是长达几千千米的光缆线路，或长达几万千米的点对点卫星链路
- **主要问题**：广域网首要考虑的问题是通信容量必须足够大，以便支持日益增长的通信量

#### 广域网与互联网的区别

- **互联网**：互联网可以连接不同类型的网络，通常使用路由器来连接。局域网（LAN）可以通过广域网与另一个相隔很远的局域网通信
- **广域网**：广域网由一些节点交换机及连接这些交换机的链路组成，是一个单独的网络，用节点交换机连接

| **特性**         | **广域网（WAN）**                                                                                                                                                         | **局域网（LAN）**             | **虚拟局域网（VLAN）**                 |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------ | ------------------------------- |
| **覆盖范围**       | 很大，跨区域                                                                                                                                                               | 较小，在一个局部区域内              | 没有范围限制，可大可小                     |
| **通信方式**       | 使用**点对点**通信                                                                                                                                                          | 使用**广播**通信               | **逻辑上模拟广播域**<br>但支持**单播、组播、广播** |
| **OSI 参考模型层次** | 物理层、数据链路层、网络层                                                                                                                                                        | 物理层、数据链路层                | 由虚拟局域网的实现方式决定                   |
| **联系**         | 1. **广域网和局域网**是互联网的组成部分，二者无包含关系，功能上平等。<br>2. **广域网中的设备**主要使用逻辑地址（IP 地址）通信。<br>3. **局域网设备**依赖物理地址（MAC 地址），但也使用逻辑地址（IP）。<br>4. **VLAN**可以将不同物理位置的设备划为同一逻辑组，实现灵活分组。<br> | 主机依赖**物理地址**（如 MAC 地址）通信 | VLAN 设备**不受物理位置约束**，支持跨交换机的逻辑分组 |
| **着重点**        | 资源共享                                                                                                                                                                 | 数据传输                     | 逻辑分组与隔离                         |

#### 节点交换机与路由器

- **节点交换机**：用于单个网络，功能是将分组存储并转发，使用点到点连接。为了提高网络的可靠性，节点交换机通常与多个节点交换机相连
- **路由器**：用于多个网络之间，功能是转发分组，其工作原理类似于节点交换机

#### 层次上的区别

- **局域网 (LAN)**：主要使用数据链路层的协议
- **广域网 (WAN)**：主要使用网络层的协议

#### 广域网中的重要问题

- **路由选择和分组转发**：
  - **路由选择协议**：负责搜索分组从某个节点到目的节点的最佳传输路由，构造路由表
  - **转发表**：从路由表中构造出转发分组的转发表，分组通过转发表进行转发

#### 常用的广域网数据链路层控制协议

- **PPP 协议** (Point-to-Point Protocol)
- **HDLC 协议** (High-Level Data Link Control)

#### 总结

- **广域网**：覆盖范围广、通信容量大、使用高速链路、由节点交换机组成、主要使用网络层协议
- **节点交换机**：用于单个网络，存储并转发分组，提高可靠性
- **路由器**：用于多个网络之间，转发分组
- **路由选择和分组转发**：是广域网中的核心问题
- **数据链路层控制协议**：PPP 和 HDLC 是最常用的协议

### 🌟🌟🌟 PPP 协议

#### 定义

PPP（Point-to-Point Protocol）是一种数据链路层协议，提供了在**点对点**连接上传输多种网络层协议的标准方法。它提供了帧格式定义、链路建立、维护和终止机制，以及多种可选的功能扩展，如认证、压缩和多链路聚合。PPP 协议是在 SLIP 协议的基础上发展而来的，既可以在异步线路上传输，又可在同步线路上使用

![PPP 协议](./images/Pasted%20image%2020240907180244.png)

#### 实际应用

- 用户使用拨号电话线接入互联网时，用户计算机和 ISP（Internet Server Provider，因特网服务提供商）进行通信时所使用的数据链路层协议就是 PPP 协议
- 广泛用于广域网路由器之间的专用线路

#### 组成

![PPP 组成](./images/Pasted%20image%2020240915133546.png)

- **IP 数据报封装**：将 IP 数据报封装到串行链路的方法
- **链路控制协议 LCP (Link Control Protocol)**：用来建立、配置和测试数据链路连接。通信的双方可以协商一些选项
- **网络控制协议 NCP (Network Control Protocol)**：可支持 IP 和 OSI 的网络层、DECnet 以及 AppleTalk 等

#### 帧格式

![](./images/Pasted%20image%2020241021231759.png)

- **标志字段 F**：
  - 0x7E（字节），01111110（比特），前后各占 1 字节，标志帧开始和结束

- **地址字段 A**：规定为 FF，保留

- **控制字段 C**：规定为 03，保留

- **协议字段**：说明信息段中运载的分组的种类
  - 以比特 0 开始的是诸如 IP、IPX、AppleTalk 这样的网络层协议
    - 若值为 0x0021，则信息字段就是 IP 数据报
  - 以比特 1 开始：被用来协商的其他协议，包括 LCP 及每个支持的网络层协议的一个不同的 NCP
   ![](./images/Pasted%20image%2020241021231937.png)
    - 若为 0x8021，则信息字段是网络控制 NCP 数据
    - 若为 0xC021，则信息字段是 PPP 链路控制 LCP 数据
    - 若为 0xC023，则信息字段是鉴别数据

- **信息部分**：
  - 长度可变，$0 \sim 1500B$，当信息段中出现和标志字段一样的比特组合时，必须采用一些措施来改进
  - 注意：**因为 PPP 是点对点，不使用 CSMA/CD 协议，所以没有最短帧**

- **帧检验序列 FCS**：循环冗余码检验中的冗余码，检验区包括地址字段、控制字段、协议字段和信息字段

#### 透明传输问题

![](./images/Pasted%20image%2020241021232131.png)

> 面向比特的链路 【比特填充】

![](./images/Pasted%20image%2020241021232046.png)

> 面向字节的链路 【字符填充法】

![](./images/Pasted%20image%2020241021231908.png)

- `7D 5E` = `7E`
- `7D 5D` = `7D`
- `7D 23` = `03`

#### 差错检错

![](./images/Pasted%20image%2020241021232158.png)

#### 协议状态

![](./images/Pasted%20image%2020240907180328.png)

PPP 协议的流程涵盖了物理层、数据链路层和网络层的内容，体现了从无链路到数据通信的完整过程

1. *链路静止状态*：线路处于静止状态时，不存在物理层连接

2. *物理连接建立*：当线路检测到载波信号时，建立物理连接，进入链路建立状态

3. *LCP 链路建立*
   - **过程**：
     - LCP 开始协商配置选项，发送 LCP 的配置请求帧
     - 等待链路另一端的响应（配置确认帧、配置否认帧、配置拒绝帧）
   - **结果**：
     - 协商成功：双方建立 LCP 链路，进入鉴别状态
     - 协商失败：退回链路静止状态

4. *鉴别状态*
   - **允许传送的分组**：LCP 协议分组、鉴别协议的分组、检测链路质量的分组
   - **结果**：
     - 无须鉴别或鉴别成功：进入网络层协议状态
     - 鉴别失败：进入链路终止状态

5. *网络层协议状态*
   - **过程**：PPP 链路的两端的 NCP 根据不同网络层协议交换网络层特定的网络控制分组
   - **特点**：支持多种网络层协议，使得 PPP 协议两端可以运行不同的网络层协议，但仍然可以使用同一个 PPP 协议进行通信

6. *LCP 配置协商*

   - **过程**：通过链路控制协议 (LCP) 开始协商配置选项，包括发送配置请求帧并等待响应（确认、否认或拒绝帧）
   - **结果**：
     - 如果协商成功，双方建立 LCP 链路，进入鉴别状态
     - 如果失败，则退回到链路静止状态

7. *鉴别状态*

   - **限制**：在此状态下，只允许传送 LCP 协议分组、鉴别协议分组及检测链路质量的分组
   - **结果**：
     - 如果双方无需鉴别或鉴别成功，将进入网络层协议状态
     - 鉴别失败则导致链路终止

8. *在网络层协议状态*
   - PPP 链路的两端的网络控制协议 NCP 根据网络层的不同协议互相交换网络层特定的网络控制分组
   - 路由器都能够同时支持多种的网络层协议，但这个步骤使得 PPP 协议两端的网络层可以运行不同的网络层协议，但仍然可以使用同一个 PPP 协议进行通信

9. *链路打开状态*
   - 当网络层配置完毕后，链路就进入可进行数据通信的链路打开状态
   - 链路的两个 PPP 端点可以彼此向对方发送分组
   - 两个 PPP 端点还可发送回送请求 LCP 分组 (Echo-Request) 和回送回答 LCP 分组 (Echo-Reply)，以检查链路的状态

10. *终止状态*
    - 当数据传输完成后，线路转为终止状态，载波停止后则回到链路静止状态

从设备之间无链路开始，到先建立物理链路，再建立 LCP 链路。经过鉴别后再建立 NCP 链路，然后才能交换数据

#### 特点

- PPP 提供差错检测但不提供纠错功能，只保证无差错接收（CRC 校验）。
- PPP 是不可靠的传输协议，不使用序号和确认机制。
- PPP 仅支持全双工的点对点链路通信，不支持多点线路。
- PPP 两端可以运行不同的网络层协议，但仍然使用同一个 PPP 协议进行通信。
- PPP 是面向字节的协议，所有帧的长度均为整数个字节。
- 异步链路使用字符填充（插入转义字符），同步链路使用比特填充（零比特填充）
- PPP 和 HDLC 均为数据链路层协议，但 HDLC 是面向比特的，PPP 是面向字节的。

## 局域网和广域网小结

|                | 广域网                                                                                  | 局域网          |
| -------------- | ------------------------------------------------------------------------------------ | ------------ |
| **覆盖范围**       | 很广，通常跨区域                                                                             | 较小，通常在一个区域内  |
| **连接方式**       | 节点之间都是点到点连接，但为了提高网络的可靠性，一个节点交换机往往与多个节点交换机相连                                          | 普遍采用多点接入技术   |
| **OSI 参考模型层次** | 三层：物理层、数据链路层、网络层                                                                     | 两层：物理层、数据链路层 |
| **联系与相似点**     | 1. 广域网和局域网都是互联网的重要组成构建，从互联网的角度来看，二者平等<br>2. 连接到一个广域网和一个局域网上的主机在该网内进行通信，只需要使用其网络的物理地址 |              |
| **着重点**        | 强调资源共享，通信手段主要使用分组交换技术                                                                | 强调数据传输       |

- 以太网：802.3 局域网称为以太网
- 10 BASE-T 的传输媒体为双绞线
